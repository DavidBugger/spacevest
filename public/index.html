<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceVest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E5E7EB;
            transition: background-color 0.3s, color 0.3s;
        }
        .auth-container, .modal-content, .profile-section, .settings-list > div, .admin-section {
            background-color: #1F2937;
        }
        .form-input {
            background-color: #374151;
            border: 1px solid #4B5563;
        }
        .submit-btn, .verify-btn {
            background: linear-gradient(105deg, #FFD700, #FBBF24, #F59E0B);
            color: #1F2937;
        }
        .submit-btn:disabled, .verify-btn:disabled {
            background: #4B5563;
            color: #9CA3AF;
            cursor: not-allowed;
        }
        .wallet-card {
            background: linear-gradient(105deg, #FFD700, #FBBF24, #F59E0B);
            position: relative;
            overflow: hidden;
        }
        .wallet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 400'%3E%3Cpath fill='rgba(255, 255, 255, 0.05)' d='M 0 100 C 200 150 400 50 600 100 S 800 150 800 100 V 400 H 0 Z'/%3E%3Cpath fill='rgba(255, 255, 255, 0.08)' d='M 0 200 C 150 280 350 120 550 200 S 800 120 800 200 V 400 H 0 Z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0.5;
        }
        .action-item, .settings-item {
            background-color: #1F2937;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .action-item:hover, .settings-item:hover {
            background-color: #374151;
        }
        .bottom-nav {
            background-color: #1F2937;
            transition: background-color 0.3s;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Light Mode */
        body.light-mode { background-color: #F3F4F6; color: #1F2937; }
        .light-mode .auth-container, .light-mode .modal-content, .light-mode .profile-section, .light-mode .settings-list > div, .light-mode .action-item, .light-mode .settings-item, .light-mode .bottom-nav, .light-mode .admin-section { background-color: #FFFFFF; border: 1px solid #E5E7EB; }
        .light-mode .form-input { background-color: #F3F4F6; border-color: #D1D5DB; }
        .light-mode #username-home, .light-mode #username-profile, .light-mode h2, .light-mode h3, .light-mode h4, .light-mode .font-bold { color: #111827; }
        .light-mode .text-gray-400 { color: #6B7280; }
        .light-mode .text-gray-300 { color: #4B5563; }
        .light-mode .text-gray-500 { color: #9CA3AF; }
        .light-mode .border-gray-600 { border-color: #E5E7EB; }
        .light-mode .border-gray-700 { border-color: #D1D5DB; }
        
        /* Chat bubble styles */
        .chat-bubble { max-width: 75%; }
        .chat-bubble.sent { background-color: #FBBF24; color: #1F2937; }
        .chat-bubble.received { background-color: #374151; }
        .light-mode .chat-bubble.received { background-color: #E5E7EB; }
        
        /* Tab styles */
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #FBBF24; color: #FBBF24; }
        .light-mode .tab-btn.active { color: #F59E0B; border-bottom-color: #F59E0B; }

        /* Marquee Styles */
        .marquee-container {
            white-space: nowrap;
        }
        .marquee-content {
            animation: marquee 60s linear infinite; /* Increased duration for more content */
            display: inline-block;
        }
        .marquee-item {
            display: inline-flex;
            align-items: center;
            margin-right: 2.5rem; /* 40px */
        }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); } /* Animate to -50% because content is duplicated */
        }
        .marquee-container:hover .marquee-content {
            animation-play-state: paused;
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
            border: 1px solid #1F2937;
        }
    </style>
</head>
<body class="max-w-md mx-auto">

    <div id="app-loader" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <i class="fas fa-spinner fa-spin text-white text-4xl"></i>
    </div>
    
    <div id="auth-error" class="fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50"></div>

    <div id="page-welcome" class="min-h-screen flex flex-col justify-center items-center p-4 text-center">
        <div class="auth-container p-8 rounded-2xl">
            <div class="flex items-center justify-center gap-3 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                <h1 class="text-4xl font-bold">SpaceVest</h1>
            </div>
            <p class="text-gray-400 mb-8">Your secure and simple gateway to digital finance. Trade, transfer, and manage your assets with ease.</p>
            <div class="space-y-4">
                <button id="goto-signin-from-welcome" class="submit-btn w-full p-3 rounded-lg font-bold">Sign In</button>
                <button id="goto-signup-from-welcome" class="w-full p-3 rounded-lg font-bold bg-gray-600 hover:bg-gray-700">Create Account</button>
            </div>
        </div>
    </div>

    <div id="page-signup" class="min-h-screen flex flex-col justify-center p-4 hidden">
        <div class="auth-container p-8 rounded-2xl">
            <h2 class="text-3xl font-bold text-center mb-8">Create Account</h2>
            <form id="signup-form">
                <div class="mb-4"><label for="signup-fullname" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label><input type="text" id="signup-fullname" class="form-input w-full p-3 rounded-lg" required></div>
                <div class="mb-4"><label for="signup-username" class="block text-sm font-medium text-gray-300 mb-1">Username</label><input type="text" id="signup-username" class="form-input w-full p-3 rounded-lg" required></div>
                <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label><input type="email" id="signup-email" class="form-input w-full p-3 rounded-lg" required></div>
                <div class="mb-4"><label for="signup-phone" class="block text-sm font-medium text-gray-300 mb-1">Phone Number</label><input type="tel" id="signup-phone" class="form-input w-full p-3 rounded-lg" required></div>
                <div class="mb-4"><label for="signup-country" class="block text-sm font-medium text-gray-300 mb-1">Country</label><input type="text" id="signup-country" class="form-input w-full p-3 rounded-lg" value="Nigeria" required></div>
                <div class="mb-6"><label for="signup-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label><input type="password" id="signup-password" class="form-input w-full p-3 rounded-lg" required></div>
                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold text-lg">Sign Up</button>
            </form>
            <p class="text-center text-gray-400 mt-6">Already have an account? <a href="#" id="goto-signin" class="font-semibold text-yellow-400">Sign In</a></p>
        </div>
    </div>
    
    <div id="page-signin" class="min-h-screen flex flex-col justify-center p-4 hidden">
        <div class="auth-container p-8 rounded-2xl">
            <h2 class="text-3xl font-bold text-center mb-8">Welcome Back!</h2>
            <form id="signin-form">
                <div class="mb-4"><label for="signin-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label><input type="email" id="signin-email" class="form-input w-full p-3 rounded-lg" required></div>
                <div class="mb-6"><label for="signin-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label><input type="password" id="signin-password" class="form-input w-full p-3 rounded-lg" required></div>
                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold text-lg">Sign In</button>
            </form>
            <p class="text-center text-gray-400 mt-6">Don't have an account? <a href="#" id="goto-signup" class="font-semibold text-yellow-400">Sign Up</a></p>
        </div>
    </div>

    <div id="page-verify-email" class="min-h-screen flex flex-col justify-center items-center p-4 text-center hidden">
        <div class="auth-container p-8 rounded-2xl">
            <i class="fas fa-envelope-open-text text-5xl text-yellow-400 mb-6"></i>
            <h2 class="text-2xl font-bold mb-4">Verify Your Email</h2>
            <p class="text-gray-400 mb-6">We've sent a verification link to <strong id="verification-email">your-email@example.com</strong>. Please check your inbox and click the link to continue.</p>
            <button id="resend-verification-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Resend Link</button>
            <p class="text-center text-gray-400 mt-6"><a href="#" id="goto-signin-from-verify" class="font-semibold text-yellow-400">Back to Sign In</a></p>
        </div>
    </div>

    <div id="page-app" class="p-4 min-h-screen hidden" style="padding-bottom: 80px;">
        <header class="flex justify-between items-center py-4"><div class="flex items-center gap-3"><div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-face-meh text-2xl text-gray-700"></i></div><div><p class="text-sm text-gray-400">Welcome back,</p><div class="flex items-center gap-1"><h1 id="username-home" class="font-bold text-lg">...</h1><i class="fas fa-check-circle text-blue-500 text-sm"></i></div></div></div><div class="relative"><button id="logout-btn" class="bg-red-500 text-white px-3 py-1 text-sm rounded-full flex items-center gap-1"><i class="fa-solid fa-right-from-bracket"></i>Logout</button></div></header>
        <section class="wallet-card text-gray-800 rounded-2xl p-6 my-4 shadow-lg"><div class="relative z-10"><div class="flex items-center gap-2 text-sm"><span>Wallet Balance:</span><i id="toggle-balance" class="fa-regular fa-eye-slash cursor-pointer"></i></div><p id="wallet-balance" class="text-4xl font-bold mt-2">₦ ******</p></div></section>
        
        <!-- Marquee Section -->
        <section class="my-4">
            <div class="marquee-container bg-gray-800 rounded-lg p-3 overflow-hidden">
                <div class="marquee-content flex">
                    <!-- Live rates will be injected here by JavaScript -->
                </div>
            </div>
        </section>

        <section id="bank-details-prompt" class="bg-teal-500/20 text-teal-300 p-4 rounded-xl flex items-center gap-4 mb-6 hidden cursor-pointer"><i class="fa-solid fa-building-columns text-2xl"></i><p class="text-sm">Please add your bank details to submit transactions</p></section>
        <section><h2 class="text-lg font-semibold my-6">Actions</h2><div class="grid grid-cols-3 gap-4">
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="add_funds"><div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-plus text-green-400"></i></div><p class="text-sm font-medium">Add Funds</p></div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="withdraw"><div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-arrow-down text-yellow-400"></i></div><p class="text-sm font-medium">Withdraw</p></div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="transfer"><div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-paper-plane text-blue-400"></i></div><p class="text-sm font-medium">Transfer</p></div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="sell_crypto"><div class="w-12 h-12 bg-orange-500/20 rounded-full flex items-center justify-center mb-2"><i class="fa-brands fa-bitcoin text-orange-400"></i></div><p class="text-sm font-medium">Sell Crypto</p></div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="top_up"><div class="w-12 h-12 bg-sky-500/20 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-mobile-screen-button text-sky-400"></i></div><p class="text-sm font-medium">Top-up</p></div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="cable_tv"><div class="w-12 h-12 bg-indigo-500/20 rounded-full flex items-center justify-center mb-2"><i class="fa-solid fa-tv text-indigo-400"></i></div><p class="text-sm font-medium">Cable Tv</p></div>
        </div></section>
    </div>
    
    <div id="page-profile" class="p-4 min-h-screen hidden" style="padding-bottom: 80px;">
        <h2 class="text-2xl font-bold text-center mb-6">Profile</h2>
        <div class="flex items-center gap-4 mb-6"><div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-face-meh text-4xl text-gray-700"></i></div><div><div class="flex items-center gap-2"><h1 id="username-profile" class="font-bold text-xl">...</h1><i class="fas fa-check-circle text-blue-500"></i></div><p id="fullname-profile" class="text-gray-400">...</p></div></div>
        <div id="kyc-banner" class="p-4 rounded-xl flex items-center justify-between mb-8 cursor-pointer bg-gray-800" data-action="kyc_verification"><div class="flex items-center gap-4"><i class="fas fa-address-card text-2xl text-yellow-400"></i><div><p class="font-bold">KYC</p><p id="kyc-subtext" class="text-xs text-gray-400">Please add your BVN details</p></div></div><div id="kyc-status" class="text-red-400 font-semibold text-sm">Not Done</div></div>
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Settings</h3>
        <div class="space-y-2 settings-list">
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="personal_info"><div class="flex items-center gap-4"><i class="fas fa-user-circle text-yellow-400"></i><p>Personal Information</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="kyc_verification"><div class="flex items-center gap-4"><i class="fas fa-check-circle text-yellow-400"></i><p>KYC verification</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="badge"><div class="flex items-center gap-4"><i class="fas fa-medal text-yellow-400"></i><p>Badge</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="security"><div class="flex items-center gap-4"><i class="fas fa-lock text-yellow-400"></i><p>Security</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="bank_accounts"><div class="flex items-center gap-4"><i class="fas fa-university text-yellow-400"></i><p>Bank Accounts</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="account_limits"><div class="flex items-center gap-4"><i class="fas fa-tachometer-alt text-yellow-400"></i><p>Account Limits</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="preferences"><div class="flex items-center gap-4"><i class="fas fa-cookie-bite text-yellow-400"></i><p>Preferences</p></div><i class="fas fa-chevron-right text-gray-500"></i></div>
        </div>
    </div>
    
    <div id="page-admin" class="min-h-screen hidden p-4" style="padding-bottom: 80px;">
        <h2 class="text-2xl font-bold text-center mb-6">Admin Panel</h2>
        <div class="admin-section rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-semibold mb-2">User Management</h3>
            <div id="user-list-admin" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div class="admin-section rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-semibold mb-2">Support Chats</h3>
            <div id="support-chats-admin" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div class="admin-section rounded-2xl p-4">
            <h3 class="text-lg font-semibold mb-2">Manage Rates</h3>
            <div id="rates-list-admin" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
            <h4 class="font-semibold mb-2 pt-2 border-t border-gray-600">Update Rate</h4>
            <form id="rate-form-admin" class="space-y-2 text-sm">
                <div class="mb-2">
                    <label for="rate-crypto-select-admin" class="block text-sm font-medium text-gray-300 mb-1">Cryptocurrency</label>
                    <select id="rate-crypto-select-admin" class="form-input w-full p-2 rounded-lg">
                        <option value="bitcoin">Bitcoin (BTC)</option>
                        <option value="ethereum">Ethereum (ETH)</option>
                        <option value="tether">Tether (USDT)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="rate-ngn-admin" class="block text-sm font-medium text-gray-300 mb-1">New NGN Rate per $</label>
                    <input type="number" step="0.01" id="rate-ngn-admin" placeholder="e.g., 1500" class="form-input w-full p-2 rounded-lg" required>
                </div>
                <button type="submit" class="submit-btn w-full p-2 rounded-lg font-bold">Update Rate</button>
            </form>
        </div>
    </div>

    <div id="page-rates" class="min-h-screen hidden p-4" style="padding-bottom: 80px;">
        <h2 class="text-2xl font-bold text-center mb-6">Live Market Rates</h2>
        <div id="rates-page-container" class="space-y-3"></div>
    </div>

    <div id="page-history" class="p-4 min-h-screen hidden" style="padding-bottom: 80px;">
        <h2 class="text-2xl font-bold text-center mb-6">Transaction History</h2>
        <div id="history-container" class="space-y-3">
            <!-- Transaction items will be injected here -->
        </div>
    </div>

    <nav class="bottom-nav fixed bottom-0 left-0 right-0 max-w-md mx-auto grid grid-cols-5 items-center text-center py-3 border-t border-gray-700 z-40 hidden">
        <a href="#" id="nav-app" class="text-yellow-400"><i class="fa-solid fa-house text-xl"></i><p class="text-xs font-semibold mt-1">Home</p></a>
        <a href="#" id="nav-history" class="text-gray-400"><i class="fa-solid fa-list-ul text-xl"></i><p class="text-xs font-medium mt-1">History</p></a>
        <a href="#" id="nav-rates" class="text-gray-400"><i class="fa-solid fa-chart-line text-xl"></i><p class="text-xs font-medium mt-1">Rates</p></a>
        <a href="#" id="nav-profile" class="text-gray-400"><i class="fa-solid fa-user text-xl"></i><p class="text-xs font-medium mt-1">Profile</p></a>
        <a href="#" id="nav-admin" class="text-gray-400 hidden relative"><i class="fa-solid fa-user-shield text-xl"></i><p class="text-xs font-medium mt-1">Admin</p><div id="admin-notification-badge" class="notification-badge hidden"></div></a>
    </nav>
    
    <button id="chat-btn" class="fixed bottom-24 right-5 bg-yellow-400 text-black w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-40 hidden">
        <i class="fas fa-comment-dots text-2xl"></i>
        <div id="chat-notification-badge" class="notification-badge hidden"></div>
    </button>
    
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
    </div>

    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updatePassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, updateDoc, runTransaction, where, query, getDocs, addDoc, serverTimestamp, orderBy, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3eVorOEoul98enEjTGRsFz5qdIM9b76A",
            authDomain: "afriinvest-robinhood.firebaseapp.com",
            projectId: "afriinvest-robinhood",
            storageBucket: "afriinvest-robinhood.appspot.com",
            messagingSenderId: "407859396325",
            appId: "1:407859396325:web:c3563ef1526f4678341e0c",
            measurementId: "G-PF1641PQ1K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, "us-central1"); // Explicitly set the region

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const loader = document.getElementById('app-loader');
            const pages = { welcome: document.getElementById('page-welcome'), signup: document.getElementById('page-signup'), signin: document.getElementById('page-signin'), app: document.getElementById('page-app'), profile: document.getElementById('page-profile'), admin: document.getElementById('page-admin'), rates: document.getElementById('page-rates'), history: document.getElementById('page-history'), verifyEmail: document.getElementById('page-verify-email') };
            const navLinks = { app: document.getElementById('nav-app'), profile: document.getElementById('nav-profile'), admin: document.getElementById('nav-admin'), rates: document.getElementById('nav-rates'), history: document.getElementById('nav-history') };
            const authErrorEl = document.getElementById('auth-error');
            const usernameHomeEl = document.getElementById('username-home');
            const usernameProfileEl = document.getElementById('username-profile');
            const fullnameProfileEl = document.getElementById('fullname-profile');
            const balanceEl = document.getElementById('wallet-balance');
            const toggleBalanceEl = document.getElementById('toggle-balance');
            const bankPromptEl = document.getElementById('bank-details-prompt');
            const logoutBtn = document.getElementById('logout-btn');
            const modalContainer = document.getElementById('modal-container');
            const bottomNav = document.querySelector('.bottom-nav');
            const chatBtn = document.getElementById('chat-btn');
            
            let appReady = false; // Combined auth and data ready flag
            let balanceVisible = false;
            let userWalletBalance = 0;
            let currentUserData = null;
            let unsubscribeUser, unsubscribeRates, unsubscribeHistory, unsubscribeChats;
            let liveCryptoRates = {};
            let dbRates = {}; // To store rates from firestore
            let verifiedBvnData = null; // To hold verified BVN data temporarily
            let verifiedBankData = null; // To hold verified bank data temporarily
            
            const nigerianBanks = [
                { name: "Access Bank", code: "044" }, { name: "Citibank", code: "023" },
                { name: "Ecobank Nigeria", code: "050" }, { name: "Fidelity Bank", code: "070" },
                { name: "First Bank of Nigeria", code: "011" }, { name: "First City Monument Bank", code: "214" },
                { name: "Globus Bank", code: "00103" }, { name: "Guaranty Trust Bank", code: "058" },
                { name: "Heritage Bank", code: "030" }, { name: "Jaiz Bank", code: "301" },
                { name: "Keystone Bank", code: "082" }, { name: "Kuda Bank", code: "50211" },
                { name: "Opay", code: "999992" }, { name: "Palmpay", code: "999991" },
                { name: "Parallex Bank", code: "526" }, { name: "Polaris Bank", code: "076" },
                { name: "Providus Bank", code: "101" }, { name: "Stanbic IBTC Bank", code: "221" },
                { name: "Standard Chartered Bank", code: "068" }, { name: "Sterling Bank", code: "232" },
                { name: "Suntrust Bank", code: "100" }, { name: "TAJBank", code: "302" },
                { name: "Titan Trust Bank", code: "102" }, { name: "Union Bank of Nigeria", code: "032" },
                { name: "United Bank for Africa", code: "033" }, { name: "Unity Bank", code: "215" },
                { name: "Wema Bank", code: "035" }, { name: "Zenith Bank", code: "057" }
            ];

            // --- Page Navigation ---
            function showPage(pageId) {
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[pageId]) pages[pageId].classList.remove('hidden');
                
                Object.values(navLinks).forEach(link => {
                    link.classList.replace('text-yellow-400', 'text-gray-400');
                    link.querySelector('p').classList.replace('font-semibold', 'font-medium');
                });

                const activeLink = Object.values(navLinks).find(link => link.id === `nav-${pageId}`);
                if (activeLink) {
                    activeLink.classList.replace('text-gray-400', 'text-yellow-400');
                    activeLink.querySelector('p').classList.replace('font-medium', 'font-semibold');
                }

                if (pageId === 'app' || pageId === 'profile' || pageId === 'admin' || pageId === 'rates' || pageId === 'history') {
                    bottomNav.classList.remove('hidden');
                    chatBtn.classList.remove('hidden');
                } else {
                    bottomNav.classList.add('hidden');
                    chatBtn.classList.add('hidden');
                }

                loader.style.display = 'none';
            }

            navLinks.app.addEventListener('click', (e) => { e.preventDefault(); showPage('app'); });
            navLinks.profile.addEventListener('click', (e) => { e.preventDefault(); showPage('profile'); });
            navLinks.admin.addEventListener('click', (e) => { e.preventDefault(); showAdminPage(); });
            navLinks.rates.addEventListener('click', (e) => { e.preventDefault(); showPage('rates'); });
            navLinks.history.addEventListener('click', (e) => { e.preventDefault(); showHistoryPage(); });
            document.getElementById('goto-signin-from-welcome').addEventListener('click', (e) => { e.preventDefault(); showPage('signin'); });
            document.getElementById('goto-signup-from-welcome').addEventListener('click', (e) => { e.preventDefault(); showPage('signup'); });
            document.getElementById('goto-signin').addEventListener('click', (e) => { e.preventDefault(); showPage('signin'); });
            document.getElementById('goto-signup').addEventListener('click', (e) => { e.preventDefault(); showPage('signup'); });
            document.getElementById('kyc-banner').addEventListener('click', () => handleSettingsAction('kyc_verification'));
            document.getElementById('bank-details-prompt').addEventListener('click', () => handleSettingsAction('bank_accounts'));
            document.getElementById('goto-signin-from-verify').addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth);
                showPage('signin');
            });


            // --- Error Handling ---
            function showError(message) {
                authErrorEl.textContent = message;
                authErrorEl.classList.remove('hidden');
                setTimeout(() => { authErrorEl.classList.add('hidden'); }, 3000);
            }

            // --- CSRF Token ---
            function getCSRFToken() {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
                return cookieValue || '';
            }

            // --- Authentication ---
            onAuthStateChanged(auth, async (user) => {
                appReady = false; // Reset ready state on auth change
                if (unsubscribeUser) unsubscribeUser();
                if (unsubscribeRates) unsubscribeRates();
                if (unsubscribeHistory) unsubscribeHistory();
                if (unsubscribeChats) unsubscribeChats();

                if (user) {
                    await user.reload(); // Get the latest user state (including emailVerified)
                    if (user.emailVerified) {
                        fetchUserData(user.uid);
                        listenForChatNotifications(user.uid);
                        showPage('app');
                    } else {
                        document.getElementById('verification-email').textContent = user.email;
                        showPage('verifyEmail');
                    }
                } else {
                    showPage('welcome'); // Show welcome page if not logged in
                    navLinks.admin.classList.add('hidden');
                    loader.style.display = 'none';
                }
            });
            
            logoutBtn.addEventListener('click', () => signOut(auth));
            
            // --- Modal Management ---
            function showModal(content) {
                modalContainer.innerHTML = content;
                modalContainer.classList.remove('hidden');
                const closeBtn = modalContainer.querySelector('.close-modal-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => modalContainer.classList.add('hidden'));
                }
            }

            function showModalAlert(message, type = 'error') {
                const alertEl = modalContainer.querySelector('.modal-alert');
                if (alertEl) {
                    alertEl.textContent = message;
                    alertEl.className = `modal-alert text-sm p-2 rounded-md my-2 ${type === 'error' ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`;
                    alertEl.classList.remove('hidden');
                }
            }

            // --- Firestore Data Fetching & UI Update ---
            function fetchUserData(userId) {
                const userDocRef = doc(db, "users", userId);
                unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                        usernameHomeEl.textContent = currentUserData.username || 'user';
                        usernameProfileEl.textContent = currentUserData.username || 'user';
                        fullnameProfileEl.textContent = currentUserData.fullname || '';
                        userWalletBalance = currentUserData.walletBalance || 0;
                        
                        if (currentUserData.preferences?.theme === 'light') { document.body.classList.add('light-mode'); } 
                        else { document.body.classList.remove('light-mode'); }

                        balanceVisible = currentUserData.securitySettings?.showBalance ?? false;
                        updateBalanceUI();

                        bankPromptEl.classList.toggle('hidden', !!currentUserData.bankDetails);
                        
                        const kycDone = currentUserData.kycVerified === true;
                        const kycStatusEl = document.getElementById('kyc-status');
                        const kycSubtextEl = document.getElementById('kyc-subtext');
                        kycStatusEl.textContent = kycDone ? "Done" : "Not Done";
                        kycSubtextEl.textContent = kycDone ? "Your account is verified." : "Please add your BVN details";
                        kycStatusEl.classList.toggle('text-green-400', kycDone);
                        kycStatusEl.classList.toggle('text-red-400', !kycDone);

                        if (currentUserData.role === 'admin') {
                            navLinks.admin.classList.remove('hidden');
                        } else {
                            navLinks.admin.classList.add('hidden');
                        }
                        appReady = true; // Mark app as fully ready
                    } else {
                        // If user doc doesn't exist, it might be a new signup.
                        appReady = true; 
                    }
                }, (error) => {
                    console.error("Error fetching user data:", error);
                    showError("Could not load user data. Check console for details.");
                });
                
                fetchRates();
            }
            
            function fetchRates() {
                const ratesColRef = collection(db, "rates");
                const ratesPageContainer = document.getElementById('rates-page-container');
                const marqueeContentEl = document.querySelector('.marquee-content');
                const ratesCardsContainer = document.getElementById('rates-container');


                unsubscribeRates = onSnapshot(ratesColRef, (snapshot) => {
                    if (marqueeContentEl) marqueeContentEl.innerHTML = '';
                    ratesPageContainer.innerHTML = '';
                    if (ratesCardsContainer) ratesCardsContainer.innerHTML = '';
                    dbRates = {};

                    if(snapshot.empty) { 
                        const msg = `<p class="text-gray-400">Rates are not available.</p>`;
                        ratesPageContainer.innerHTML = msg;
                        if (ratesCardsContainer) ratesCardsContainer.innerHTML = msg;
                        if (marqueeContentEl) marqueeContentEl.innerHTML = msg;
                        return;
                    }
                    snapshot.docs.forEach(doc => dbRates[doc.id] = doc.data());
                    const rateIds = snapshot.docs.map(doc => doc.id).join(',');
                    if (!rateIds) return; // Prevent empty API call
                    
                    fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${rateIds}&vs_currencies=usd`)
                        .then(res => res.json())
                        .then(prices => {
                            liveCryptoRates = prices;
                            let marqueeHTML = '';
                            snapshot.forEach(doc => {
                                const rateData = doc.data();
                                const livePrice = prices[doc.id]?.usd || 0;
                                // Populate marquee
                                marqueeHTML += `
                                    <div class="marquee-item text-sm">
                                        <i class="${rateData.icon} ${rateData.iconColor} mr-2"></i>
                                        <span class="font-bold text-gray-300">${rateData.name}:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$${livePrice.toLocaleString()}</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</span>
                                    </div>
                                `;
                                // Populate rates page
                                const ratePageItem = `<div class="settings-item flex justify-between items-center p-4 rounded-lg"><div class="flex items-center gap-4"><i class="${rateData.icon} text-2xl ${rateData.iconColor}"></i><div><p class="font-bold">${rateData.name}</p><p class="text-xs text-gray-400">Live Price: $${livePrice.toLocaleString()}</p></div></div><div class="text-right"><p class="font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</p><p class="text-xs text-gray-400">Our Rate</p></div></div>`;
                                ratesPageContainer.innerHTML += ratePageItem;
                            });
                            // Duplicate marquee content for smooth looping effect
                            if (marqueeContentEl) {
                                marqueeContentEl.innerHTML = marqueeHTML + marqueeHTML;
                            }
                        }).catch(err => {
                            console.error("CoinGecko API error:", err)
                            const errorMsg = `<p class="text-red-400">Could not load live rates.</p>`;
                            if (marqueeContentEl) marqueeContentEl.innerHTML = errorMsg;
                        });
                }, (error) => {
                    console.error("Error fetching rates from Firestore:", error);
                    const errorMsg = `<p class="text-red-400">Error loading rates.</p>`;
                    ratesPageContainer.innerHTML = errorMsg;
                    if (marqueeContentEl) marqueeContentEl.innerHTML = errorMsg;
                });
            }

            function updateBalanceUI() {
                if (balanceVisible) {
                    balanceEl.textContent = `₦${Number(userWalletBalance).toLocaleString('en-NG', { minimumFractionDigits: 2 })}`;
                    toggleBalanceEl.className = 'fa-regular fa-eye cursor-pointer';
                } else {
                    balanceEl.textContent = '₦ ******';
                    toggleBalanceEl.className = 'fa-regular fa-eye-slash cursor-pointer';
                }
            }
            
            async function addTransaction(userId, type, status, amount, description) {
                try {
                    const txRef = collection(db, "users", userId, "transactions");
                    await addDoc(txRef, { type, status, amount, description, timestamp: serverTimestamp() });
                } catch (error) {
                    console.error("Failed to add transaction:", error);
                }
            }

            // --- Transaction History Page ---
            function showHistoryPage() {
                showPage('history');
                fetchAndDisplayTransactions();
            }

            function fetchAndDisplayTransactions() {
                if (unsubscribeHistory) unsubscribeHistory(); // Unsubscribe from previous listener
                const userId = auth.currentUser.uid;
                const historyContainer = document.getElementById('history-container');
                const q = query(collection(db, "users", userId, "transactions"), orderBy("timestamp", "desc"));

                unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                    historyContainer.innerHTML = ''; // Clear previous list
                    if (querySnapshot.empty) {
                        historyContainer.innerHTML = `<p class="text-center text-gray-400 mt-8">No transactions yet.</p>`;
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const tx = doc.data();
                        const isDebit = tx.type === 'debit';
                        const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                        const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                        const sign = isDebit ? '-' : '+';
                        const date = tx.timestamp ? tx.timestamp.toDate().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'Just now';

                        const txItemHTML = `
                            <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                                <div class="flex items-center gap-4">
                                    <i class="fas ${iconClass}"></i>
                                    <div>
                                        <p class="font-bold">${tx.description}</p>
                                        <p class="text-xs text-gray-400">${date}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold ${amountClass}">${sign} ₦${tx.amount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                                </div>
                            </div>
                        `;
                        historyContainer.innerHTML += txItemHTML;
                    });
                }, (error) => {
                    console.error("Error fetching transaction history:", error);
                    historyContainer.innerHTML = `<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>`;
                });
            }

            // --- Event Listeners ---
            toggleBalanceEl.addEventListener('click', () => {
                balanceVisible = !balanceVisible;
                updateBalanceUI();
            });

            document.querySelectorAll('.settings-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    handleSettingsAction(action);
                });
            });
            
            document.querySelectorAll('.action-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    handleHomeAction(e.currentTarget.dataset.action);
                });
            });
            
            // --- Home Page Action Modals ---
            function handleHomeAction(action) {
                if (!appReady) {
                    showError("Data not loaded yet. Please wait a moment.");
                    return;
                }
                switch(action) {
                    case 'add_funds': showAddFundsModal(); break;
                    case 'transfer': showTransferModal(); break;
                    case 'sell_crypto': showSellCryptoModal(); break;
                    case 'withdraw': showWithdrawModal(); break;
                    case 'top_up': showTopUpModal(); break;
                    default: 
                        showModal(`<div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Coming Soon</h3><button class="close-modal-btn text-2xl">&times;</button></div><p>${action} feature is under development.</p></div>`);
                }
            }

            function showAddFundsModal() {
                let content;
                if (currentUserData?.virtualAccount) {
                    const { bankName, accountNumber, accountName } = currentUserData.virtualAccount;
                    content = `
                        <p class="text-sm text-center text-gray-400 mb-4">Transfer funds to your personal SpaceVest account below to top up your wallet.</p>
                        <div class="space-y-3 p-4 bg-gray-800 rounded-lg text-left">
                            <div><p class="text-xs text-gray-400">Bank Name</p><p class="font-semibold">${bankName}</p></div>
                            <div><p class="text-xs text-gray-400">Account Number</p>
                                <div class="flex justify-between items-center">
                                    <p class="font-semibold text-lg">${accountNumber}</p>
                                    <button id="copy-account-btn" class="text-yellow-400"><i class="fas fa-copy"></i></button>
                                </div>
                            </div>
                            <div><p class="text-xs text-gray-400">Account Name</p><p class="font-semibold">${accountName}</p></div>
                        </div>
                    `;
                } else {
                    content = `<div id="add-funds-content" class="text-center"><p class="text-gray-400 mb-4">Generate a personal virtual account to add funds to your wallet.</p><button id="generate-va-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Generate Account</button></div>`;
                }

                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Add Funds</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                        <div id="modal-alert" class="hidden"></div>
                        ${content}
                    </div>`;
                showModal(modalHTML);

                const generateBtn = document.getElementById('generate-va-btn');
                if (generateBtn) {
                    generateBtn.addEventListener('click', handleGenerateVirtualAccount);
                }

                const copyBtn = document.getElementById('copy-account-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        const accountNumber = currentUserData.virtualAccount.accountNumber;
                        const textarea = document.createElement('textarea');
                        textarea.value = accountNumber;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                }
            }

            async function handleGenerateVirtualAccount(e) {
                const button = e.target;
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                try {
                    const provisionAccountFunction = httpsCallable(functions, 'provisionNewUserAccount');
                    await provisionAccountFunction();
                    // The onSnapshot listener for user data will automatically update the UI
                    // once the virtual account is created and saved.
                    showModalAlert("Account generated successfully! The modal will refresh.", "success");
                    setTimeout(() => {
                        modalContainer.classList.add('hidden');
                    }, 2500);
                } catch (error) {
                    console.error("Virtual Account Creation Error:", error);
                    showModalAlert(error.message || "Could not generate account. Please try again later.");
                    button.disabled = false;
                    button.innerHTML = 'Generate Account';
                }
            }
            
            function showTransferModal() {
                 const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Transfer Funds</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div class="flex border-b border-gray-700 mb-4">
                            <button id="tab-user" class="tab-btn active flex-1 py-2 font-semibold">SpaceVest User</button>
                            <button id="tab-bank" class="tab-btn flex-1 py-2 font-semibold">Bank Account</button>
                        </div>
                        <div id="modal-alert" class="hidden"></div>
                        
                        <!-- SpaceVest User Tab Content -->
                        <div id="content-user">
                            <form id="transfer-user-form">
                                <div class="mb-4"><label for="transfer-email" class="block text-sm font-medium mb-1">Recipient Email</label><input type="email" id="transfer-email" class="form-input w-full p-3 rounded-lg" required></div>
                                <div class="mb-4"><label for="transfer-user-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="transfer-user-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Send</button>
                            </form>
                        </div>

                        <!-- Bank Account Tab Content -->
                        <div id="content-bank" class="hidden">
                             ${!currentUserData.bankDetails ? `<p class="text-center text-yellow-400">Please add a bank account in your profile first.</p>` : `
                            <form id="transfer-bank-form">
                                <div class="mb-4"><label class="block text-sm font-medium mb-1">Recipient</label>
                                    <div class="p-3 bg-gray-700 rounded-lg">${currentUserData.bankDetails.accountName}<br><small>${currentUserData.bankDetails.bankName} - ${currentUserData.bankDetails.accountNumber}</small></div>
                                </div>
                                <div class="mb-4"><label for="transfer-bank-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="transfer-bank-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Withdraw Funds</button>
                            </form>`}
                        </div>
                    </div>`;
                showModal(modalHTML);
                // Tab switching logic
                const userTab = document.getElementById('tab-user'), bankTab = document.getElementById('tab-bank');
                const userContent = document.getElementById('content-user'), bankContent = document.getElementById('content-bank');
                userTab.addEventListener('click', () => {
                    userTab.classList.add('active'); bankTab.classList.remove('active');
                    userContent.classList.remove('hidden'); bankContent.classList.add('hidden');
                });
                bankTab.addEventListener('click', () => {
                    bankTab.classList.add('active'); userTab.classList.remove('active');
                    bankContent.classList.remove('hidden'); userContent.classList.add('hidden');
                });

                // Form submission logic
                document.getElementById('transfer-user-form')?.addEventListener('submit', handleUserTransfer);
                document.getElementById('transfer-bank-form')?.addEventListener('submit', handleBankTransfer);
            }

            async function handleUserTransfer(e) {
                e.preventDefault();
                const recipientEmail = document.getElementById('transfer-email').value;
                const amount = parseFloat(document.getElementById('transfer-user-amount').value);
                const senderId = auth.currentUser.uid;
                const button = e.target.querySelector('button');
            
                if (recipientEmail === currentUserData.email) return showModalAlert("You cannot transfer to yourself.");
                if (isNaN(amount) || amount <= 0) return showModalAlert("Invalid amount.");
                if (amount > userWalletBalance) return showModalAlert("Insufficient funds.");
            
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", recipientEmail));
                const querySnapshot = await getDocs(q);
            
                if (querySnapshot.empty) {
                    showModalAlert("Recipient not found.");
                    button.disabled = false;
                    button.innerHTML = 'Send';
                    return;
                }
            
                const recipientDoc = querySnapshot.docs[0];
                const recipientId = recipientDoc.id;
                const recipientData = recipientDoc.data();
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const senderDocRef = doc(db, "users", senderId);
                        const recipientDocRef = doc(db, "users", recipientId);
                        
                        const senderDoc = await transaction.get(senderDocRef);
                        if (!senderDoc.exists() || senderDoc.data().walletBalance < amount) {
                            throw "Insufficient balance!";
                        }

                        const newSenderBalance = senderDoc.data().walletBalance - amount;
                        const newRecipientBalance = recipientData.walletBalance + amount;

                        transaction.update(senderDocRef, { walletBalance: newSenderBalance });
                        transaction.update(recipientDocRef, { walletBalance: newRecipientBalance });
                    });

                    await addTransaction(senderId, 'debit', 'completed', amount, `Transfer to ${recipientData.username}`);
                    await addTransaction(recipientId, 'credit', 'completed', amount, `Transfer from ${currentUserData.username}`);
                    
                    showModalAlert(`Successfully transferred ₦${amount.toLocaleString()} to ${recipientData.username}.`, 'success');
                    e.target.reset();
                } catch (error) {
                    console.error("Transfer failed: ", error);
                    showModalAlert("Transaction failed. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Send';
                }
            }
            
            async function handleBankTransfer(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('transfer-bank-amount').value);
                const button = e.target.querySelector('button');
                
                if (isNaN(amount) || amount <= 0) return showModalAlert("Invalid amount.");
                if (amount > userWalletBalance) return showModalAlert("Insufficient funds.");

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                const recipientData = {
                    account_name: currentUserData.bankDetails.accountName,
                    account_number: currentUserData.bankDetails.accountNumber,
                    bank_code: currentUserData.bankDetails.bankCode
                };

                try {
                    const initiateWithdrawalFunction = httpsCallable(functions, 'initiateWithdrawal');
                    const result = await initiateWithdrawalFunction({ amount: amount, recipient: recipientData });

                    if (result.data.status === "success") {
                        showModalAlert(result.data.message, 'success');
                        e.target.reset();
                    } else {
                        showModalAlert(result.data.message || "Withdrawal failed.");
                    }
                } catch (error) {
                    console.error("Withdrawal Error:", error);
                    showModalAlert(error.message || "An error occurred during withdrawal.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Withdraw Funds';
                }
            }

            function showSellCryptoModal() {
                let options = '<option value="">Select Crypto</option>';
                for (const id in dbRates) {
                    options += `<option value="${id}">${dbRates[id].name}</option>`;
                }

                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Sell Crypto</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                        <div id="modal-alert" class="hidden"></div>
                        <div id="sell-crypto-form">
                            <div class="mb-4">
                                <label for="crypto-select" class="block text-sm font-medium mb-1">Cryptocurrency</label>
                                <select id="crypto-select" class="form-input w-full p-3 rounded-lg">${options}</select>
                            </div>
                            <div class="mb-4">
                                <label for="crypto-amount-usd" class="block text-sm font-medium mb-1">Amount to Sell (USD)</label>
                                <input type="number" step="any" id="crypto-amount-usd" class="form-input w-full p-3 rounded-lg" required>
                            </div>
                            <div class="p-4 bg-gray-800 rounded-lg mb-4 text-left">
                                <p class="text-sm text-gray-400">Current Rate (Admin Set)</p>
                                <p id="admin-rate-display" class="text-xl font-bold">₦0.00 / $</p>
                            </div>
                            <button id="sell-now-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Sell Now (via WhatsApp)</button>
                        </div>
                    </div>`;
                showModal(modalHTML);
                
                const cryptoSelect = document.getElementById('crypto-select');
                
                const updateAdminRate = () => {
                    const cryptoId = cryptoSelect.value;
                    const rateDisplay = document.getElementById('admin-rate-display');
                    if (cryptoId && dbRates[cryptoId]) {
                        rateDisplay.textContent = `₦${parseFloat(dbRates[cryptoId].nairaRate).toLocaleString()}/$`;
                    } else {
                        rateDisplay.textContent = 'N/A';
                    }
                };
                
                cryptoSelect.addEventListener('change', updateAdminRate);
                document.getElementById('sell-now-btn').addEventListener('click', handleSellCryptoViaWhatsApp);
                updateAdminRate(); // Initial call
            }

            function handleSellCryptoViaWhatsApp() {
                const cryptoSelect = document.getElementById('crypto-select');
                const cryptoId = cryptoSelect.value;
                const cryptoName = cryptoSelect.options[cryptoSelect.selectedIndex].text;
                const amountUSD = document.getElementById('crypto-amount-usd').value;

                if (!cryptoId) {
                    showModalAlert("Please select a cryptocurrency.");
                    return;
                }
                if (!amountUSD || parseFloat(amountUSD) <= 0) {
                    showModalAlert("Please enter a valid amount to sell.");
                    return;
                }

                const adminRate = dbRates[cryptoId]?.nairaRate || 'N/A';
                const phoneNumber = "2347066718413";
                const message = `Hello, I want to sell ${amountUSD} USD of ${cryptoName} at your rate of ${adminRate} NGN/$.`;
                
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                
                window.open(whatsappUrl, '_blank');
            }
            
            function showWithdrawModal() { 
                if (!currentUserData?.bankDetails) {
                    return showError("Please add a bank account in your profile first.");
                }
                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Withdraw to Bank</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                        <div id="modal-alert" class="hidden"></div>
                        <form id="withdraw-form">
                            <div class="mb-4"><p class="text-sm text-gray-400">Withdrawal Account:</p><div class="p-3 bg-gray-700 rounded-lg">${currentUserData.bankDetails.accountName}<br><small>${currentUserData.bankDetails.bankName} - ${currentUserData.bankDetails.accountNumber}</small></div></div>
                            <div class="mb-4"><label for="withdraw-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="withdraw-amount" class="form-input w-full p-3 rounded-lg" required></div>
                            <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Withdraw Funds</button>
                        </form>
                    </div>`;
                showModal(modalHTML);
                document.getElementById('withdraw-form').addEventListener('submit', handleWithdraw);
            }
            
            async function handleWithdraw(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                const button = e.target.querySelector('button');

                if (isNaN(amount) || amount <= 0) return showModalAlert("Invalid amount.");
                if (amount > userWalletBalance) return showModalAlert("Insufficient funds.");

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Withdrawal...';
                
                const recipientData = {
                    account_name: currentUserData.bankDetails.accountName,
                    account_number: currentUserData.bankDetails.accountNumber,
                    bank_code: currentUserData.bankDetails.bankCode
                };

                try {
                    const initiateWithdrawalFunction = httpsCallable(functions, 'initiateWithdrawal');
                    const result = await initiateWithdrawalFunction({ amount: amount, recipient: recipientData });

                    if (result.data.status === "success") {
                        showModalAlert(result.data.message, 'success');
                        e.target.reset();
                    } else {
                        showModalAlert(result.data.message || "Withdrawal failed.");
                    }
                } catch (error) {
                    console.error("Withdrawal Error:", error);
                    showModalAlert(error.message || "An error occurred during withdrawal.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Withdraw Funds';
                }
            }

            function showTopUpModal() {
                const dataPlans = {
                    mtn: [{name: "1.5GB - 30 Days", price: 1000}, {name: "4.5GB - 30 Days", price: 2000}],
                    glo: [{name: "2.9GB - 30 Days", price: 1000}, {name: "7.7GB - 30 Days", price: 2000}],
                    airtel: [{name: "1.5GB - 30 Days", price: 1000}, {name: "6GB - 30 Days", price: 2500}],
                    '9mobile': [{name: "1GB - 30 Days", price: 1000}, {name: "4.5GB - 30 Days", price: 2000}],
                };

                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Top-up</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                        <div class="flex border-b border-gray-700 mb-4">
                            <button id="tab-airtime" class="tab-btn active flex-1 py-2 font-semibold">Airtime</button>
                            <button id="tab-data" class="tab-btn flex-1 py-2 font-semibold">Data</button>
                        </div>
                        <div id="modal-alert" class="hidden"></div>
                        
                        <!-- Airtime Tab -->
                        <div id="content-airtime">
                            <form id="airtime-form">
                                <div class="mb-4"><label class="block text-sm font-medium mb-1">Network</label><select id="airtime-network" class="form-input w-full p-3 rounded-lg"><option>MTN</option><option>Glo</option><option>Airtel</option><option>9mobile</option></select></div>
                                <div class="mb-4"><label for="airtime-phone" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="airtime-phone" class="form-input w-full p-3 rounded-lg" required></div>
                                <div class="mb-4"><label for="airtime-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="airtime-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Buy Airtime</button>
                            </form>
                        </div>

                        <!-- Data Tab -->
                        <div id="content-data" class="hidden">
                             <form id="data-form">
                                <div class="mb-4"><label class="block text-sm font-medium mb-1">Network</label><select id="data-network" class="form-input w-full p-3 rounded-lg"><option value="mtn">MTN</option><option value="glo">Glo</option><option value="airtel">Airtel</option><option value="9mobile">9mobile</option></select></div>
                                <div class="mb-4"><label for="data-phone" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="data-phone" class="form-input w-full p-3 rounded-lg" required></div>
                                <div class="mb-4"><label class="block text-sm font-medium mb-1">Data Plan</label><select id="data-plan" class="form-input w-full p-3 rounded-lg"></select></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Buy Data</button>
                            </form>
                        </div>
                    </div>`;
                showModal(modalHTML);
                // Tab switching
                const airtimeTab = document.getElementById('tab-airtime'), dataTab = document.getElementById('tab-data');
                const airtimeContent = document.getElementById('content-airtime'), dataContent = document.getElementById('content-data');
                airtimeTab.addEventListener('click', () => { airtimeTab.classList.add('active'); dataTab.classList.remove('active'); airtimeContent.classList.remove('hidden'); dataContent.classList.add('hidden'); });
                dataTab.addEventListener('click', () => { dataTab.classList.add('active'); airtimeTab.classList.remove('active'); dataContent.classList.remove('hidden'); airtimeContent.classList.add('hidden'); });

                // Data plan population
                const dataNetworkSelect = document.getElementById('data-network');
                const dataPlanSelect = document.getElementById('data-plan');
                const populateDataPlans = () => {
                    const selectedNetwork = dataNetworkSelect.value;
                    dataPlanSelect.innerHTML = dataPlans[selectedNetwork].map(p => `<option value="${p.price}">${p.name} - ₦${p.price.toLocaleString()}</option>`).join('');
                };
                dataNetworkSelect.addEventListener('change', populateDataPlans);
                populateDataPlans();

                // Form submissions
                document.getElementById('airtime-form').addEventListener('submit', handleAirtimePurchase);
                document.getElementById('data-form').addEventListener('submit', handleDataPurchase);
            }

            async function handleAirtimePurchase(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('airtime-amount').value);
                const phone = document.getElementById('airtime-phone').value;
                const network = document.getElementById('airtime-network').value;
                const button = e.target.querySelector('button');
                
                if (isNaN(amount) || amount < 50) return showModalAlert("Minimum airtime is ₦50.");
                if (amount > userWalletBalance) return showModalAlert("Insufficient funds.");
                if (!/^\d{11}$/.test(phone)) return showModalAlert("Invalid phone number (must be 11 digits).");

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Purchasing...';

                try {
                    const userDocRef = doc(db, "users", auth.currentUser.uid);
                    await updateDoc(userDocRef, { walletBalance: increment(-amount) });
                    await addTransaction(auth.currentUser.uid, 'debit', 'completed', amount, `${network} airtime purchase for ${phone}`);
                    showModalAlert(`Successfully purchased ₦${amount.toLocaleString()} airtime for ${phone}.`, 'success');
                    e.target.reset();
                } catch(error) {
                    showModalAlert("Purchase failed. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Buy Airtime';
                }
            }
            
            async function handleDataPurchase(e) {
                e.preventDefault();
                const price = parseFloat(document.getElementById('data-plan').value);
                const planText = document.getElementById('data-plan').options[document.getElementById('data-plan').selectedIndex].text;
                const phone = document.getElementById('data-phone').value;
                const button = e.target.querySelector('button');
                
                if (price > userWalletBalance) return showModalAlert("Insufficient funds.");
                if (!/^\d{11}$/.test(phone)) return showModalAlert("Invalid phone number (must be 11 digits).");

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Purchasing...';

                 try {
                    const userDocRef = doc(db, "users", auth.currentUser.uid);
                    await updateDoc(userDocRef, { walletBalance: increment(-price) });
                    await addTransaction(auth.currentUser.uid, 'debit', 'completed', price, `${planText} for ${phone}`);
                    showModalAlert(`Successfully purchased ${planText} for ${phone}.`, 'success');
                    e.target.reset();
                } catch(error) {
                    showModalAlert("Purchase failed. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Buy Data';
                }
            }


            // --- Settings Modals Logic ---
            function handleSettingsAction(action) {
                if (!appReady) {
                    showError("Data not loaded yet. Please wait a moment.");
                    return;
                }
                let modalHTML = '';
                switch(action) {
                    case 'personal_info':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Personal Information</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="space-y-3 text-left">
                                    <div><p class="text-sm text-gray-400">Username</p><p>${currentUserData.username}</p></div>
                                    <div><p class="text-sm text-gray-400">Email</p><p>${currentUserData.email}</p></div>
                                    <div><p class="text-sm text-gray-400">Phone</p><p>${currentUserData.phone}</p></div>
                                    <div><p class="text-sm text-gray-400">Country</p><p>${currentUserData.country}</p></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'kyc_verification':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">KYC Verification</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                ${currentUserData.kycVerified ? `<div class="text-center text-green-400"><i class="fas fa-check-circle text-4xl mb-2"></i><p>Your account is verified.</p><div class="text-left text-sm mt-4 p-3 bg-gray-800 rounded-lg space-y-1"><p><strong>Name:</strong> ${currentUserData.kycDetails.first_name} ${currentUserData.kycDetails.last_name}</p><p><strong>DOB:</strong> ${currentUserData.kycDetails.dob}</p></div></div>` : `
                                <form id="kyc-form">
                                    <div class="mb-4"><label for="bvn-input" class="block text-sm font-medium text-gray-300 mb-1">Bank Verification Number (BVN)</label><input type="number" id="bvn-input" class="form-input w-full p-3 rounded-lg" required></div>
                                    <button type="submit" id="verify-bvn-btn" class="verify-btn w-full p-3 rounded-lg font-bold">Verify BVN</button>
                                </form>
                                <div id="kyc-verification-result" class="mt-4 text-left hidden">
                                    <p class="text-green-400 font-semibold mb-2">BVN Details Found:</p><div id="bvn-details-display" class="text-sm space-y-1 p-3 bg-gray-800 rounded-lg"></div>
                                    <button id="save-kyc-btn" class="submit-btn w-full p-3 mt-4 rounded-lg font-bold">Confirm & Save KYC</button>
                                </div>`}
                            </div>`;
                        showModal(modalHTML);
                        if (!currentUserData.kycVerified) {
                            document.getElementById('kyc-form').addEventListener('submit', verifyBvn);
                        }
                        break;
                    case 'badge':
                        const points = currentUserData.points || 0;
                        const level = Math.floor(points / 100);
                        const levelName = ["Rookie", "Trader", "Pro", "Veteran", "Legend"][level] || "Legend";
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl text-center">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Badge & Level</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <i class="fas fa-medal text-6xl text-yellow-400 mb-2"></i>
                                <h4 class="text-2xl font-bold">${levelName}</h4>
                                <p class="text-gray-400">Points: ${points}</p>
                                <p class="text-xs text-gray-500 mt-4">Earn 20 points for every crypto trade to level up!</p>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'security':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Security</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                <div class="space-y-4">
                                    <form id="change-password-form" class="space-y-2"><label for="change-password-input" class="block text-sm font-medium text-gray-300">New Password</label><input type="password" id="change-password-input" class="form-input w-full p-3 rounded-lg" required><button type="submit" class="verify-btn w-full p-2 mt-1 rounded-lg font-bold text-sm">Change Password</button></form>
                                    <div class="flex justify-between items-center"><p>Login with Face/Fingerprint</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="face-id-toggle" class="sr-only peer" ${currentUserData.securitySettings?.biometricsEnabled ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                    <div class="flex justify-between items-center"><p>Show Balance on Home</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="show-balance-toggle" class="sr-only peer" ${currentUserData.securitySettings?.showBalance ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                    <div class="flex justify-between items-center"><p>2FA Authentication</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="2fa-toggle" class="sr-only peer" ${currentUserData.securitySettings?.twoFactorEnabled ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        document.getElementById('change-password-form').addEventListener('submit', changeUserPassword);
                        document.getElementById('show-balance-toggle').addEventListener('change', (e) => updateSecuritySettings({ showBalance: e.target.checked }));
                        document.getElementById('face-id-toggle').addEventListener('change', (e) => updateSecuritySettings({ biometricsEnabled: e.target.checked }));
                        document.getElementById('2fa-toggle').addEventListener('change', (e) => updateSecuritySettings({ twoFactorEnabled: e.target.checked }));
                        break;
                    case 'bank_accounts':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Bank Accounts</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                <div id="bank-details-display-modal" class="mb-4"></div>
                                <h4 class="text-lg font-semibold mb-2 border-t border-gray-600 pt-4">${currentUserData.bankDetails ? 'Update' : 'Add New'} Bank</h4>
                                <form id="bank-form-modal">
                                    <div class="mb-4"><label for="bank-list-modal" class="block text-sm font-medium text-gray-300 mb-1">Bank Name</label><select id="bank-list-modal" class="form-input w-full p-3 rounded-lg"></select></div>
                                    <div class="mb-4"><label for="account-number-modal" class="block text-sm font-medium text-gray-300 mb-1">Account Number</label><input type="number" id="account-number-modal" class="form-input w-full p-3 rounded-lg" required></div>
                                    <button type="submit" id="verify-account-btn-modal" class="verify-btn w-full p-3 rounded-lg font-bold">Verify Account</button>
                                </form>
                                <div id="verification-result-modal" class="mt-4 text-center hidden">
                                    <p id="account-name-modal" class="font-semibold text-lg text-green-400"></p>
                                    <button id="save-bank-btn-modal" class="submit-btn w-full p-3 mt-2 rounded-lg font-bold">Save Bank</button>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        populateBankList(document.getElementById('bank-list-modal'));
                        updateBankDetailsDisplay(currentUserData.bankDetails, document.getElementById('bank-details-display-modal'));
                        document.getElementById('bank-form-modal').addEventListener('submit', verifyBankAccount);
                        break;
                    case 'account_limits':
                        const tier = currentUserData.kycVerified ? 2 : 1;
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Account Limits</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="space-y-4">
                                    <div class="p-4 rounded-lg ${tier === 1 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 1 (Default)</h4><p class="text-sm">Limit: ₦50,000 per transaction</p></div>
                                    <div class="p-4 rounded-lg ${tier === 2 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 2 (BVN Verified)</h4><p class="text-sm">Limit: ₦200,000 per transaction</p></div>
                                    <div class="p-4 rounded-lg ${tier === 3 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 3 (Address Verified)</h4><p class="text-sm">Limit: ₦1,000,000 per transaction</p></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'preferences':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Preferences</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="flex justify-between items-center"><p>Theme</p><div class="flex items-center gap-2"><i class="fas fa-sun"></i><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="theme-toggle" class="sr-only peer" ${document.body.classList.contains('light-mode') ? '' : 'checked'}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label><i class="fas fa-moon"></i></div></div>
                            </div>`;
                        showModal(modalHTML);
                        document.getElementById('theme-toggle').addEventListener('change', toggleTheme);
                        break;
                }
            }
            
            async function verifyBvn(e) {
                e.preventDefault();
                const bvn = document.getElementById('bvn-input').value;
                const button = document.getElementById('verify-bvn-btn');
                
                if (!/^\d{11}$/.test(bvn)) {
                    return showModalAlert("Please enter a valid 11-digit BVN.");
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

                try {
                    const verifyBvnFunction = httpsCallable(functions, 'verifyBvn');
                    const result = await verifyBvnFunction({ bvn: bvn });

                    if (result.data.status) {
                        verifiedBvnData = result.data.data; // The actual data is in result.data.data
                        document.getElementById('kyc-form').classList.add('hidden');
                        const detailsEl = document.getElementById('bvn-details-display');
                        detailsEl.innerHTML = `
                            <p><strong>First Name:</strong> ${verifiedBvnData.first_name}</p>
                            <p><strong>Last Name:</strong> ${verifiedBvnData.last_name}</p>
                            <p><strong>Date of Birth:</strong> ${verifiedBvnData.dob}</p>
                        `;
                        document.getElementById('kyc-verification-result').classList.remove('hidden');
                        document.getElementById('save-kyc-btn').addEventListener('click', saveKycData);
                    } else {
                        showModalAlert(result.data.message || "BVN could not be verified.");
                    }
                } catch (error) {
                    console.error("BVN Verification Error:", error);
                    showModalAlert(error.message || "An error occurred. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Verify BVN';
                }
            }

            async function saveKycData() {
                if (!verifiedBvnData) return;
                const button = document.getElementById('save-kyc-btn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const userDocRef = doc(db, "users", auth.currentUser.uid);
                    await updateDoc(userDocRef, {
                        kycVerified: true,
                        kycDetails: verifiedBvnData
                    });
                    showModalAlert("KYC details saved successfully!", "success");
                    setTimeout(() => modalContainer.classList.add('hidden'), 2000);
                } catch (error) {
                    console.error("Error saving KYC data:", error);
                    showModalAlert("Could not save KYC data. Please try again.");
                    button.disabled = false;
                    button.innerHTML = 'Confirm & Save KYC';
                }
            }

            function populateBankList(selectElement) {
                selectElement.innerHTML = '<option value="">Select a bank</option>' + nigerianBanks.map(bank => `<option value="${bank.code}">${bank.name}</option>`).join('');
            }

            function updateBankDetailsDisplay(details, element) {
                if (details) {
                    element.innerHTML = `<div class="p-3 bg-gray-700 rounded-lg"><p class="font-bold">${details.accountName}</p><p class="text-sm">${details.bankName} - ${details.accountNumber}</p></div>`;
                } else {
                    element.innerHTML = `<p class="text-sm text-center text-gray-400">No bank account added.</p>`;
                }
            }

            async function verifyBankAccount(e) {
                e.preventDefault();
                const accountNumber = document.getElementById('account-number-modal').value;
                const bankCode = document.getElementById('bank-list-modal').value;
                const button = document.getElementById('verify-account-btn-modal');

                if (!accountNumber || !bankCode) {
                    return showModalAlert("Please select a bank and enter an account number.");
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

                try {
                    const resolveAccountFunction = httpsCallable(functions, 'resolveAccountNumber');
                    const result = await resolveAccountFunction({ accountNumber, bankCode });

                    if (result.data.status) {
                        verifiedBankData = {
                            accountName: result.data.data.account_name,
                            accountNumber: result.data.data.account_number,
                            bankCode: bankCode,
                            bankName: nigerianBanks.find(b => b.code === bankCode).name
                        };
                        document.getElementById('account-name-modal').textContent = verifiedBankData.accountName;
                        document.getElementById('verification-result-modal').classList.remove('hidden');
                        document.getElementById('save-bank-btn-modal').addEventListener('click', saveBankAccount);
                    } else {
                        showModalAlert(result.data.message || "Could not verify account details.");
                    }
                } catch (error) {
                    console.error("Bank Verification Error:", error);
                    showModalAlert(error.message || "An error occurred. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Verify Account';
                }
            }
            
            async function saveBankAccount() {
                if (!verifiedBankData) return;
                const button = document.getElementById('save-bank-btn-modal');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const userDocRef = doc(db, "users", auth.currentUser.uid);
                    await updateDoc(userDocRef, { bankDetails: verifiedBankData });
                    showModalAlert("Bank account saved successfully!", "success");
                    setTimeout(() => modalContainer.classList.add('hidden'), 2000);
                } catch (error) {
                    console.error("Error saving bank data:", error);
                    showModalAlert("Could not save bank details. Please try again.");
                    button.disabled = false;
                    button.innerHTML = 'Save Bank';
                }
            }

            async function changeUserPassword(e) {
                e.preventDefault();
                const newPassword = document.getElementById('change-password-input').value;
                if (newPassword.length < 6) {
                    return showModalAlert("Password must be at least 6 characters.");
                }
                try {
                    await updatePassword(auth.currentUser, newPassword);
                    showModalAlert("Password updated successfully!", "success");
                    document.getElementById('change-password-form').reset();
                } catch (error) {
                    console.error("Password change error:", error);
                    showModalAlert("Error updating password. You may need to sign in again.");
                }
            }

            async function updateSecuritySettings(settings) {
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await updateDoc(userDocRef, {
                    securitySettings: { ...currentUserData.securitySettings, ...settings }
                });
            }
            
            async function toggleTheme(e) {
                const newTheme = e.target.checked ? 'dark' : 'light';
                document.body.classList.toggle('light-mode', newTheme === 'light');
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await updateDoc(userDocRef, {
                    preferences: { ...currentUserData.preferences, theme: newTheme }
                });
            }
            
            // --- Full Auth Form Logic ---
            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                loader.style.display = 'flex';
                const fullname = document.getElementById('signup-fullname').value;
                const username = document.getElementById('signup-username').value;
                const email = document.getElementById('signup-email').value;
                const phone = document.getElementById('signup-phone').value;
                const country = document.getElementById('signup-country').value;
                const password = document.getElementById('signup-password').value;

                try {
                    // Call Django register API
                    const response = await fetch('/api/users/register/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({
                            email: email,
                            username: username,
                            password: password,
                            first_name: fullname.split(' ')[0],
                            last_name: fullname.split(' ').slice(1).join(' ') || '',
                            phone: phone,
                            country: country
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Registration successful, now login
                        const loginResponse = await fetch('/api/users/login/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken(),
                            },
                            body: JSON.stringify({
                                email: email,
                                password: password
                            })
                        });

                        const loginData = await loginResponse.json();

                        if (loginResponse.ok) {
                            // Login successful, redirect to dashboard
                            window.location.href = '/dashboard/';
                        } else {
                            showError(loginData.error || 'Login failed after registration');
                        }
                    } else {
                        showError(data.error || 'Registration failed');
                    }
                } catch (error) { 
                    showError('Network error: ' + error.message); 
                } finally { 
                    loader.style.display = 'none'; 
                }
            });

            document.getElementById('signin-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                loader.style.display = 'flex';
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                
                try {
                    const response = await fetch('/api/users/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({
                            email: email,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Login successful, redirect to dashboard
                        window.location.href = '/dashboard/';
                    } else {
                        showError(data.error || 'Login failed');
                    }
                } catch (error) { 
                    showError('Network error: ' + error.message); 
                } finally { 
                    loader.style.display = 'none'; 
                }
            });

            document.getElementById('resend-verification-btn').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (user) {
                    try {
                        await sendEmailVerification(user);
                        showError("Verification email sent!"); // Using the error display as a success message
                    } catch (error) {
                        showError(error.message);
                    }
                }
            });

            // --- Admin & Chat Logic ---
            function showAdminPage() {
                if (!appReady || currentUserData?.role !== 'admin') {
                    showError("You do not have permission to view this page.");
                    return showPage('app'); // Redirect non-admins
                }
                showPage('admin');
                loadUsersForAdmin();
                loadRatesForAdmin();
                loadActiveChats();
            }

            function loadUsersForAdmin() {
                const userListEl = document.getElementById('user-list-admin');
                onSnapshot(collection(db, "users"), (snapshot) => {
                    userListEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userEl = document.createElement('div');
                        userEl.className = 'p-2 bg-gray-700 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600';
                        userEl.innerHTML = `<span>${user.email}</span> <span class="text-xs">${user.role || 'user'}</span>`;
                        userEl.onclick = () => showUserDetailsModal(user);
                        userListEl.appendChild(userEl);
                    });
                });
            }

            function showUserDetailsModal(userData) {
                const bankDetailsHTML = userData.bankDetails ? `
                    <div class="mt-4 pt-3 border-t border-gray-600">
                        <p class="text-sm text-gray-400">Bank Details</p>
                        <p>${userData.bankDetails.accountName}</p>
                        <p>${userData.bankDetails.bankName} - ${userData.bankDetails.accountNumber}</p>
                    </div>
                ` : `<p class="mt-4 pt-3 border-t border-gray-600 text-sm text-gray-400">No bank account added.</p>`;

                const modalHTML = `
                <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">User Details</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                    <div class="space-y-3 text-left">
                        <div><p class="text-sm text-gray-400">Full Name</p><p>${userData.fullname || 'N/A'}</p></div>
                        <div><p class="text-sm text-gray-400">Username</p><p>${userData.username}</p></div>
                        <div><p class="text-sm text-gray-400">Email</p><p>${userData.email}</p></div>
                        <div><p class="text-sm text-gray-400">Phone</p><p>${userData.phone}</p></div>
                        <div><p class="text-sm text-gray-400">KYC Verified</p><p>${userData.kycVerified ? 'Yes' : 'No'}</p></div>
                        ${bankDetailsHTML}
                    </div>
                </div>`;
                showModal(modalHTML);
            }

            function loadRatesForAdmin() {
                const ratesListEl = document.getElementById('rates-list-admin');
                const cryptoSelect = document.getElementById('rate-crypto-select-admin');
                const rateInput = document.getElementById('rate-ngn-admin');

                onSnapshot(collection(db, "rates"), (snapshot) => {
                    ratesListEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const rate = doc.data();
                        const rateEl = document.createElement('div');
                        rateEl.className = 'p-2 bg-gray-700 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600';
                        rateEl.innerHTML = `<span>${rate.name}</span> <span>₦${rate.nairaRate}/$</span>`;
                        rateEl.onclick = () => {
                            cryptoSelect.value = doc.id;
                            rateInput.value = rate.nairaRate;
                        };
                        ratesListEl.appendChild(rateEl);
                    });
                });
            }

            document.getElementById('rate-form-admin').addEventListener('submit', async (e) => {
                e.preventDefault();
                const cryptoId = document.getElementById('rate-crypto-select-admin').value;
                const nairaRate = document.getElementById('rate-ngn-admin').value;

                if (!cryptoId || !nairaRate) {
                    return showError("Please select a crypto and enter a rate.");
                }

                const predefinedRates = {
                    bitcoin: { name: 'Bitcoin', icon: 'fab fa-bitcoin', iconColor: 'text-orange-400' },
                    ethereum: { name: 'Ethereum', icon: 'fab fa-ethereum', iconColor: 'text-gray-400' },
                    tether: { name: 'Tether', icon: 'fas fa-dollar-sign', iconColor: 'text-green-400' }
                };

                const rateData = {
                    ...predefinedRates[cryptoId],
                    nairaRate: parseFloat(nairaRate)
                };

                await setDoc(doc(db, "rates", cryptoId), rateData);
                showError("Rate updated successfully!");
                e.target.reset();
            });


            function loadActiveChats() {
                if (unsubscribeChats) unsubscribeChats();
                const chatsRef = collection(db, "active_chats");
                const q = query(chatsRef, orderBy("timestamp", "desc"));
                const container = document.getElementById('support-chats-admin');
                const adminBadge = document.getElementById('admin-notification-badge');

                unsubscribeChats = onSnapshot(q, (snapshot) => {
                    container.innerHTML = '';
                    let hasUnread = false;
                    if (snapshot.empty) {
                        container.innerHTML = '<p class="text-gray-400 text-sm text-center">No active chats.</p>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const chat = doc.data();
                        if(chat.unreadByAdmin) hasUnread = true;
                        const chatEl = document.createElement('div');
                        chatEl.className = 'p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 flex justify-between items-center';
                        chatEl.innerHTML = `
                            <div>
                                <p class="font-bold text-sm">${chat.userEmail}</p>
                                <p class="text-xs text-gray-400 truncate">${chat.lastMessage}</p>
                            </div>
                            ${chat.unreadByAdmin ? '<div class="w-3 h-3 bg-red-500 rounded-full"></div>' : ''}
                        `;
                        chatEl.onclick = () => showChatModalForUser(doc.id, chat.userEmail);
                        container.appendChild(chatEl);
                    });
                    adminBadge.classList.toggle('hidden', !hasUnread);
                });
            }

            function listenForChatNotifications(userId) {
                const chatRef = doc(db, "active_chats", userId);
                onSnapshot(chatRef, (doc) => {
                    const chatNotificationBadge = document.getElementById('chat-notification-badge');
                    if (doc.exists() && doc.data().unreadByUser) {
                        chatNotificationBadge.classList.remove('hidden');
                    } else {
                        chatNotificationBadge.classList.add('hidden');
                    }
                });
            }

            function showChatModalForUser(userId, userEmail) {
                // If called from user side, userId is an event object.
                const isUser = typeof userId === 'object';
                const currentUserId = isUser ? auth.currentUser.uid : userId;
                const chatPartnerName = isUser ? "Support" : userEmail;
                const senderId = isUser ? currentUserId : 'admin';

                const modalHTML = `
                    <div class="modal-content w-full h-full max-w-sm flex flex-col">
                        <div class="flex justify-between items-center p-4 border-b border-gray-600">
                            <h3 class="text-xl font-bold">${chatPartnerName}</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col"></div>
                        <div class="p-4 border-t border-gray-600">
                            <form id="chat-form" class="flex gap-2">
                                <input id="chat-input" class="form-input flex-1 p-2 rounded-lg" placeholder="Type a message..." required>
                                <button type="submit" class="submit-btn px-4 rounded-lg"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>`;
                showModal(modalHTML);
                
                const chatMessagesEl = document.getElementById('chat-messages');
                const chatForm = document.getElementById('chat-form');
                const chatInput = document.getElementById('chat-input');

                const messagesRef = collection(db, "chats", currentUserId, "messages");
                const q = query(messagesRef, orderBy("timestamp"));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    chatMessagesEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const isSentByCurrentUser = msg.sender === senderId;
                        const bubble = document.createElement('div');
                        bubble.textContent = msg.text;
                        bubble.className = `chat-bubble p-2 rounded-lg ${isSentByCurrentUser ? 'sent self-end' : 'received self-start'}`;
                        chatMessagesEl.appendChild(bubble);
                    });
                    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
                });

                // Mark messages as read when chat is opened
                const activeChatRef = doc(db, "active_chats", currentUserId);
                if (isUser) {
                    setDoc(activeChatRef, { unreadByUser: false }, { merge: true });
                } else { // Is Admin
                    setDoc(activeChatRef, { unreadByAdmin: false }, { merge: true });
                }

                // Overwrite close button to also unsubscribe from listener
                modalContainer.querySelector('.close-modal-btn').addEventListener('click', () => {
                    unsubscribe();
                    modalContainer.classList.add('hidden');
                });

                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = chatInput.value;
                    if (!text.trim()) return;
                    chatInput.value = '';

                    await addDoc(messagesRef, {
                        text: text,
                        sender: senderId,
                        timestamp: serverTimestamp()
                    });

                    // Update the active_chats collection
                    await setDoc(activeChatRef, {
                        userEmail: isUser ? currentUserData.email : userEmail,
                        lastMessage: text,
                        timestamp: serverTimestamp(),
                        unreadByAdmin: isUser,
                        unreadByUser: !isUser,
                    }, { merge: true });
                });
            }
        });
    </script>
</body>
</html>
