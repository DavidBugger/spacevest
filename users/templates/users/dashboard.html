{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceVest - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E5E7EB;
            transition: background-color 0.3s, color 0.3s;
        }
        .auth-container, .modal-content, .profile-section, .settings-list > div, .admin-section {
            background-color: #1F2937;
        }
        .form-input {
            background-color: #374151;
            border: 1px solid #4B5563;
        }
        .submit-btn, .verify-btn {
            background: linear-gradient(105deg, #FFD700, #FBBF24, #F59E0B);
            color: #1F2937;
        }
        .submit-btn:disabled, .verify-btn:disabled {
            background: #4B5563;
            color: #9CA3AF;
            cursor: not-allowed;
        }
        .wallet-card {
            background: linear-gradient(105deg, #FFD700, #FBBF24, #F59E0B);
            position: relative;
            overflow: hidden;
        }
        .wallet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 400'%3E%3Cpath fill='rgba(255, 255, 255, 0.05)' d='M 0 100 C 200 150 400 50 600 100 S 800 150 800 100 V 400 H 0 Z'/%3E%3Cpath fill='rgba(255, 255, 255, 0.08)' d='M 0 200 C 150 280 350 120 550 200 S 800 120 800 200 V 400 H 0 Z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0.5;
        }
        .action-item, .settings-item {
            background-color: #1F2937;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .action-item:hover, .settings-item:hover {
            background-color: #374151;
        }
        .bottom-nav {
            background-color: #1F2937;
            transition: background-color 0.3s;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Light Mode */
        body.light-mode { background-color: #F3F4F6; color: #1F2937; }
        .light-mode .auth-container, .light-mode .modal-content, .light-mode .profile-section, .light-mode .settings-list > div, .light-mode .action-item, .light-mode .settings-item, .light-mode .bottom-nav, .light-mode .admin-section { background-color: #FFFFFF; border: 1px solid #E5E7EB; }
        .light-mode .form-input { background-color: #F3F4F6; border-color: #D1D5DB; }
        .light-mode #username-home, .light-mode #username-profile, .light-mode h2, .light-mode h3, .light-mode h4, .light-mode .font-bold { color: #111827; }
        .light-mode .text-gray-400 { color: #6B7280; }
        .light-mode .text-gray-300 { color: #4B5563; }
        .light-mode .text-gray-500 { color: #9CA3AF; }
        .light-mode .border-gray-600 { border-color: #E5E7EB; }
        .light-mode .border-gray-700 { border-color: #D1D5DB; }
        
        /* Chat bubble styles */
        .chat-bubble { max-width: 75%; }
        .chat-bubble.sent { background-color: #FBBF24; color: #1F2937; }
        .chat-bubble.received { background-color: #374151; }
        .light-mode .chat-bubble.received { background-color: #E5E7EB; }
        
        /* Tab styles */
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #FBBF24; color: #FBBF24; }
        .light-mode .tab-btn.active { color: #F59E0B; border-bottom-color: #F59E0B; }

         /* Marquee Styles */
        .marquee-container {
            white-space: nowrap;
        }
        .marquee-content {
            animation: marquee 60s linear infinite; /* Increased duration for more content */
            display: inline-block;
        }
        .marquee-item {
            display: inline-flex;
            align-items: center;
            margin-right: 2.5rem; /* 40px */
        }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); } /* Animate to -50% because content is duplicated */
        }
        .marquee-container:hover .marquee-content {
            animation-play-state: paused;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
            border: 1px solid #1F2937;
        }

        /* Page sections */
        .page-section {
            min-height: calc(100vh - 80px);
            padding-bottom: 80px;
        }
    </style>
</head>
<body class="max-w-md mx-auto p-4 min-h-screen" style="padding-bottom: 80px;">
    
    <div id="app-loader" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <i class="fas fa-spinner fa-spin text-white text-4xl"></i>
    </div>
    
    <div id="auth-error" class="fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50"></div>

    <!-- Main App Section -->
    <div id="page-app" class="page-section">
    <header class="flex justify-between items-center py-4">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fa-solid fa-face-meh text-2xl text-gray-700"></i>
            </div>
            <div>
                <p class="text-sm text-gray-400">Welcome back,</p>
                <div class="flex items-center gap-1">
                    <h1 id="username-home" class="font-bold text-lg">{{ user.username }}</h1>
                    <i class="fas fa-check-circle text-blue-500 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="relative">
            <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 text-sm rounded-full flex items-center gap-1">
                <i class="fa-solid fa-right-from-bracket"></i>Logout
            </button>
        </div>
    </header>

    <section class="wallet-card text-gray-800 rounded-2xl p-6 my-4 shadow-lg">
        <div class="relative z-10">
            <div class="flex items-center gap-2 text-sm">
                <span>Wallet Balance:</span>
                <i id="toggle-balance" class="fa-regular fa-eye-slash cursor-pointer"></i>
            </div>
            <p id="wallet-balance" class="text-4xl font-bold mt-2">₦ {{ user.wallet_balance|floatformat:2 }}</p>
        </div>
    </section>

    {% if bank_account %}
    <section class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 mb-6">
        <div class="flex items-start justify-between">
            <div class="flex items-start gap-3">
                <div class="p-2 bg-green-500/20 rounded-lg">
                    <i class="fa-solid fa-building-columns text-green-400 text-xl"></i>
                </div>
                <div>
                    <!-- <h3 class="font-medium text-white">{{ bank_account.account_name }}</h3> -->
                    <p class="text-sm text-gray-300">{{ bank_account.bank.name }} ••••{{ bank_account.account_number|slice:'-4:' }}</p>
                    <div class="flex items-center mt-1 gap-2">
                        <span class="text-xs bg-green-500/20 text-green-300 px-2 py-0.5 rounded-full">
                            <i class="fas fa-check-circle mr-1"></i> Verified
                        </span>
                        {% if bank_account.is_primary %}
                        <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full">
                            <i class="fas fa-star mr-1"></i> Primary
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <button id="change-bank-btn" class="text-xs text-blue-400 hover:text-blue-300 transition-colors">
                Change
            </button>
        </div>
    </section>
    {% else %}
    <section id="bank-details-prompt" class="bg-teal-500/20 text-teal-300 p-4 rounded-xl flex items-center gap-4 mb-6 cursor-pointer" data-action="add-bank-account">
        <i class="fa-solid fa-building-columns text-2xl"></i>
        <p class="text-sm">Please add your bank details to submit transactions</p>
    </section>
    {% endif %}


            <div class="marquee-container bg-gray-800 rounded-lg p-3 overflow-hidden">
                <div class="marquee-content flex">
                    <!-- Rates will be populated dynamically from database -->
                </div>
            </div>
        

    <section>
        <h2 class="text-lg font-semibold my-6">Actions</h2>
        <div class="grid grid-cols-3 gap-4">
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-between h-full" data-action="add_funds">
                <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-plus text-green-400"></i>
                </div>
                <p class="text-sm font-medium text-center">Add Funds</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-between h-full" data-action="withdraw">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-arrow-down text-yellow-400"></i>
                </div>
                <p class="text-sm font-medium text-center">Withdraw</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-between h-full" data-action="transfer">
                <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-paper-plane text-blue-400"></i>
                </div>
                <p class="text-sm font-medium text-center">Transfer</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-between h-full" data-action="sell_crypto">
                <div class="w-12 h-12 bg-orange-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-brands fa-bitcoin text-orange-400"></i>
                </div>
                <p class="text-sm font-medium text-center">Sell Crypto</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-between h-full" data-action="top_up">
                <div class="w-12 h-12 bg-sky-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-mobile-screen-button text-sky-400"></i>
                </div>
                <p class="text-sm font-medium text-center">Top-up</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-between h-full" data-action="cable_tv">
                <div class="w-12 h-12 bg-indigo-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-tv text-indigo-400"></i>
                </div>
                <p class="text-sm font-medium text-center">Cable TV</p>
            </div>
        </div>
    </section>

    </div>

    <nav class="bottom-nav fixed bottom-0 left-0 right-0 max-w-md mx-auto grid grid-cols-5 items-center text-center py-3 border-t border-gray-700 z-40">
        <a href="#" id="nav-app" class="text-yellow-400">
            <i class="fa-solid fa-house text-xl"></i>
            <p class="text-xs font-semibold mt-1">Home</p>
        </a>
        <a href="#" id="nav-history" class="text-gray-400">
            <i class="fa-solid fa-list-ul text-xl"></i>
            <p class="text-xs font-medium mt-1">History</p>
        </a>
        <a href="#" id="nav-rates" class="text-gray-400">
            <i class="fa-solid fa-chart-line text-xl"></i>
            <p class="text-xs font-medium mt-1">Rates</p>
        </a>
        <a href="#" id="nav-profile" class="text-gray-400">
            <i class="fa-solid fa-user text-xl"></i>
            <p class="text-xs font-medium mt-1">Profile</p>
        </a>
        <!-- Debug: Template check for admin role -->
        <!-- User role: {{ user.role }} -->
        <!-- Is admin check: {% if user.role == 'admin' %}YES{% else %}NO{% endif %} -->
        {% if user.is_superuser %}
        <a href="#" id="nav-admin" class="text-gray-400 relative">
            <i class="fa-solid fa-user-shield text-xl"></i>
            <p class="text-xs font-medium mt-1">Admin</p>
            <div id="admin-notification-badge" class="notification-badge hidden"></div>
        </a>
        {% endif %}
    </nav>
    {% block extra_js %}
        <script src="{% static 'js/bank-account.js' %}"></script>
    {% endblock %}

    <div id="page-profile" class="page-section hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Profile</h2>
        <div class="flex items-center gap-4 mb-6">
            <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fa-solid fa-face-meh text-4xl text-gray-700"></i>
            </div>
            <div>
                <div class="flex items-center gap-2">
                    <h1 id="username-profile" class="font-bold text-xl">{{ user.username }}</h1>
                    <i class="fas fa-check-circle text-blue-500"></i>
                </div>
                <p id="fullname-profile" class="text-gray-400">{{ user.first_name }} {{ user.last_name }}</p>
            </div>
        </div>
        
        <div id="kyc-banner" class="p-4 rounded-xl flex items-center justify-between mb-8 cursor-pointer bg-gray-800" data-action="kyc_verification">
            <div class="flex items-center gap-4">
                <i class="fas fa-address-card text-2xl text-yellow-400"></i>
                <div>
                    <p class="font-bold">KYC</p>
                    <p id="kyc-subtext" class="text-xs text-gray-400">Please add your BVN details</p>
                </div>
            </div>
            <div id="kyc-status" class="text-red-400 font-semibold text-sm">Not Done</div>
        </div>
        
        <h3 class="text-lg font-semibold mb-4 text-gray-300">Settings</h3>

        <div class="space-y-2 settings-list">
            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="personal_info">
                <div class="flex items-center gap-4">
                    <i class="fas fa-user-circle text-yellow-400"></i>
                    <p>Personal Information</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>

            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="kyc_verification">
                <div class="flex items-center gap-4">
                    <i class="fas fa-check-circle text-yellow-400"></i>
                    <p>KYC verification</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>

            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="badge">
                <div class="flex items-center gap-4">
                    <i class="fas fa-medal text-yellow-400"></i>
                    <p>Badge</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>

            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="security">
                <div class="flex items-center gap-4">
                    <i class="fas fa-lock text-yellow-400"></i>
                    <p>Security</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>

            <!-- <div class="settings-item p-4 rounded-xl mb-3 flex justify-between items-center" data-action="bank-verification">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center mr-3">
                        <i class="fas fa-university text-blue-400"></i>
                    </div>
                    <span>Bank Verification</span>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </div> -->
            
            <div class="settings-item p-4 rounded-xl mb-3 flex justify-between items-center cursor-pointer" id="add-bank-account-btn">
                <div class="flex items-center gap-4">
                    <!-- <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center mr-3"> -->
                        <i class="fas fa-plus-circle text-yellow-400"></i>
                    <!-- </div> -->
                     
                    <span> Add Bank Account</span>
                </div>
                <i class="fas fa-chevron-right text-gray-400"></i>
            </div>

            <!-- <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="account_limits">
                <div class="flex items-center gap-4">
                    <i class="fas fa-tachometer-alt text-yellow-400"></i>
                    <p>Account Limits</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div> -->

            <div class="settings-item flex justify-between items-center p-4 rounded-lg" data-action="preferences">
                <div class="flex items-center gap-4">
                    <i class="fas fa-cookie-bite text-yellow-400"></i>
                    <p>Preferences</p>
                </div>
                <i class="fas fa-chevron-right text-gray-500"></i>
            </div>
        </div>
    </div>

    <div id="page-history" class="page-section hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Transaction History</h2>
        <div id="history-container" class="space-y-3">
            <!-- Transaction items will be injected here -->
        </div>
    </div>

    <div id="page-rates" class="page-section hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Live Market Rates</h2>
        <div id="rates-page-container" class="space-y-3">
            <!-- Rates will be populated here -->
        </div>
    </div>

    <div id="page-admin" class="page-section hidden">
        <h2 class="text-2xl font-bold text-center mb-6">Admin Panel</h2>
        <div class="admin-section rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-semibold mb-2">User Management</h3>
            <div id="user-list-admin" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div class="admin-section rounded-2xl p-4 mb-6">
            <h3 class="text-lg font-semibold mb-2">Support Chats</h3>
            <div id="support-chats-admin" class="space-y-2 max-h-60 overflow-y-auto"></div>
        </div>
        <div class="admin-section rounded-2xl p-4">
            <h3 class="text-lg font-semibold mb-2">Manage Rates</h3>
            <div id="rates-list-admin" class="space-y-2 mb-4 max-h-40 overflow-y-auto"></div>
            <h4 class="font-semibold mb-2 pt-2 border-t border-gray-600">Update Rate</h4>
            <form id="rate-form-admin" class="space-y-2 text-sm">
                {% csrf_token %}
                <div class="mb-2">
                    <label for="rate-crypto-select-admin" class="block text-sm font-medium text-gray-300 mb-1">Cryptocurrency</label>
                    <select id="rate-crypto-select-admin" class="form-input w-full p-2 rounded-lg">
                        <option value="bitcoin">Bitcoin (BTC)</option>
                        <option value="ethereum">Ethereum (ETH)</option>
                        <option value="tether">Tether (USDT)</option>
                    </select>
                </div>
                <div class="mb-2">
                    <label for="rate-ngn-admin" class="block text-sm font-medium text-gray-300 mb-1">New NGN Rate per $</label>
                    <input type="number" step="0.01" id="rate-ngn-admin" placeholder="e.g., 1500" class="form-input w-full p-2 rounded-lg" required>
                </div>
                <button type="submit" class="submit-btn w-full p-2 rounded-lg font-bold">Update Rate</button>
            </form>
        </div>
    </div>

    <button id="chat-btn" class="fixed bottom-24 right-5 bg-yellow-400 text-black w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-40">
        <i class="fas fa-comment-dots text-2xl"></i>
        <div id="chat-notification-badge" class="notification-badge hidden"></div>
    </button>

    <!-- Add Funds Modal -->
    <div id="add-funds-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="add-funds-form" class="space-y-4">
                {% csrf_token %}
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                    <input type="number" name="amount" required min="100" step="100"
                           class="form-input w-full p-3 rounded-lg" placeholder="Enter amount"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>

                <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                    Proceed to Payment
                </button>
            </form>
        </div>
    </div>


    

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Withdraw to Bank</h3>
                <button id="close-withdraw" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="withdraw-alert" class="hidden"></div>
            <form id="withdraw-form" class="space-y-4">
                {% csrf_token %}
                <div class="text-left">
                    <p class="text-sm text-gray-400">Withdrawal Account:</p>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="font-semibold">{{ user.bank_details.account_name }}</p>
                        <small>{{ user.bank_details.bank_name }} - {{ user.bank_details.account_number }}</small>
                    </div>
                </div>
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                    <input type="number" id="withdraw-amount" required min="100" step="100"
                           class="form-input w-full p-3 rounded-lg" placeholder="Enter amount"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                    Withdraw Funds
                </button>
            </form>
        </div>
    </div>
    

    <!-- Transfer Modal -->
    <div id="transfer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Transfer Funds</h3>
                <button id="close-transfer" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex border-b border-gray-700 mb-4">
                <button id="tab-user" class="tab-btn active flex-1 py-2 font-semibold">SpaceVest User</button>
                <button id="tab-bank" class="tab-btn flex-1 py-2 font-semibold">Bank Account</button>
            </div>
            <div id="transfer-alert" class="hidden"></div>

            <!-- SpaceVest User Tab Content -->
            <div id="content-user">
                <form id="transfer-user-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Recipient Email</label>
                        <input type="email" id="transfer-email" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                        <input type="number" id="transfer-user-amount" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Send
                    </button>
                </form>
            </div>

            <!-- Bank Account Tab Content -->
            <div id="content-bank" class="hidden">
                {% if user.bank_details %}
                <form id="transfer-bank-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <p class="text-sm text-gray-400">Recipient</p>
                        <div class="p-3 bg-gray-700 rounded-lg">
                            {{ user.bank_details.account_name }}<br>
                            <small>{{ user.bank_details.bank_name }} - {{ user.bank_details.account_number }}</small>
                        </div>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                        <input type="number" id="transfer-bank-amount" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Withdraw Funds
                    </button>
                </form>
                {% else %}
                <p class="text-center text-yellow-400">Please add a bank account in your profile first.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Bank Account Modal -->
    <div id="add-bank-account-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Add Bank Account</h3>
                <button id="close-add-bank-account" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-bank-account-form" class="space-y-4">
                {% csrf_token %}
                
                <div>
                    <label for="bank-select" class="block text-sm font-medium text-gray-300 mb-2">Select Bank</label>
                    <select id="bank-select" name="bank_code" required
                            class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 text-white">
                        <option value="">Loading banks...</option>
                    </select>
                </div>
                
                <div>
                    <label for="account-number" class="block text-sm font-medium text-gray-300 mb-2">Account Number</label>
                    <input type="text" id="account-number" name="account_number" required
                           placeholder="Enter your account number"
                           class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 text-white"
                           maxlength="10" pattern="\d{10}">
                    <p class="mt-1 text-xs text-gray-400">Enter your 10-digit account number</p>
                </div>
                
                <div id="account-name-display" class="hidden p-3 bg-gray-700 rounded-lg mb-4">
                    <p class="text-sm text-gray-300">Account Name: <span id="account-name" class="font-medium text-white"></span></p>
                </div>
                
                <div id="verification-result" class="hidden"></div>
                
                <button type="submit" id="verify-account-btn"
                        class="w-full py-3 px-4 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <span id="verification-spinner" class="hidden mr-2">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                    Verify Account
                </button>
            </form>
        </div>
    </div>

    <!-- Sell Crypto Modal -->
    <div id="sell-crypto-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Sell Crypto</h3>
                <button id="close-sell-crypto" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="sell-crypto-alert" class="hidden"></div>
            <form id="sell-crypto-form" class="space-y-4">
                {% csrf_token %}
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Cryptocurrency</label>
                    <select id="crypto-select" class="form-input w-full p-3 rounded-lg">
                        <option value="">Select Crypto</option>
                        <option value="bitcoin">Bitcoin (BTC)</option>
                        <option value="ethereum">Ethereum (ETH)</option>
                        <option value="tether">Tether (USDT)</option>
                    </select>
                </div>
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Amount to Sell (USD)</label>
                    <input type="number" step="any" id="crypto-amount-usd" class="form-input w-full p-3 rounded-lg" required>
                </div>
                <div class="p-4 bg-gray-800 rounded-lg text-left">
                    <p class="text-sm text-gray-400">Current Rate</p>
                    <p id="admin-rate-display" class="text-xl font-bold">₦0.00 / $</p>
                </div>
                <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                    Sell Now (via WhatsApp)
                </button>
            </form>
        </div>
    </div>

    <!-- Top-up Modal -->
    <div id="top-up-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Top-up</h3>
                <button id="close-top-up" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Step 1: Choose Service Type -->
            <div id="step-service-type">
                <div class="flex border-b border-gray-700 mb-4">
                    <button id="tab-airtime" class="tab-btn active flex-1 py-2 font-semibold">Airtime</button>
                    <button id="tab-data" class="tab-btn flex-1 py-2 font-semibold">Data</button>
                </div>
                <button id="proceed-service" class="submit-btn w-full p-4 rounded-lg font-bold text-lg" type="button">
                    Continue
                </button>
            </div>

            <!-- Step 2: Choose Network/Provider -->
            <div id="step-network" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-service" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Choose Network</h4>
                </div>
                <div id="network-cards" class="grid grid-cols-2 gap-3">
                    <!-- Network cards will be populated here -->
                </div>
            </div>

            <!-- Step 3: Choose Plan -->
            <div id="step-plan" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-network" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Choose Plan</h4>
                </div>
                <div id="plan-cards" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Plan cards will be populated here -->
                </div>
            </div>

            <!-- Step 4: Enter Phone Number -->
            <div id="step-phone" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-plan" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Enter Phone Number</h4>
                </div>
                <form id="phone-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Phone Number</label>
                        <input type="tel" id="phone-number" class="form-input w-full p-3 rounded-lg" required placeholder="Enter phone number">
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Continue
                    </button>
                </form>
            </div>

            <!-- Step 5: Summary & Confirm -->
            <div id="step-summary" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-phone" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Confirm Purchase</h4>
                </div>
                <div id="purchase-summary" class="bg-gray-800 p-4 rounded-lg space-y-3">
                    <!-- Summary will be populated here -->
                </div>
                <button id="confirm-purchase" class="submit-btn w-full p-4 rounded-lg font-bold text-lg mt-4" type="button">
                    Confirm & Pay
                </button>
            </div>
        </div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        // Define missing variables and functions
        const nigerianBanks = [
            { code: '044', name: 'Access Bank' },
            { code: '023', name: 'Citibank Nigeria' },
            { code: '035', name: 'Fidelity Bank' },
            { code: '057', name: 'Zenith Bank' },
            { code: '011', name: 'First Bank' },
            { code: '058', name: 'Guaranty Trust Bank' },
            { code: '030', name: 'Heritage Bank' },
            { code: '082', name: 'Keystone Bank' },
            { code: '076', name: 'Polaris Bank' },
            { code: '068', name: 'Standard Chartered Bank' },
            { code: '232', name: 'Sterling Bank' },
            { code: '032', name: 'Union Bank' },
            { code: '033', name: 'United Bank for Africa' },
            { code: '215', name: 'Unity Bank' },
            { code: '035', name: 'Wema Bank' },
        ];

        function showModal(content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = content;
            document.body.appendChild(modal);
            const closeBtn = modal.querySelector('.close-modal-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.remove());
            }
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function showModalAlert(message, type = 'error') {
            showAlert('modal-alert', message, type);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }

        function handleSellCryptoViaWhatsApp() {
            const cryptoSelect = document.getElementById('crypto-select');
            const amountUSD = document.getElementById('crypto-amount-usd').value;
            if (!cryptoSelect.value) {
                showModalAlert('Please select a cryptocurrency.');
                return;
            }
            if (!amountUSD || parseFloat(amountUSD) <= 0) {
                showModalAlert('Please enter a valid amount.');
                return;
            }
            const phoneNumber = "2347066718413";
            const message = `Hello, I want to sell ${amountUSD} USD of ${cryptoSelect.options[cryptoSelect.selectedIndex].text} at your rate.`;
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function handleUserTransfer(e) {
            e.preventDefault();
            const recipientEmail = document.getElementById('transfer-email').value;
            const amount = parseFloat(document.getElementById('transfer-user-amount').value);
            if (recipientEmail === currentUserData.email) {
                showModalAlert('You cannot transfer to yourself.');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showModalAlert('Invalid amount.');
                return;
            }
            if (amount > userWalletBalance) {
                showModalAlert('Insufficient funds.');
                return;
            }
            try {
                const response = await fetch('/api/transactions/transfer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({
                        recipient_email: recipientEmail,
                        amount: amount,
                        type: 'user'
                    })
                });
                if (response.ok) {
                    showModalAlert('Transfer successful!', 'success');
                    e.target.reset();
                    setTimeout(() => {
                        document.querySelector('.modal-content').parentElement.remove();
                        window.location.reload();
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showModalAlert(errorData.error || 'Transfer failed.');
                }
            } catch (error) {
                showModalAlert('Network error: ' + error.message);
            }
        }

        async function handleBankTransfer(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('transfer-bank-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showModalAlert('Invalid amount.');
                return;
            }
            if (amount > userWalletBalance) {
                showModalAlert('Insufficient funds.');
                return;
            }
            try {
                const response = await fetch('/api/transactions/transfer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({
                        amount: amount,
                        type: 'bank'
                    })
                });
                if (response.ok) {
                    showModalAlert('Bank transfer initiated successfully!', 'success');
                    e.target.reset();
                    setTimeout(() => {
                        document.querySelector('.modal-content').parentElement.remove();
                        window.location.reload();
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showModalAlert(errorData.error || 'Transfer failed.');
                }
            } catch (error) {
                showModalAlert('Network error: ' + error.message);
            }
        }

        // Initialize Paystack public key
        const paystackPublicKey = '{{ paystack_public_key }}';

        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.getElementById('app-loader');
            const authErrorEl = document.getElementById('auth-error');
            const logoutBtn = document.getElementById('logout-btn');
            const navLinks = {
                app: document.getElementById('nav-app'),
                history: document.getElementById('nav-history'),
                rates: document.getElementById('nav-rates'),
                profile: document.getElementById('nav-profile'),
                admin: document.getElementById('nav-admin')
            };
            const bottomNav = document.querySelector('.bottom-nav');
            const chatBtn = document.getElementById('chat-btn');

            // Fix for toggleBalanceEl undefined error
            const toggleBalanceEl = document.getElementById('toggle-balance');
            const balanceEl = document.getElementById('wallet-balance');
            let balanceVisible = true;

            // Fix for auth undefined error - removed firebase auth usage since using Django
            const auth = null; // No firebase auth, Django handles authentication server-side
            const db = null; // No firebase db
            const functions = null; // No firebase functions

            // Set user data from Django template variables
            let currentUserData = {};
            // Use safer approach to avoid JavaScript parsing errors
            
            // Set default user data structure
            currentUserData.username = "{{ user.username|default:'Unknown'|escapejs }}";
            currentUserData.email = "{{ user.email|default:'No email'|escapejs }}";
            currentUserData.walletBalance = 0;
            currentUserData.bankDetails = null;
            currentUserData.kycVerified = false;
            currentUserData.role = "{{ user.role|default:'user'|escapejs }}";
            currentUserData.phone = "No phone";
            currentUserData.country = "Unknown";
            currentUserData.fullname = "Unknown";
            currentUserData.points = 0;
            
            // Debug logs to check what's coming from backend
            console.log('=== DEBUG: User Data from Backend ===');
            console.log('User ID:', "{{ user.id|default:'None' }}");
            console.log('Username:', "{{ user.username|default:'None' }}");
            console.log('Email:', "{{ user.email|default:'None' }}");
            console.log('Role from template:', "{{ user.role|default:'None' }}");
            console.log('Is authenticated:', "{{ user.is_authenticated|yesno:'true,false' }}");
            console.log('Is staff:', "{{ user.is_staff|yesno:'true,false' }}");
            console.log('Is superuser:', "{{ user.is_superuser|yesno:'true,false' }}");
            console.log('Current user role in JS:', currentUserData.role);
            console.log('Admin nav element exists:', !!document.getElementById('nav-admin'));
            console.log('=====================================');
            currentUserData.securitySettings = {
                showBalance: true,
                biometricsEnabled: false,
                twoFactorEnabled: false
            };
            
            // Parse numeric values safely
            try {
                const walletBalance = '{{ user.wallet_balance|default:0 }}';
                currentUserData.walletBalance = parseFloat(walletBalance) || 0;
            } catch(e) {
                currentUserData.walletBalance = 0;
            }
            
            try {
                const points = '{{ user.points|default:0 }}';
                currentUserData.points = parseInt(points) || 0;
            } catch(e) {
                currentUserData.points = 0;
            }
            
            // Parse boolean values safely
            const kycStatus = '{{ user.kyc_verified|yesno:"true,false" }}';
            currentUserData.kycVerified = kycStatus === 'true';
            let userWalletBalance = currentUserData.walletBalance;
            let appReady = true; // Mark as ready since data is from Django
            
            // Define updateBalanceUI function before using it
            function updateBalanceUI() {
                if (balanceVisible) {
                    balanceEl.textContent = `₦${Number(userWalletBalance).toLocaleString('en-NG', { minimumFractionDigits: 2 })}`;
                    toggleBalanceEl.className = 'fa-regular fa-eye cursor-pointer';
                } else {
                    balanceEl.textContent = '₦ ******';
                    toggleBalanceEl.className = 'fa-regular fa-eye-slash cursor-pointer';
                }
            }
            
            updateBalanceUI();

            const pages = {
                app: document.getElementById('page-app'),
                profile: document.getElementById('page-profile'),
                history: document.getElementById('page-history'),
                rates: document.getElementById('page-rates'),
                admin: document.getElementById('page-admin')
            };

            function showPage(pageId) {
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[pageId]) pages[pageId].classList.remove('hidden');

                Object.values(navLinks).forEach(link => {
                    if (!link) return;
                    link.classList.replace('text-yellow-400', 'text-gray-400');
                    const p = link.querySelector('p');
                    if (p) p.classList.replace('font-semibold', 'font-medium');
                });

                const activeLink = Object.values(navLinks).find(link => link && link.id === `nav-${pageId}`);
                if (activeLink) {
                    activeLink.classList.replace('text-gray-400', 'text-yellow-400');
                    const p = activeLink.querySelector('p');
                    if (p) p.classList.replace('font-medium', 'font-semibold');
                }

                if (pageId === 'app' || pageId === 'profile' || pageId === 'admin' || pageId === 'rates' || pageId === 'history') {
                    bottomNav.classList.remove('hidden');
                    chatBtn.classList.remove('hidden');
                } else {
                    bottomNav.classList.add('hidden');
                    chatBtn.classList.add('hidden');
                }

                loader.style.display = 'none';
            }

            if (navLinks.app) navLinks.app.addEventListener('click', (e) => { e.preventDefault(); showPage('app'); });
            if (navLinks.history) navLinks.history.addEventListener('click', (e) => { e.preventDefault(); showHistoryPage(); });
            if (navLinks.rates) navLinks.rates.addEventListener('click', (e) => { e.preventDefault(); showPage('rates'); loadRatesPage(); });
            if (navLinks.profile) navLinks.profile.addEventListener('click', (e) => { e.preventDefault(); showPage('profile'); });
            if (navLinks.admin) navLinks.admin.addEventListener('click', (e) => { e.preventDefault(); showAdminPage(); });

            // Back button event listeners
            const backToAppBtn = document.getElementById('back-to-app');
            const backToAppHistoryBtn = document.getElementById('back-to-app-history');
            const backToAppRatesBtn = document.getElementById('back-to-app-rates');
            const backToAppAdminBtn = document.getElementById('back-to-app-admin');

            if (backToAppBtn) backToAppBtn.addEventListener('click', () => showPage('app'));
            if (backToAppHistoryBtn) backToAppHistoryBtn.addEventListener('click', () => showPage('app'));
            if (backToAppRatesBtn) backToAppRatesBtn.addEventListener('click', () => showPage('app'));
            if (backToAppAdminBtn) backToAppAdminBtn.addEventListener('click', () => showPage('app'));

            // Fix for unsubscribeHistory undefined error
            let unsubscribeHistory = null;

            function fetchAndDisplayTransactions() {
                if (unsubscribeHistory) {
                    unsubscribeHistory();
                    unsubscribeHistory = null;
                }
                // Fetch transactions using Django API endpoint
                const historyContainer = document.getElementById('history-container');
                historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">Loading transactions...</p>';

                fetch('/api/transactions/history/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch transactions');
                        return response.json();
                    })
                    .then(data => {
                        if (!data.length) {
                            historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">No transactions yet.</p>';
                            return;
                        }
                        historyContainer.innerHTML = '';
                        data.forEach(tx => {
                            const isDebit = tx.type === 'debit';
                            const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                            const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                            const sign = isDebit ? '-' : '+';
                            const date = new Date(tx.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                            const txItemHTML = `
                                <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <i class="fas ${iconClass}"></i>
                                        <div>
                                            <p class="font-bold">${tx.description}</p>
                                            <p class="text-xs text-gray-400">${date}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold ${amountClass}">${sign} ₦${parseFloat(tx.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                                    </div>
                                </div>
                            `;
                            historyContainer.innerHTML += txItemHTML;
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching transaction history:', error);
                        historyContainer.innerHTML = '<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>';
                    });
            }

            // Settings item event listeners
            document.querySelectorAll('#page-profile .settings-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    handleSettingsAction(action);
                });
            });

            if (chatBtn) chatBtn.addEventListener('click', showChatModalForUser);
            
            // Balance toggle functionality
            // if (toggleBalanceEl) {
            //     toggleBalanceEl.addEventListener('click', () => {
            //         balanceVisible = !balanceVisible;
            //         updateBalanceUI();
            //     });
            // }
            
            // Settings action handler
            function handleSettingsAction(action) {
                switch(action) {
                    case 'personal_info':
                        showModal(`<div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Personal Information</h3><button class="close-modal-btn text-2xl">&times;</button></div><div class="space-y-3 text-left"><div><p class="text-xs text-gray-400">Username</p><p class="font-semibold">${currentUserData.username}</p></div><div><p class="text-xs text-gray-400">Email</p><p class="font-semibold">${currentUserData.email}</p></div></div></div>`);
                        break;
                    case 'kyc_verification':
                        showModal(`<div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">KYC Verification</h3><button class="close-modal-btn text-2xl">&times;</button></div><p class="text-gray-400 mb-4">KYC verification coming soon!</p></div>`);
                        break;
                    case 'security':
                        showModal(`<div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Security Settings</h3><button class="close-modal-btn text-2xl">&times;</button></div><p class="text-gray-400">Security settings coming soon!</p></div>`);
                        break;
                    case 'bank_accounts':
                        showModal(`<div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Bank Accounts</h3><button class="close-modal-btn text-2xl">&times;</button></div><p class="text-gray-400">Bank account management coming soon!</p></div>`);
                        break;
                    default:
                        showError(`${action.replace('_', ' ')} feature coming soon!`);
                }
            }
            
            // Chat modal function
            function showChatModalForUser() {
                showModal(`<div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Support Chat</h3><button class="close-modal-btn text-2xl">&times;</button></div><p class="text-gray-400 mb-4">Chat feature coming soon!</p><button onclick="window.open('https://wa.me/2347066718413', '_blank')" class="submit-btn w-full p-3 rounded-lg font-bold">Contact Support</button></div>`);
            }

            function showHistoryPage() {
                showPage('history');
                fetchAndDisplayTransactions();
            }

            function showAdminPage() {
                // alert('i am reacing here ');
                const isSuperuser = "{{ user.is_superuser|yesno:'true,false' }}" === 'true';
                console.log('Admin access check - is_superuser:', isSuperuser);
                
                if (!isSuperuser) {
                    showError("You do not have permission to view this page.");
                    return showPage('app'); // Redirect non-admins
                }
                showPage('admin');
                loadUsersForAdmin();
                loadRatesForAdmin();
                loadActiveChats();
            }
            
            // Admin functions
            function loadUsersForAdmin() {
                const userListAdmin = document.getElementById('user-list-admin');
                userListAdmin.innerHTML = '<p class="text-center text-gray-400">Loading users...</p>';
                
                fetch('/api/admin/users/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            userListAdmin.innerHTML = '<p class="text-center text-gray-400">No users found.</p>';
                            return;
                        }
                        userListAdmin.innerHTML = '';
                        data.forEach(user => {
                            const userItem = `
                                <div class="settings-item flex justify-between items-center p-3 rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center">
                                            <i class="fas fa-user text-sm"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-sm">${user.username}</p>
                                            <p class="text-xs text-gray-400">${user.email}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-semibold">₦${parseFloat(user.wallet_balance || 0).toLocaleString()}</p>
                                        <p class="text-xs text-gray-400">${user.kyc_verified ? 'Verified' : 'Unverified'}</p>
                                    </div>
                                </div>
                            `;
                            userListAdmin.innerHTML += userItem;
                        });
                    })
                    .catch(error => {
                        console.error('Error loading users:', error);
                        userListAdmin.innerHTML = '<p class="text-center text-red-400">Failed to load users.</p>';
                    });
            }
            
            function loadRatesForAdmin() {
                const ratesListAdmin = document.getElementById('rates-list-admin');
                ratesListAdmin.innerHTML = '<p class="text-center text-gray-400">Loading rates...</p>';
                
                // Sample rates data - replace with actual API call
                const sampleRates = [
                    { crypto: 'bitcoin', name: 'Bitcoin', rate: 1520, icon: 'fab fa-bitcoin', color: 'text-orange-400' },
                    { crypto: 'ethereum', name: 'Ethereum', rate: 1520, icon: 'fab fa-ethereum', color: 'text-gray-400' },
                    { crypto: 'tether', name: 'Tether', rate: 1520, icon: 'fas fa-dollar-sign', color: 'text-green-400' }
                ];
                
                ratesListAdmin.innerHTML = '';
                sampleRates.forEach(rate => {
                    const rateItem = `
                        <div class="settings-item flex justify-between items-center p-3 rounded-lg">
                            <div class="flex items-center gap-3">
                                <i class="${rate.icon} ${rate.color}"></i>
                                <p class="font-semibold text-sm">${rate.name}</p>
                            </div>
                            <p class="font-semibold">₦${rate.rate}/$</p>
                        </div>
                    `;
                    ratesListAdmin.innerHTML += rateItem;
                });
            }
            
            function loadActiveChats() {
                const supportChatsAdmin = document.getElementById('support-chats-admin');
                supportChatsAdmin.innerHTML = '<p class="text-center text-gray-400">No active chats.</p>';
            }
            
            // Rates page functionality
            async function loadRatesPage() {
                const ratesPageContainer = document.getElementById('rates-page-container');
                ratesPageContainer.innerHTML = '<p class="text-center text-gray-400">Loading rates...</p>';
                
                try {
                    // Fetch rates from database
                    const dbResponse = await fetch('/api/crypto/rates/');
                    if (!dbResponse.ok) throw new Error('Failed to fetch database rates');
                    
                    const cryptoRates = await dbResponse.json();
                    
                    if (cryptoRates.length === 0) {
                        ratesPageContainer.innerHTML = '<p class="text-center text-gray-400">No rates available. Please contact admin to set rates.</p>';
                        return;
                    }
                    
                    // Create mapping for database rates
                    const dbRatesMap = {};
                    cryptoRates.forEach(rate => {
                        const cryptoName = rate.symbol.toLowerCase();
                        const mapping = {
                            'btc': 'bitcoin',
                            'eth': 'ethereum', 
                            'usdt': 'tether'
                        };
                        const mappedName = mapping[cryptoName] || cryptoName;
                        dbRatesMap[mappedName] = {
                            name: rate.cryptocurrency,
                            nairaRate: parseFloat(rate.current_price_ngn),
                            symbol: rate.symbol
                        };
                    });
                    
                    // Fetch live prices from CoinGecko
                    const rateIds = Object.keys(dbRatesMap).join(',');
                    const priceResponse = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${rateIds}&vs_currencies=usd`);
                    
                    if (priceResponse.ok) {
                        const prices = await priceResponse.json();
                        ratesPageContainer.innerHTML = '';
                        
                        for (const id in dbRatesMap) {
                            const rateData = dbRatesMap[id];
                            const livePrice = prices[id]?.usd || 0;
                            const icon = getIconForCrypto(rateData.symbol);
                            const iconColor = getIconColorForCrypto(rateData.symbol);
                            
                            const rateItem = `
                                <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <i class="${icon} text-2xl ${iconColor}"></i>
                                        <div>
                                            <p class="font-bold">${rateData.name}</p>
                                            <p class="text-xs text-gray-400">Live Price: $${livePrice.toLocaleString()}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</p>
                                        <p class="text-xs text-gray-400">Our Rate</p>
                                    </div>
                                </div>
                            `;
                            ratesPageContainer.innerHTML += rateItem;
                        }
                    } else {
                        throw new Error('Failed to fetch live prices');
                    }
                } catch (error) {
                    console.error('Error loading rates:', error);
                    ratesPageContainer.innerHTML = '<p class="text-center text-red-400">Failed to load rates.</p>';
                }
            }

            const addFundsModal = document.getElementById('add-funds-modal');
            const closeAddFundsBtn = document.getElementById('close-add-funds');
            const addFundsForm = document.getElementById('add-funds-form');
            
            // Show error function
            function showError(message) {
                authErrorEl.textContent = message;
                authErrorEl.classList.remove('hidden');
                setTimeout(() => { authErrorEl.classList.add('hidden'); }, 3000);
            }

            // Show success function
            function showSuccess(message) {
                authErrorEl.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                authErrorEl.textContent = message;
                setTimeout(() => {
                    authErrorEl.classList.add('hidden');
                    authErrorEl.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50';
                }, 3000);
            }

            // Logout functionality
            logoutBtn.addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/users/logout/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        }
                    });

                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        showError('Logout failed');
                    }
                } catch (error) {
                    showError('Network error: ' + error.message);
                }
            });

            // Declare all modal variables first
            const withdrawModal = document.getElementById('withdraw-modal');
            const transferModal = document.getElementById('transfer-modal');
            const sellCryptoModal = document.getElementById('sell-crypto-modal');
            const topUpModal = document.getElementById('top-up-modal');

            // Now add the action item event listeners
            const actionItems = document.querySelectorAll('.action-item');
            actionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    if (action === 'add_funds') {
                        addFundsModal.classList.remove('hidden');
                    } else if (action === 'withdraw') {
                        withdrawModal.classList.remove('hidden');
                    } else if (action === 'transfer') {
                        transferModal.classList.remove('hidden');
                    } else if (action === 'sell_crypto') {
                        sellCryptoModal.classList.remove('hidden');
                    } else if (action === 'top_up') {
                        topUpModal.classList.remove('hidden');
                        resetTopUpFlow();
                    } else {
                        showError(`${action.replace('_', ' ')} feature coming soon!`);
                    }
                });
            });

            // Close add funds modal
            closeAddFundsBtn.addEventListener('click', function() {
                addFundsModal.classList.add('hidden');
            });

            // Add funds form submission
            addFundsForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const amount = formData.get('amount');
                
                if (amount < 100) {
                    showError('Minimum amount is ₦100');
                    return;
                }

                try {
                    // Get user email for Paystack
                    const userResponse = await fetch('/api/users/profile/', {
                        headers: {
                            'X-CSRFToken': getCsrfToken(),
                        }
                    });

                    if (!userResponse.ok) {
                        const errorData = await userResponse.json().catch(() => ({}));
                        throw new Error(errorData.error || `Failed to get user profile (${userResponse.status})`);
                    }

                    const userData = await userResponse.json();
                    const userEmail = userData.email;
                    
                    if (!userEmail) {
                        throw new Error('User email not found in profile');
                    }

                    // Initialize Paystack payment
                    const handler = PaystackPop.setup({
                        key: '{{ paystack_public_key }}', // Paystack public key from settings
                        email: userEmail,
                        amount: amount * 100, // Convert to kobo
                        currency: 'NGN',
                        ref: 'SPV_' + Date.now(), // Generate a unique reference
                        metadata: {
                            custom_fields: [
                                {
                                    display_name: "User ID",
                                    variable_name: "user_id",
                                    value: "{{ user.id }}"
                                }
                            ]
                        },
                        callback: function(response) {
                            // Payment successful
                            if (response.status === 'success') {
                                showSuccess('Payment successful! Adding funds to your wallet...');
                                
                                // Add funds to wallet - handle async operation properly
                                addFundsToWallet(amount, 'Wallet top-up via Paystack', response.reference)
                                    .then(success => {
                                        if (success) {
                                            showSuccess('Funds added to your wallet successfully!');
                                            addFundsModal.classList.add('hidden');
                                            
                                            // Refresh page to update wallet balance
                                            setTimeout(() => {
                                                window.location.reload();
                                            }, 2000);
                                        } else {
                                            showError('Payment successful but failed to add funds to wallet. Please contact support.');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error adding funds:', error);
                                        showError('Payment successful but error adding funds: ' + error.message);
                                    });
                            }
                        },
                        onClose: function() {
                            showError('Payment was cancelled');
                        }
                    });

                    handler.openIframe();

                } catch (error) {
                    console.error('Error:', error);
                    showError('Failed to initialize payment: ' + error.message);
                }
            });


            async function showAddFundsModal() {
                const modal = document.getElementById('add-funds-modal');
                const modalContent = modal.querySelector('.modal-content');

                // Show loading state
                modalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                        <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl text-yellow-400 mb-4"></i>
                        <p class="text-gray-400">Loading...</p>
                    </div>
                `;

                modal.classList.remove('hidden');

                try {
                    // Check if user has virtual account
                    const response = await fetch('/api/users/virtual-account/', {
                        headers: {
                            'X-CSRFToken': getCsrfToken(),
                        }
                    });

                    let content;
                    if (response.ok) {
                        const data = await response.json();
                        // User has virtual account
                        content = `
                            <p class="text-sm text-center text-gray-400 mb-4">Transfer funds to your personal SpaceVest account below to top up your wallet.</p>
                            <div class="space-y-3 p-4 bg-gray-800 rounded-lg text-left">
                                <div><p class="text-xs text-gray-400">Bank Name</p><p class="font-semibold">${data.bank_name}</p></div>
                                <div><p class="text-xs text-gray-400">Account Number</p>
                                    <div class="flex justify-between items-center">
                                        <p class="font-semibold text-lg">${data.account_number}</p>
                                        <button id="copy-account-btn" class="text-yellow-400"><i class="fas fa-copy"></i></button>
                                    </div>
                                </div>
                                <div><p class="text-xs text-gray-400">Account Name</p><p class="font-semibold">${data.account_name}</p></div>
                            </div>
                            <div class="mt-4 text-center">
                                <p class="text-xs text-gray-400 mb-2">Account generated <span id="account-timer">just now</span></p>
                                <button id="confirm-payment-btn" class="submit-btn w-full p-3 rounded-lg font-bold">I have sent the money</button>
                            </div>
                        `;
                    } else {
                        // User doesn't have virtual account
                        content = `
                            <div class="text-center">
                                <p class="text-gray-400 mb-4">Generate a personal virtual account to add funds to your wallet.</p>
                                <button id="generate-va-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Generate Account</button>
                            </div>
                        `;
                    }

                    modalContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                            <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="add-funds-alert" class="hidden"></div>
                        ${content}
                    `;

                    // Add event listeners
                    setupAddFundsModalEvents();

                } catch (error) {
                    console.error('Error loading virtual account:', error);
                    modalContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                            <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="text-center py-8">
                            <p class="text-red-400 mb-4">Failed to load account details. Please try again.</p>
                            <button id="retry-load-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Retry</button>
                        </div>
                    `;

                    document.getElementById('retry-load-btn').addEventListener('click', () => showAddFundsModal());
                    document.getElementById('close-add-funds').addEventListener('click', () => modal.classList.add('hidden'));
                }
            }

            function setupAddFundsModalEvents() {
                const modal = document.getElementById('add-funds-modal');
                const closeBtn = document.getElementById('close-add-funds');
                const generateBtn = document.getElementById('generate-va-btn');
                const copyBtn = document.getElementById('copy-account-btn');
                const confirmBtn = document.getElementById('confirm-payment-btn');

                // Close modal
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
                }

                // Generate virtual account
                if (generateBtn) {
                    generateBtn.addEventListener('click', handleGenerateVirtualAccount);
                }

                // Copy account number
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        const accountNumber = copyBtn.previousElementSibling.textContent;
                        navigator.clipboard.writeText(accountNumber).then(() => {
                            copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            }, 2000);
                        });
                    });
                }

                // Confirm payment sent
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', handleConfirmPayment);
                }

                // Start timer if account exists
                if (confirmBtn) {
                    startAccountTimer();
                }
            }

            async function handleGenerateVirtualAccount() {
                const button = document.getElementById('generate-va-btn');
                const alertDiv = document.getElementById('add-funds-alert');

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                try {
                    const response = await fetch('/api/users/virtual-account/generate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Refresh the modal to show the generated account
                        await showAddFundsModal();
                    } else {
                        alertDiv.textContent = data.error || 'Failed to generate virtual account';
                        alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                        alertDiv.classList.remove('hidden');
                        button.disabled = false;
                        button.innerHTML = 'Generate Account';
                    }
                } catch (error) {
                    alertDiv.textContent = 'Network error: ' + error.message;
                    alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                    alertDiv.classList.remove('hidden');
                    button.disabled = false;
                    button.innerHTML = 'Generate Account';
                }
            }

            async function handleConfirmPayment() {
                const button = document.getElementById('confirm-payment-btn');
                const alertDiv = document.getElementById('add-funds-alert');

                // Show amount input modal
                const amount = prompt('Enter the amount you sent (₦):');
                if (!amount) return;

                const amountFloat = parseFloat(amount);
                if (isNaN(amountFloat) || amountFloat <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                try {
                    const response = await fetch('/api/users/virtual-account/confirm-payment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ amount: amountFloat })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alertDiv.textContent = data.message;
                        alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-green-500/20 text-green-300';
                        alertDiv.classList.remove('hidden');

                        // Refresh wallet balance
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        alertDiv.textContent = data.error || 'Failed to confirm payment';
                        alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                        alertDiv.classList.remove('hidden');
                        button.disabled = false;
                        button.innerHTML = 'I have sent the money';
                    }
                } catch (error) {
                    alertDiv.textContent = 'Network error: ' + error.message;
                    alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                    alertDiv.classList.remove('hidden');
                    button.disabled = false;
                    button.innerHTML = 'I have sent the money';
                }
            }

            function startAccountTimer() {
                const timerElement = document.getElementById('account-timer');
                if (!timerElement) return;

                let seconds = 0;
                const updateTimer = () => {
                    seconds++;
                    if (seconds < 60) {
                        timerElement.textContent = `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
                    } else if (seconds < 3600) {
                        const minutes = Math.floor(seconds / 60);
                        timerElement.textContent = `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                    } else {
                        const hours = Math.floor(seconds / 3600);
                        timerElement.textContent = `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                    }
                };

                setInterval(updateTimer, 1000);
            }


            

            // Function to add funds to wallet
            async function addFundsToWallet(amount, description, reference) {
                try {
                    const response = await fetch('/api/transactions/add-funds/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({
                            amount: amount,
                            description: description,
                            reference: reference,
                            metadata: {
                                payment_gateway: 'paystack',
                                timestamp: new Date().toISOString()
                            }
                        })
                    });

                    if (response.ok) {
                        console.log('Funds added to wallet successfully');
                        return true;
                    } else {
                        let errorData = {};
                        try {
                            errorData = await response.json();
                            console.error('Failed to add funds:', errorData);
                        } catch (jsonError) {
                            console.error('Failed to parse error response:', jsonError);
                            // If we can't parse JSON, try to get text response
                            const errorText = await response.text();
                            throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 100)}`);
                        }
                        
                        // Provide more specific error messages
                        if (response.status === 400) {
                            throw new Error(errorData.error || 'Invalid request. Please try again.');
                        } else if (response.status === 401) {
                            throw new Error('Authentication failed. Please log in again.');
                        } else if (response.status === 403) {
                            throw new Error('Permission denied. Please contact support.');
                        } else {
                            throw new Error(errorData.error || 'Server error. Please try again later.');
                        }
                    }
                } catch (error) {
                    console.error('Error adding funds to wallet:', error);
                    throw error; // Re-throw to be caught by the caller
                }
            }

            // CSRF Token function
            function getCsrfToken() {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
                return cookieValue || '';
            }

            // Hide loader when page is loaded
            loader.style.display = 'none';

            // Show app page by default and ensure navigation is visible
            showPage('app');
            bottomNav.classList.remove('hidden');
            chatBtn.classList.remove('hidden');
            // fetchUserData(userId); // Commented out Firebase call

            // Modal management functions
            function showAlert(_, message, type = 'error') {
                console.log(`Showing alert: ${message}`);
                
                // Remove any existing alerts first
                const existingAlerts = document.querySelectorAll('.global-alert');
                existingAlerts.forEach(alert => alert.remove());
                
                // Create new alert element
                const alertEl = document.createElement('div');
                alertEl.className = `global-alert fixed top-4 left-1/2 transform -translate-x-1/2 z-[9999] px-6 py-3 rounded-lg shadow-xl transition-all duration-300 ${
                    type === 'error' 
                        ? 'bg-red-500 text-white' 
                        : 'bg-green-500 text-white'
                } font-medium text-center whitespace-nowrap`;
                
                alertEl.textContent = message;
                document.body.appendChild(alertEl);
                
                // Force reflow to enable transition
                void alertEl.offsetWidth;
                alertEl.style.opacity = '1';
                
                // Auto-hide after delay
                const timeout = setTimeout(() => {
                    alertEl.style.opacity = '0';
                    setTimeout(() => {
                        alertEl.remove();
                    }, 300);
                }, 5000);
                
                // Click to dismiss
                alertEl.onclick = () => {
                    clearTimeout(timeout);
                    alertEl.style.opacity = '0';
                    setTimeout(() => {
                        alertEl.remove();
                    }, 300);
                };
            }

            // Withdraw modal
            const closeWithdrawBtn = document.getElementById('close-withdraw');
            const withdrawForm = document.getElementById('withdraw-form');

            closeWithdrawBtn.addEventListener('click', () => withdrawModal.classList.add('hidden'));

            withdrawForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('withdraw-amount').value);

                if (isNaN(amount) || amount <= 0) {
                    showAlert('withdraw-alert', 'Invalid amount.');
                    return;
                }

                if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                    showAlert('withdraw-alert', 'Insufficient funds.');
                    return;
                }

                try {
                    const response = await fetch('/api/transactions/withdraw/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ amount: amount })
                    });

                    if (response.ok) {
                        showAlert('withdraw-alert', 'Withdrawal initiated successfully!', 'success');
                        withdrawForm.reset();
                        setTimeout(() => {
                            withdrawModal.classList.add('hidden');
                            window.location.reload();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        showAlert('withdraw-alert', errorData.error || 'Withdrawal failed.');
                    }
                } catch (error) {
                    showAlert('withdraw-alert', 'Network error: ' + error.message);
                }
            });

            // Transfer modal
            const closeTransferBtn = document.getElementById('close-transfer');
            const transferUserForm = document.getElementById('transfer-user-form');
            const transferBankForm = document.getElementById('transfer-bank-form');
            const tabUser = document.getElementById('tab-user');
            const tabBank = document.getElementById('tab-bank');
            const contentUser = document.getElementById('content-user');
            const contentBank = document.getElementById('content-bank');

            closeTransferBtn.addEventListener('click', () => transferModal.classList.add('hidden'));

            tabUser.addEventListener('click', () => {
                tabUser.classList.add('active');
                tabBank.classList.remove('active');
                contentUser.classList.remove('hidden');
                contentBank.classList.add('hidden');
            });

            tabBank.addEventListener('click', () => {
                tabBank.classList.add('active');
                tabUser.classList.remove('active');
                contentBank.classList.remove('hidden');
                contentUser.classList.add('hidden');
            });

            transferUserForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const recipientEmail = document.getElementById('transfer-email').value;
                const amount = parseFloat(document.getElementById('transfer-user-amount').value);

                if (recipientEmail === '{{ user.email }}') {
                    showAlert('transfer-alert', 'You cannot transfer to yourself.');
                    return;
                }

                if (isNaN(amount) || amount <= 0) {
                    showAlert('transfer-alert', 'Invalid amount.');
                    return;
                }

                if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                    showAlert('transfer-alert', 'Insufficient funds.');
                    return;
                }

                try {
                    const response = await fetch('/api/transactions/transfer/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({
                            recipient_email: recipientEmail,
                            amount: amount,
                            type: 'user'
                        })
                    });

                    if (response.ok) {
                        showAlert('transfer-alert', 'Transfer successful!', 'success');
                        transferUserForm.reset();
                        setTimeout(() => {
                            transferModal.classList.add('hidden');
                            window.location.reload();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        showAlert('transfer-alert', errorData.error || 'Transfer failed.');
                    }
                } catch (error) {
                    showAlert('transfer-alert', 'Network error: ' + error.message);
                }
            });

            // Only add event listener if the form exists
            if (transferBankForm) {
                transferBankForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const amount = parseFloat(document.getElementById('transfer-bank-amount').value);

                    if (isNaN(amount) || amount <= 0) {
                        showAlert('transfer-alert', 'Invalid amount.');
                        return;
                    }

                    if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                        showAlert('transfer-alert', 'Insufficient funds.');
                        return;
                    }

                    try {
                        const response = await fetch('/api/transactions/transfer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken(),
                            },
                            body: JSON.stringify({
                                amount: amount,
                                type: 'bank'
                            })
                        });

                        if (response.ok) {
                            showAlert('transfer-alert', 'Bank transfer initiated successfully!', 'success');
                            transferBankForm.reset();
                            setTimeout(() => {
                                transferModal.classList.add('hidden');
                                window.location.reload();
                            }, 2000);
                        } else {
                            const errorData = await response.json();
                            showAlert('transfer-alert', errorData.error || 'Transfer failed.');
                        }
                    } catch (error) {
                        showAlert('transfer-alert', 'Network error: ' + error.message);
                    }
                });
            }

            // Sell crypto modal
            const closeSellCryptoBtn = document.getElementById('close-sell-crypto');
            const sellCryptoForm = document.getElementById('sell-crypto-form');
            const cryptoSelect = document.getElementById('crypto-select');

            // Close sell crypto modal
            closeSellCryptoBtn.addEventListener('click', function() {
                sellCryptoModal.classList.add('hidden');
            });

            // Close top-up modal (handled in the new card-based flow section below)

           
            // closeSellCryptoBtn.addEventListener('click', () => sellCryptoModal.classList.add('hidden'));

            cryptoSelect.addEventListener('change', function() {
                const cryptoId = this.value;
                const rateDisplay = document.getElementById('admin-rate-display');
                // For now, use a default rate. In production, fetch from backend
                const rates = {
                    'bitcoin': 1520,
                    'ethereum': 1520,
                    'tether': 1520
                };
                rateDisplay.textContent = cryptoId ? `₦${rates[cryptoId] || 0}/$` : '₦0.00/$';
            });

            sellCryptoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const cryptoId = cryptoSelect.value;
                const amountUSD = document.getElementById('crypto-amount-usd').value;

                if (!cryptoId) {
                    showAlert('sell-crypto-alert', 'Please select a cryptocurrency.');
                    return;
                }

                if (!amountUSD || parseFloat(amountUSD) <= 0) {
                    showAlert('sell-crypto-alert', 'Please enter a valid amount.');
                    return;
                }

                const phoneNumber = "2347066718413"; // Replace with actual support number
                const message = `Hello, I want to sell ${amountUSD} USD of ${cryptoSelect.options[cryptoSelect.selectedIndex].text} at your rate.`;
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

                window.open(whatsappUrl, '_blank');
                sellCryptoModal.classList.add('hidden');
            });

            // Top-up modal - Card-based flow variables
            const tabAirtime = document.getElementById('tab-airtime');
            const tabData = document.getElementById('tab-data');

            // Removed old airtimeForm and dataForm event listeners as they are not used in the new card-based flow



            // Top-up modal - New card-based flow
            console.log('Initializing top-up modal elements...');
            const proceedServiceBtn = document.getElementById('proceed-service');
            const phoneForm = document.getElementById('phone-form');
            const confirmPurchaseBtn = document.getElementById('confirm-purchase');
            const closeTopUpBtn = document.getElementById('close-top-up');

            console.log('Top-up modal elements found:');
            console.log('- proceedServiceBtn:', !!proceedServiceBtn);
            console.log('- phoneForm:', !!phoneForm);
            console.log('- confirmPurchaseBtn:', !!confirmPurchaseBtn);
            console.log('- closeTopUpBtn:', !!closeTopUpBtn);

            // Step elements
            const stepServiceType = document.getElementById('step-service-type');
            const stepNetwork = document.getElementById('step-network');
            const stepPlan = document.getElementById('step-plan');
            const stepPhone = document.getElementById('step-phone');
            const stepSummary = document.getElementById('step-summary');

            console.log('Step elements found:');
            console.log('- stepServiceType:', !!stepServiceType);
            console.log('- stepNetwork:', !!stepNetwork);
            console.log('- stepPlan:', !!stepPlan);
            console.log('- stepPhone:', !!stepPhone);
            console.log('- stepSummary:', !!stepSummary);

            // Navigation buttons
            const backToServiceBtn = document.getElementById('back-to-service');
            const backToNetworkBtn = document.getElementById('back-to-network');
            const backToPlanBtn = document.getElementById('back-to-plan');
            const backToPhoneBtn = document.getElementById('back-to-phone');

            console.log('Navigation buttons found:');
            console.log('- backToServiceBtn:', !!backToServiceBtn);
            console.log('- backToNetworkBtn:', !!backToNetworkBtn);
            console.log('- backToPlanBtn:', !!backToPlanBtn);
            console.log('- backToPhoneBtn:', !!backToPhoneBtn);

            // Global variables for selected items
            let selectedServiceType = 'airtime';
            let selectedNetwork = null;
            let selectedPlan = null;
            let selectedPhone = null;
            let verifiedBankData = null;
            let verifiedBvnData = null;
            
            // Initialize global variables
            window.dbRates = window.dbRates || {};
            window.liveCryptoRates = window.liveCryptoRates || {};

            // Helper functions (defined before use)
            function showStep(step) {
                // Hide all steps
                stepServiceType.classList.add('hidden');
                stepNetwork.classList.add('hidden');
                stepPlan.classList.add('hidden');
                stepPhone.classList.add('hidden');
                stepSummary.classList.add('hidden');

                // Show selected step
                switch(step) {
                    case 'service-type':
                        stepServiceType.classList.remove('hidden');
                        break;
                    case 'network':
                        stepNetwork.classList.remove('hidden');
                        break;
                    case 'plan':
                        stepPlan.classList.remove('hidden');
                        break;
                    case 'phone':
                        stepPhone.classList.remove('hidden');
                        break;
                    case 'summary':
                        stepSummary.classList.remove('hidden');
                        break;
                }
            }

            // Loading state management
            function showLoading(message = 'Loading...') {
                console.log('showLoading called with message:', message);
                const alertEl = document.getElementById('top-up-alert');
                console.log('Alert element found:', !!alertEl);
                if (alertEl) {
                    alertEl.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${message}`;
                    alertEl.className = 'text-sm p-2 rounded-md my-2 bg-blue-500/20 text-blue-300';
                    alertEl.classList.remove('hidden');
                    console.log('Loading state shown successfully');
                } else {
                    console.error('Alert element not found!');
                }
            }

            function hideLoading() {
                console.log('hideLoading called');
                const alertEl = document.getElementById('top-up-alert');
                if (alertEl) {
                    alertEl.classList.add('hidden');
                    alertEl.innerHTML = '';
                    console.log('Loading state hidden successfully');
                } else {
                    console.error('Alert element not found for hiding!');
                }
            }

            function disableButtons(...buttonIds) {
                console.log('disableButtons called with IDs:', buttonIds);
                buttonIds.forEach(id => {
                    const btn = document.getElementById(id);
                    console.log(`Button ${id} found:`, !!btn);
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        console.log(`Button ${id} disabled successfully`);
                    } else {
                        console.error(`Button ${id} not found!`);
                    }
                });
            }

            function enableButtons(...buttonIds) {
                console.log('enableButtons called with IDs:', buttonIds);
                buttonIds.forEach(id => {
                    const btn = document.getElementById(id);
                    console.log(`Button ${id} found for enabling:`, !!btn);
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        console.log(`Button ${id} enabled successfully`);
                    } else {
                        console.error(`Button ${id} not found for enabling!`);
                    }
                });
            }

            function resetTopUpFlow() {
                selectedServiceType = 'airtime';
                selectedNetwork = null;
                selectedPlan = null;
                selectedPhone = null;
                showStep('service-type');
                tabAirtime.classList.add('active');
                tabData.classList.remove('active');
                document.getElementById('phone-form').reset();
            }

            if (closeTopUpBtn) {
                closeTopUpBtn.addEventListener('click', () => {
                    topUpModal.classList.add('hidden');
                    resetTopUpFlow();
                });
            }

            // Service type selection - Add null checks
            if (tabAirtime) {
                tabAirtime.addEventListener('click', () => {
                    tabAirtime.classList.add('active');
                    if (tabData) tabData.classList.remove('active');
                    selectedServiceType = 'airtime';
                    console.log('Selected service type: airtime');
                });
            }

            if (tabData) {
                tabData.addEventListener('click', () => {
                    tabData.classList.add('active');
                    if (tabAirtime) tabAirtime.classList.remove('active');
                    selectedServiceType = 'data_bundle';
                    console.log('Selected service type: data_bundle');
                });
            }

            // Proceed to network selection - Add null check
            if (proceedServiceBtn) {
                proceedServiceBtn.addEventListener('click', () => {
                    console.log('Continue button clicked, selectedServiceType:', selectedServiceType);
                    if (!selectedServiceType) {
                        showAlert('top-up-alert', 'Please select airtime or data first.');
                        return;
                    }
                    console.log('Proceeding to network step...');
                    showStep('network');
                    loadNetworks();
                    disableButtons('proceed-service');
                });
            } else {
                console.error('proceedServiceBtn not found!');
            }

            // Navigation - Add null checks to prevent errors
            if (backToServiceBtn) backToServiceBtn.addEventListener('click', () => showStep('service-type'));
            if (backToNetworkBtn) backToNetworkBtn.addEventListener('click', () => showStep('network'));
            if (backToPlanBtn) backToPlanBtn.addEventListener('click', () => showStep('plan'));
            if (backToPhoneBtn) backToPhoneBtn.addEventListener('click', () => showStep('phone'));

            // Load networks
            async function loadNetworks() {
                console.log('Loading networks for service type:', selectedServiceType);
                showLoading('Loading networks...');
                disableButtons('proceed-service', 'back-to-service');

                try {
                    const url = `/api/transactions/billers/${selectedServiceType}/`;
                    console.log('Fetching from URL:', url);

                    const response = await fetch(url, {
                        headers: { 'X-CSRFToken': getCsrfToken() }
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Received data:', data);

                        if (data.billers && data.billers.length > 0) {
                            displayNetworkCards(data.billers);
                            hideLoading();
                        } else {
                            console.log('No billers found in response');
                            hideLoading();
                            showAlert('top-up-alert', 'No networks found for selected service.');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.log('Error response:', errorData);
                        hideLoading();
                        showAlert('top-up-alert', errorData.error || 'Failed to load networks. Please try again later.');
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    hideLoading();
                    showAlert('top-up-alert', 'Network error: ' + error.message);
                } finally {
                    enableButtons('proceed-service', 'back-to-service');
                }
            }

            // Display network cards
            function displayNetworkCards(billers) {
                const networkCards = document.getElementById('network-cards');
                networkCards.innerHTML = '';

                billers.forEach(biller => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-center';
                    card.innerHTML = `
                        <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-mobile-alt text-blue-400"></i>
                        </div>
                        <p class="font-semibold text-sm">${biller.name}</p>
                    `;
                    card.addEventListener('click', () => {
                        console.log('Network selected:', biller.name);
                        selectedNetwork = biller;
                        console.log('Moving to plan step...');
                        showStep('plan');
                        loadPlans(biller.code);
                    });
                    networkCards.appendChild(card);
                });
            }

            // Load plans for selected network
            async function loadPlans(billerCode) {
                showLoading('Loading plans...');
                disableButtons('back-to-network');

                try {
                    const response = await fetch(`/api/transactions/products/${billerCode}/`, {
                        headers: { 'X-CSRFToken': getCsrfToken() }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.products && data.products.length > 0) {
                            displayPlanCards(data.products);
                            hideLoading();
                        } else {
                            // No predefined products - show amount input for airtime
                            displayAmountInput();
                            hideLoading();
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        hideLoading();
                        showAlert('top-up-alert', errorData.error || 'Failed to load plans. Please try again later.');
                    }
                } catch (error) {
                    hideLoading();
                    showAlert('top-up-alert', 'Network error: ' + error.message);
                } finally {
                    enableButtons('back-to-network');
                }
            }

            // Display plan cards
            function displayPlanCards(products) {
                const planCards = document.getElementById('plan-cards');
                planCards.innerHTML = '';

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-semibold text-sm">${product.name}</h5>
                                <p class="text-gray-400 text-xs mt-1">₦${product.amount.toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-green-400 text-xs"></i>
                                </div>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        console.log('Plan selected:', product.name, 'Amount:', product.amount);
                        selectedPlan = product;
                        console.log('Moving to phone step...');
                        showStep('phone');
                    });
                    planCards.appendChild(card);
                });
            }

            // Display amount input for airtime (when no predefined products)
            function displayAmountInput() {
                const planCards = document.getElementById('plan-cards');
                planCards.innerHTML = '';

                const amountInputDiv = document.createElement('div');
                amountInputDiv.className = 'bg-gray-800 p-4 rounded-lg';
                amountInputDiv.innerHTML = `
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Enter Amount (₦)</label>
                        <input type="number" id="custom-amount" class="form-input w-full p-3 rounded-lg" placeholder="Enter amount" min="50" max="100000" required>
                        <p class="text-xs text-gray-500 mt-2">Minimum: ₦50, Maximum: ₦100,000</p>
                    </div>
                    <button id="proceed-with-amount" class="submit-btn w-full p-4 rounded-lg font-bold text-lg mt-4" type="button">
                        Continue
                    </button>
                `;
                planCards.appendChild(amountInputDiv);

                // Add event listener for the proceed button
                document.getElementById('proceed-with-amount').addEventListener('click', () => {
                    const amount = parseFloat(document.getElementById('custom-amount').value);
                    if (isNaN(amount) || amount < 50 || amount > 100000) {
                        showAlert('top-up-alert', 'Please enter a valid amount between ₦50 and ₦100,000.');
                        return;
                    }
                    selectedPlan = {
                        code: null, // No product code for custom airtime
                        name: `₦${amount.toLocaleString()} Airtime`,
                        amount: amount,
                        isCustom: true // Flag to indicate custom amount
                    };
                    showStep('phone');
                });
            }

            // Phone form submission - Add null check
            if (phoneForm) {
                phoneForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    console.log('Phone form submitted');
                    const phone = document.getElementById('phone-number').value;
                    console.log('Phone number entered:', phone);

                    if (!/^\d{11}$/.test(phone)) {
                        console.log('Invalid phone number format');
                        showAlert('top-up-alert', 'Invalid phone number (must be 11 digits).');
                        return;
                    }

                    console.log('Phone number valid, proceeding to summary...');
                    selectedPhone = phone;
                    console.log('Selected data before summary:', {
                        selectedServiceType,
                        selectedNetwork,
                        selectedPlan,
                        selectedPhone
                    });
                    showStep('summary');
                    displaySummary();
                });
            } else {
                console.error('phoneForm element not found!');
            }

            // Display purchase summary
            function displaySummary() {
                const summaryDiv = document.getElementById('purchase-summary');
                if (!summaryDiv) {
                    console.error('Purchase summary div not found');
                    return;
                }
                
                if (!selectedNetwork || !selectedPlan || !selectedPhone) {
                    console.error('Missing required data for summary:', {
                        selectedNetwork,
                        selectedPlan,
                        selectedPhone
                    });
                    return;
                }
                
                summaryDiv.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-400">Service:</span>
                        <span class="font-semibold">${selectedServiceType === 'airtime' ? 'Airtime' : 'Data'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Network:</span>
                        <span class="font-semibold">${selectedNetwork.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Plan:</span>
                        <span class="font-semibold">${selectedPlan.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Phone:</span>
                        <span class="font-semibold">${selectedPhone}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-yellow-400 border-t border-gray-600 pt-2 mt-2">
                        <span>Total:</span>
                        <span>₦${selectedPlan.amount.toLocaleString()}</span>
                    </div>
                `;
            }

            // Confirm purchase - Add null check
            console.log('Setting up confirm purchase button event listener');
            if (confirmPurchaseBtn) {
                confirmPurchaseBtn.addEventListener('click', async () => {
                console.log('Confirm purchase button clicked!');
                console.log('selectedServiceType:', selectedServiceType);
                console.log('selectedNetwork:', selectedNetwork);
                console.log('selectedPlan:', selectedPlan);
                console.log('selectedPhone:', selectedPhone);

                const amount = selectedPlan.amount;
                console.log('Amount:', amount);
                console.log('Wallet balance:', '{{ user.wallet_balance|default:0 }}');

                if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                    console.log('Insufficient funds detected');
                    showError('Insufficient funds.');
                    return;
                }

                // Prepare payload according to serializers in backend
                const payload = {
                    type: selectedServiceType === 'airtime' ? 'airtime' : 'data',
                    phone_number: selectedPhone,
                    network: selectedNetwork.code,
                    amount: amount
                };

                // Only add product_code if it's not null (for predefined plans)
                if (selectedPlan.code && !selectedPlan.isCustom) {
                    payload.product_code = selectedPlan.code;
                }

                // Add service-specific fields
                if (selectedServiceType === 'airtime') {
                    payload.plan_name = selectedPlan.name;
                } else {
                    payload.data_plan = selectedPlan.name;
                }

                console.log('Final payload:', payload);
                console.log('Calling showLoading function...');
                showLoading('Processing purchase...');
                console.log('Calling disableButtons function...');
                disableButtons('confirm-purchase', 'back-to-phone');

                try {
                    console.log('Making API call to /api/transactions/top-up/');
                    const response = await fetch('/api/transactions/top-up/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify(payload)
                    });

                    console.log('API response received:', response.status, response.ok);

                    if (response.ok) {
                        console.log('Purchase successful');
                        hideLoading();
                        showAlert('top-up-alert', `Successfully purchased ${selectedPlan.name}!`, 'success');
                        setTimeout(() => {
                            topUpModal.classList.add('hidden');
                            resetTopUpFlow();
                            window.location.reload();
                        }, 2000);
                    } else {
                        try {
                            const errorText = await response.text();
                            let errorMessage = 'Purchase failed. Please try again.';
                            
                            try {
                                const errorData = JSON.parse(errorText);
                                console.error('Purchase failed with error:', errorData);
                                // Try to extract the most specific error message
                                errorMessage = errorData.message || 
                                            errorData.error || 
                                            (errorData.data && errorData.data.message) || 
                                            errorMessage;
                            } catch (parseError) {
                                console.error('Failed to parse error response as JSON, using raw text');
                                // If it's not valid JSON, try to extract a clean message
                                const match = errorText.match(/"message":"([^"]+)"/);
                                errorMessage = match ? match[1] : errorText;
                            }
                            
                            console.log('Displaying error to user:', errorMessage);
                            showAlert('top-up-alert', errorMessage, 'error');
                        } catch (error) {
                            console.error('Error processing error response:', error);
                            showAlert('top-up-alert', 'An unexpected error occurred. Please try again.', 'error');
                        } finally {
                            hideLoading();
                        }
                    }
                } catch (error) {
                    console.log('Network error occurred:', error);
                    hideLoading();
                    showAlert('top-up-alert', 'Network error: ' + error.message);
                } finally {
                    console.log('Re-enabling buttons');
                    enableButtons('confirm-purchase', 'back-to-phone');
                }
                });
            }

            // Helper functions are now defined earlier in the code


            // --- Admin & Chat Logic ---
            function showAdminPage() {
                const isSuperuser = "{{ user.is_superuser|yesno:'true,false' }}" === 'true';
                if (!appReady || !isSuperuser) {
                    showError("You do not have permission to view this page.");
                    return showPage('app'); // Redirect non-admins
                }
                showPage('admin');
                loadUsersForAdmin();
                loadRatesForAdmin();
                loadActiveChats();
            }

            function loadUsersForAdmin() {
                const userListEl = document.getElementById('user-list-admin');
                // Commented out Firebase call - using Django instead
                // onSnapshot(collection(db, "users"), (snapshot) => {
                //     userListEl.innerHTML = '';
                //     snapshot.forEach(doc => {
                //         const user = doc.data();
                //         const userEl = document.createElement('div');
                //         userEl.className = 'p-2 bg-gray-700 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600';
                //         userEl.innerHTML = `<span>${user.email}</span> <span class="text-xs">${user.role || 'user'}</span>`;
                //         userEl.onclick = () => showUserDetailsModal(user);
                //         userListEl.appendChild(userEl);
                //     });
                // });
                userListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Admin user list not available.</p>';
            }

            function showUserDetailsModal(userData) {
                const bankDetailsHTML = userData.bankDetails ? `
                    <div class="mt-4 pt-3 border-t border-gray-600">
                        <p class="text-sm text-gray-400">Bank Details</p>
                        <p>${userData.bankDetails.accountName}</p>
                        <p>${userData.bankDetails.bankName} - ${userData.bankDetails.accountNumber}</p>
                    </div>
                ` : `<p class="mt-4 pt-3 border-t border-gray-600 text-sm text-gray-400">No bank account added.</p>`;

                const modalHTML = `
                <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">User Details</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                    <div class="space-y-3 text-left">
                        <div><p class="text-sm text-gray-400">Full Name</p><p>${userData.fullname || 'N/A'}</p></div>
                        <div><p class="text-sm text-gray-400">Username</p><p>${userData.username}</p></div>
                        <div><p class="text-sm text-gray-400">Email</p><p>${userData.email}</p></div>
                        <div><p class="text-sm text-gray-400">Phone</p><p>${userData.phone}</p></div>
                        <div><p class="text-sm text-gray-400">KYC Verified</p><p>${userData.kycVerified ? 'Yes' : 'No'}</p></div>
                        ${bankDetailsHTML}
                    </div>
                </div>`;
                showModal(modalHTML);
            }

            function loadRatesForAdmin() {
                const ratesListEl = document.getElementById('rates-list-admin');
                const cryptoSelect = document.getElementById('rate-crypto-select-admin');
                const rateInput = document.getElementById('rate-ngn-admin');

                // Commented out Firebase call - using Django instead
                // onSnapshot(collection(db, "rates"), (snapshot) => {
                //     ratesListEl.innerHTML = '';
                //     snapshot.forEach(doc => {
                //         const rate = doc.data();
                //         const rateEl = document.createElement('div');
                //         rateEl.className = 'p-2 bg-gray-700 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600';
                //         rateEl.innerHTML = `<span>${rate.name}</span> <span>₦${rate.nairaRate}/$</span>`;
                //         rateEl.onclick = () => {
                //             cryptoSelect.value = doc.id;
                //             rateInput.value = rate.nairaRate;
                //         };
                //         ratesListEl.appendChild(rateEl);
                //     });
                // });
                ratesListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Admin rates list not available.</p>';
            }

            document.getElementById('rate-form-admin').addEventListener('submit', async (e) => {
                e.preventDefault();
                const cryptoId = document.getElementById('rate-crypto-select-admin').value;
                const nairaRate = document.getElementById('rate-ngn-admin').value;

                if (!cryptoId || !nairaRate) {
                    return showError("Please select a crypto and enter a rate.");
                }

                // Commented out Firebase call - using Django instead
                // try {
                //     const updateRateFunction = httpsCallable(functions, 'updateRate');
                //     const result = await updateRateFunction({ cryptoId, nairaRate });
                //     showError(result.data.message); // Using showError for success message as well
                //     e.target.reset();
                // } catch(error) {
                //     showError(error.message);
                // }
                // showError("Rate update not available.");
            });


            function loadActiveChats() {
                // Commented out Firebase call - using Django instead
                // if (unsubscribeChats) unsubscribeChats();
                // const chatsRef = collection(db, "active_chats");
                // const q = query(chatsRef, orderBy("timestamp", "desc"));
                const container = document.getElementById('support-chats-admin');
                const adminBadge = document.getElementById('admin-notification-badge');

                // unsubscribeChats = onSnapshot(q, (snapshot) => {
                //     container.innerHTML = '';
                //     let hasUnread = false;
                //     if (snapshot.empty) {
                //         container.innerHTML = '<p class="text-gray-400 text-sm text-center">No active chats.</p>';
                //         return;
                //     }
                //     snapshot.forEach(doc => {
                //         const chat = doc.data();
                //         if(chat.unreadByAdmin) hasUnread = true;
                //         const chatEl = document.createElement('div');
                //         chatEl.className = 'p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 flex justify-between items-center';
                //         chatEl.innerHTML = `
                //             <div>
                //                 <p class="font-bold text-sm">${chat.userEmail}</p>
                //                 <p class="text-xs text-gray-400 truncate">${chat.lastMessage}</p>
                //             </div>
                //             ${chat.unreadByAdmin ? '<div class="w-3 h-3 bg-red-500 rounded-full"></div>' : ''}
                //         `;
                //         chatEl.onclick = () => showChatModalForUser(doc.id, chat.userEmail);
                //         container.appendChild(chatEl);
                //     });
                //     adminBadge.classList.toggle('hidden', !hasUnread);
                // });
                container.innerHTML = '<p class="text-gray-400 text-sm text-center">Active chats not available.</p>';
                adminBadge.classList.add('hidden');
            }

            function listenForChatNotifications(userId) {
                // Commented out Firebase call - using Django instead
                // const chatRef = doc(db, "active_chats", userId);
                // onSnapshot(chatRef, (doc) => {
                //     const chatNotificationBadge = document.getElementById('chat-notification-badge');
                //     if (doc.exists() && doc.data().unreadByUser) {
                //         chatNotificationBadge.classList.remove('hidden');
                //     } else {
                //         chatNotificationBadge.classList.add('hidden');
                //     }
                // });
                // For now, hide the badge
                const chatNotificationBadge = document.getElementById('chat-notification-badge');
                if (chatNotificationBadge) chatNotificationBadge.classList.add('hidden');
            }

            function showChatModalForUser(userId, userEmail) {
                // Commented out Firebase chat functionality - using Django instead
                // If called from user side, userId is an event object.
                // const isUser = typeof userId === 'object';
                // const currentUserId = isUser ? auth.currentUser.uid : userId;
                // const chatPartnerName = isUser ? "Support" : userEmail;
                // const senderId = isUser ? currentUserId : 'admin';

                const modalHTML = `
                    <div class="modal-content w-full h-full max-w-sm flex flex-col">
                        <div class="flex justify-between items-center p-4 border-b border-gray-600">
                            <h3 class="text-xl font-bold">Chat Support</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col">
                            <p class="text-center text-gray-400">Chat functionality is currently unavailable.</p>
                        </div>
                        <div class="p-4 border-t border-gray-600">
                            <div class="flex gap-2">
                                <input type="text" placeholder="Type your message..." class="form-input flex-1 p-2 rounded-lg" disabled>
                                <button class="submit-btn px-4 py-2 rounded-lg" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                showModal(modalHTML);
            }

            if (chatBtn) {

            async function changeUserPassword(e) {
                e.preventDefault();
                const newPassword = document.getElementById('change-password-input').value;
                if (newPassword.length < 6) {
                    return showModalAlert("Password must be at least 6 characters.");
                }
                try {
                    // Django password change API call
                    const response = await fetch('/api/users/change-password/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ new_password: newPassword })
                    });
                    
                    if (response.ok) {
                        showModalAlert("Password updated successfully!", "success");
                        document.getElementById('change-password-form').reset();
                    } else {
                        const errorData = await response.json();
                        showModalAlert(errorData.error || "Error updating password.");
                    }
                } catch (error) {
                    console.error("Password change error:", error);
                    showModalAlert("Network error: " + error.message);
                }
            }

            async function updateSecuritySettings(settings) {
                try {
                    const response = await fetch('/api/users/security-settings/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify(settings)
                    });
                    
                    if (response.ok) {
                        // Update local user data
                        currentUserData.securitySettings = { ...currentUserData.securitySettings, ...settings };
                        console.log('Security settings updated successfully');
                    } else {
                        console.error('Failed to update security settings');
                    }
                } catch (error) {
                    console.error('Error updating security settings:', error);
                }
            }
            
            async function saveBankAccount() {
                if (!verifiedBankData) return;
                const button = document.getElementById('save-bank-btn-modal');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const response = await fetch('/api/users/bank-details/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify(verifiedBankData)
                    });
                    
                    if (response.ok) {
                        showModalAlert("Bank account saved successfully!", "success");
                        currentUserData.bankDetails = verifiedBankData;
                        setTimeout(() => {
                            const modal = document.querySelector('.fixed.inset-0');
                            if (modal) modal.remove();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        showModalAlert(errorData.error || "Could not save bank details. Please try again.");
                    }
                } catch (error) {
                    console.error("Error saving bank data:", error);
                    showModalAlert("Network error: " + error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Save Bank';
                }
            }


            async function verifyBankAccount(e) {
                e.preventDefault();
                const accountNumber = document.getElementById('account-number-modal').value;
                const bankCode = document.getElementById('bank-list-modal').value;
                const button = document.getElementById('verify-account-btn-modal');

                if (!accountNumber || !bankCode) {
                    return showModalAlert("Please select a bank and enter an account number.");
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

                try {
                    const response = await fetch('/api/users/verify-bank-account/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ account_number: accountNumber, bank_code: bankCode })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.status) {
                        verifiedBankData = {
                            accountName: result.data.account_name,
                            accountNumber: result.data.account_number,
                            bankCode: bankCode,
                            bankName: nigerianBanks.find(b => b.code === bankCode)?.name || 'Unknown Bank'
                        };
                        document.getElementById('account-name-modal').textContent = verifiedBankData.accountName;
                        document.getElementById('verification-result-modal').classList.remove('hidden');
                        document.getElementById('save-bank-btn-modal').addEventListener('click', saveBankAccount);
                    } else {
                        showModalAlert(result.message || "Could not verify account details.");
                    }
                } catch (error) {
                    console.error("Bank Verification Error:", error);
                    showModalAlert("Network error: " + error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Verify Account';
                }
            }

            async function verifyBvn(e) {
                e.preventDefault();
                const bvn = document.getElementById('bvn-input').value;
                const button = document.getElementById('verify-bvn-btn');
                
                if (!/^\d{11}$/.test(bvn)) {
                    return showModalAlert("Please enter a valid 11-digit BVN.");
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

                try {
                    const response = await fetch('/api/users/verify-bvn/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ bvn: bvn })
                    });
                    
                    const result = await response.json();

                    if (response.ok && result.status) {
                        verifiedBvnData = result.data;
                        document.getElementById('kyc-form').classList.add('hidden');
                        const detailsEl = document.getElementById('bvn-details-display');
                        detailsEl.innerHTML = `
                            <p><strong>First Name:</strong> ${verifiedBvnData.first_name}</p>
                            <p><strong>Last Name:</strong> ${verifiedBvnData.last_name}</p>
                            <p><strong>Date of Birth:</strong> ${verifiedBvnData.dob}</p>
                        `;
                        document.getElementById('kyc-verification-result').classList.remove('hidden');
                        document.getElementById('save-kyc-btn').addEventListener('click', saveKycData);
                    } else {
                        showModalAlert(result.message || "BVN could not be verified.");
                    }
                } catch (error) {
                    console.error("BVN Verification Error:", error);
                    showModalAlert("Network error: " + error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Verify BVN';
                }
            }

            async function saveKycData() {
                if (!verifiedBvnData) return;
                const button = document.getElementById('save-kyc-btn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const response = await fetch('/api/users/kyc-details/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({
                            kyc_verified: true,
                            kyc_details: verifiedBvnData
                        })
                    });
                    
                    if (response.ok) {
                        showModalAlert("KYC details saved successfully!", "success");
                        currentUserData.kycVerified = true;
                        currentUserData.kycDetails = verifiedBvnData;
                        setTimeout(() => {
                            const modal = document.querySelector('.fixed.inset-0');
                            if (modal) modal.remove();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        showModalAlert(errorData.error || "Could not save KYC data. Please try again.");
                    }
                } catch (error) {
                    console.error("Error saving KYC data:", error);
                    showModalAlert("Network error: " + error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Confirm & Save KYC';
                }
            }

            function populateBankList(selectElement) {
                selectElement.innerHTML = '<option value="">Select a bank</option>' + nigerianBanks.map(bank => `<option value="${bank.code}">${bank.name}</option>`).join('');
            }

            function updateBankDetailsDisplay(details, element) {
                if (details) {
                    element.innerHTML = `<div class="p-3 bg-gray-700 rounded-lg"><p class="font-bold">${details.accountName}</p><p class="text-sm">${details.bankName} - ${details.accountNumber}</p></div>`;
                } else {
                    element.innerHTML = `<p class="text-sm text-center text-gray-400">No bank account added.</p>`;
                }
            }

            // settings logic 
            function handleSettingsAction(action) {
                if (!appReady) {
                    showError("Data not loaded yet. Please wait a moment.");
                    return;
                }
                let modalHTML = '';
                switch(action) {
                    case 'personal_info':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Personal Information</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="space-y-3 text-left">
                                    <div><p class="text-sm text-gray-400">Username</p><p>${currentUserData.username}</p></div>
                                    <div><p class="text-sm text-gray-400">Email</p><p>${currentUserData.email}</p></div>
                                    <div><p class="text-sm text-gray-400">Phone</p><p>${currentUserData.phone}</p></div>
                                    <div><p class="text-sm text-gray-400">Country</p><p>${currentUserData.country}</p></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'kyc_verification':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">KYC Verification</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                ${currentUserData.kycVerified ? `<div class="text-center text-green-400"><i class="fas fa-check-circle text-4xl mb-2"></i><p>Your account is verified.</p><div class="text-left text-sm mt-4 p-3 bg-gray-800 rounded-lg space-y-1"><p><strong>Name:</strong> ${currentUserData.kycDetails.first_name} ${currentUserData.kycDetails.last_name}</p><p><strong>DOB:</strong> ${currentUserData.kycDetails.dob}</p></div></div>` : `
                                <form id="kyc-form">
                                    <div class="mb-4"><label for="bvn-input" class="block text-sm font-medium text-gray-300 mb-1">Bank Verification Number (BVN)</label><input type="number" id="bvn-input" class="form-input w-full p-3 rounded-lg" required></div>
                                    <button type="submit" id="verify-bvn-btn" class="verify-btn w-full p-3 rounded-lg font-bold">Verify BVN</button>
                                </form>
                                <div id="kyc-verification-result" class="mt-4 text-left hidden">
                                    <p class="text-green-400 font-semibold mb-2">BVN Details Found:</p><div id="bvn-details-display" class="text-sm space-y-1 p-3 bg-gray-800 rounded-lg"></div>
                                    <button id="save-kyc-btn" class="submit-btn w-full p-3 mt-4 rounded-lg font-bold">Confirm & Save KYC</button>
                                </div>`}
                            </div>`;
                        showModal(modalHTML);
                        if (!currentUserData.kycVerified) {
                            document.getElementById('kyc-form').addEventListener('submit', verifyBvn);
                        }
                        break;
                    case 'badge':
                        const points = currentUserData.points || 0;
                        const level = Math.floor(points / 100);
                        const levelName = ["Rookie", "Trader", "Pro", "Veteran", "Legend"][level] || "Legend";
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl text-center">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Badge & Level</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <i class="fas fa-medal text-6xl text-yellow-400 mb-2"></i>
                                <h4 class="text-2xl font-bold">${levelName}</h4>
                                <p class="text-gray-400">Points: ${points}</p>
                                <p class="text-xs text-gray-500 mt-4">Earn 20 points for every crypto trade to level up!</p>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'security':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Security</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                <div class="space-y-4">
                                    <form id="change-password-form" class="space-y-2"><label for="change-password-input" class="block text-sm font-medium text-gray-300">New Password</label><input type="password" id="change-password-input" class="form-input w-full p-3 rounded-lg" required><button type="submit" class="verify-btn w-full p-2 mt-1 rounded-lg font-bold text-sm">Change Password</button></form>
                                    <div class="flex justify-between items-center"><p>Login with Face/Fingerprint</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="face-id-toggle" class="sr-only peer" ${currentUserData.securitySettings?.biometricsEnabled ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                    <div class="flex justify-between items-center"><p>Show Balance on Home</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="show-balance-toggle" class="sr-only peer" ${currentUserData.securitySettings?.showBalance ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                    <div class="flex justify-between items-center"><p>2FA Authentication</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="2fa-toggle" class="sr-only peer" ${currentUserData.securitySettings?.twoFactorEnabled ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        document.getElementById('change-password-form').addEventListener('submit', changeUserPassword);
                        document.getElementById('show-balance-toggle').addEventListener('change', (e) => updateSecuritySettings({ showBalance: e.target.checked }));
                        document.getElementById('face-id-toggle').addEventListener('change', (e) => updateSecuritySettings({ biometricsEnabled: e.target.checked }));
                        document.getElementById('2fa-toggle').addEventListener('change', (e) => updateSecuritySettings({ twoFactorEnabled: e.target.checked }));
                        break;
                    
                    // Handle bank account management
                    case 'bank_accounts':
                        // Load bank accounts for the user
                        async function loadBankAccounts() {
                            try {
                                const response = await fetch('/api/users/bank-accounts/');
                                if (!response.ok) throw new Error('Failed to load bank accounts');
                                const accounts = await response.json();
                                
                                const accountsList = document.createElement('div');
                                accountsList.className = 'space-y-4 mb-6';
                                
                                if (accounts.length === 0) {
                                    accountsList.innerHTML = '<p class="text-gray-400">No bank accounts added yet.</p>';
                                } else {
                                    accounts.forEach(account => {
                                        const accountEl = document.createElement('div');
                                        accountEl.className = 'p-4 bg-gray-800 rounded-lg';
                                        accountEl.innerHTML = `
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <p class="font-semibold">${account.account_name}</p>
                                                    <p class="text-gray-400 text-sm">${account.bank_name} ••••${account.account_number.slice(-4)}</p>
                                                </div>
                                                <div class="flex space-x-2">
                                                    <button class="text-blue-400 hover:text-blue-300" onclick="setPrimaryAccount(${account.id}, this)">
                                                        ${account.is_primary ? '✓ Primary' : 'Set as Primary'}
                                                    </button>
                                                    <button class="text-red-400 hover:text-red-300" onclick="deleteBankAccount(${account.id})">
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        `;
                                        accountsList.appendChild(accountEl);
                                    });
                                }
                                
                                const container = document.createElement('div');
                                container.className = 'modal-content w-11/12 max-w-md p-6 rounded-2xl';
                                container.innerHTML = `
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-xl font-bold">Bank Accounts</h3>
                                        <button class="close-modal-btn text-2xl">&times;</button>
                                    </div>
                                    <div id="bank-accounts-list"></div>
                                    <button id="add-bank-btn" class="w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold mt-4">
                                        + Add Bank Account
                                    </button>
                                `;
                                
                                modalContent.innerHTML = '';
                                modalContent.appendChild(container);
                                document.getElementById('bank-accounts-list').appendChild(accountsList);
                                
                                // Add event listener for the add bank button
                                document.getElementById('add-bank-btn').addEventListener('click', showAddBankForm);
                                
                            } catch (error) {
                                console.error('Error loading bank accounts:', error);
                                showAlert('modal-alert', 'Failed to load bank accounts', 'error');
                            }
                        }
                        
                        // Show add bank form
                        async function showAddBankForm() {
                            try {
                                // Fetch list of banks
                                const response = await fetch('https://api.paystack.co/bank?country=nigeria', {
                                    headers: {
                                        'Authorization': `Bearer ${paystackPublicKey}`
                                    }
                                });
                                
                                if (!response.ok) throw new Error('Failed to load bank list');
                                const { data: banks } = await response.json();
                                
                                // Sort banks by name
                                banks.sort((a, b) => a.name.localeCompare(b.name));
                                
                                // Create bank options
                                const bankOptions = banks.map(bank => 
                                    `<option value="${bank.code}">${bank.name}</option>`
                                ).join('');
                                
                                const formHTML = `
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Bank</label>
                                        <select id="bank-select" class="w-full p-3 bg-gray-700 rounded-lg text-white">
                                            <option value="">Select Bank</option>
                                            ${bankOptions}
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Account Number</label>
                                        <input type="text" id="account-number" class="w-full p-3 bg-gray-700 rounded-lg text-white" 
                                            placeholder="Enter account number" inputmode="numeric">
                                    </div>
                                    <div id="account-details" class="hidden mb-4 p-3 bg-gray-800 rounded-lg">
                                        <p class="text-green-400 font-medium" id="account-name"></p>
                                    </div>
                                    <div class="flex space-x-3">
                                        <button type="button" id="verify-account-btn" 
                                            class="flex-1 p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold">
                                            Verify Account
                                        </button>
                                        <button type="button" id="save-bank-btn" 
                                            class="hidden flex-1 p-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold">
                                            Save Bank Account
                                        </button>
                                        <button type="button" id="cancel-btn" 
                                            class="flex-1 p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-bold">
                                            Cancel
                                        </button>
                                    </div>
                                `;
                                
                                document.getElementById('bank-accounts-list').innerHTML = `
                                    <h4 class="text-lg font-semibold mb-4">Add New Bank Account</h4>
                                    ${formHTML}
                                `;
                                
                                // Add event listeners
                                const bankSelect = document.getElementById('bank-select');
                                const accountNumber = document.getElementById('account-number');
                                const verifyBtn = document.getElementById('verify-account-btn');
                                const saveBtn = document.getElementById('save-bank-btn');
                                const cancelBtn = document.getElementById('cancel-btn');
                                const accountDetails = document.getElementById('account-details');
                                
                                let verifiedAccount = null;
                                
                                // Verify account number
                                verifyBtn.addEventListener('click', async () => {
                                    const bankCode = bankSelect.value;
                                    const accountNum = accountNumber.value.trim();
                                    
                                    if (!bankCode) {
                                        showAlert('modal-alert', 'Please select a bank', 'error');
                                        return;
                                    }
                                    
                                    if (!accountNum) {
                                        showAlert('modal-alert', 'Please enter account number', 'error');
                                        return;
                                    }
                                    
                                    try {
                                        verifyBtn.disabled = true;
                                        verifyBtn.textContent = 'Verifying...';
                                        
                                        const response = await fetch('/api/users/verify-bank-account/', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': getCsrfToken()
                                            },
                                            body: JSON.stringify({
                                                account_number: accountNum,
                                                bank_code: bankCode
                                            })
                                        });
                                        
                                        const data = await response.json();
                                        
                                        if (response.ok) {
                                            verifiedAccount = data;
                                            document.getElementById('account-name').textContent = data.account_name;
                                            accountDetails.classList.remove('hidden');
                                            saveBtn.classList.remove('hidden');
                                            verifyBtn.classList.add('hidden');
                                        } else {
                                            throw new Error(data.error || 'Failed to verify account');
                                        }
                                    } catch (error) {
                                        console.error('Error verifying account:', error);
                                        showAlert('modal-alert', error.message || 'Failed to verify account', 'error');
                                    } finally {
                                        verifyBtn.disabled = false;
                                        verifyBtn.textContent = 'Verify Account';
                                    }
                                });
                                
                                // Save bank account
                                saveBtn.addEventListener('click', async () => {
                                    if (!verifiedAccount) return;
                                    
                                    try {
                                        saveBtn.disabled = true;
                                        saveBtn.textContent = 'Saving...';
                                        
                                        const response = await fetch('/api/users/bank-accounts/', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'X-CSRFToken': getCsrfToken()
                                            },
                                            body: JSON.stringify({
                                                account_name: verifiedAccount.account_name,
                                                account_number: verifiedAccount.account_number,
                                                bank_name: verifiedAccount.bank_name,
                                                bank_code: verifiedAccount.bank_code,
                                                is_primary: true // Make this the primary account
                                            })
                                        });
                                        
                                        if (response.ok) {
                                            showAlert('modal-alert', 'Bank account added successfully', 'success');
                                            loadBankAccounts(); // Reload the list
                                        } else {
                                            const error = await response.json();
                                            throw new Error(error.error || 'Failed to save bank account');
                                        }
                                    } catch (error) {
                                        console.error('Error saving bank account:', error);
                                        showAlert('modal-alert', error.message || 'Failed to save bank account', 'error');
                                    } finally {
                                        saveBtn.disabled = false;
                                        saveBtn.textContent = 'Save Bank Account';
                                    }
                                });
                                
                                // Cancel button
                                cancelBtn.addEventListener('click', () => {
                                    loadBankAccounts(); // Go back to the list
                                });
                                
                            } catch (error) {
                                console.error('Error loading bank form:', error);
                                showAlert('modal-alert', 'Failed to load bank form', 'error');
                            }
                        }
                        
                        // Set primary account
                        async function setPrimaryAccount(accountId, button) {
                            try {
                                button.disabled = true;
                                button.textContent = 'Updating...';
                                
                                const response = await fetch(`/api/users/bank-accounts/${accountId}/`, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCsrfToken()
                                    },
                                    body: JSON.stringify({
                                        is_primary: true
                                    })
                                });
                                
                                if (response.ok) {
                                    showAlert('modal-alert', 'Primary account updated', 'success');
                                    loadBankAccounts(); // Reload the list
                                } else {
                                    const error = await response.json();
                                    throw new Error(error.error || 'Failed to update primary account');
                                }
                            } catch (error) {
                                console.error('Error setting primary account:', error);
                                showAlert('modal-alert', error.message || 'Failed to update primary account', 'error');
                            }
                        }
                        
                        // Delete bank account
                        async function deleteBankAccount(accountId) {
                            if (!confirm('Are you sure you want to delete this bank account?')) {
                                return;
                            }
                            
                            try {
                                const response = await fetch(`/api/users/bank-accounts/${accountId}/`, {
                                    method: 'DELETE',
                                    headers: {
                                        'X-CSRFToken': getCsrfToken()
                                    }
                                });
                                
                                if (response.ok) {
                                    showAlert('modal-alert', 'Bank account deleted', 'success');
                                    loadBankAccounts(); // Reload the list
                                } else {
                                    const error = await response.json();
                                    throw new Error(error.error || 'Failed to delete bank account');
                                }
                            } catch (error) {
                                console.error('Error deleting bank account:', error);
                                showAlert('modal-alert', error.message || 'Failed to delete bank account', 'error');
                            }
                        }
                        
                        // Initialize the bank accounts view
                        loadBankAccounts();
                        break;
                    case 'account_limits':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Account Limits</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <form id="bank-form-modal">
                                    <div class="mb-4"><label for="bank-list-modal" class="block text-sm font-medium text-gray-300 mb-1">Bank Name</label><select id="bank-list-modal" class="form-input w-full p-3 rounded-lg"></select></div>
                                    <div class="mb-4"><label for="account-number-modal" class="block text-sm font-medium text-gray-300 mb-1">Account Number</label><input type="number" id="account-number-modal" class="form-input w-full p-3 rounded-lg" required></div>
                                    <button type="submit" id="verify-account-btn-modal" class="verify-btn w-full p-3 rounded-lg font-bold">Verify Account</button>
                                </form>
                                <div id="verification-result-modal" class="mt-4 text-center hidden">
                                    <p id="account-name-modal" class="font-semibold text-lg text-green-400"></p>
                                    <button id="save-bank-btn-modal" class="submit-btn w-full p-3 mt-2 rounded-lg font-bold">Save Bank</button>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        populateBankList(document.getElementById('bank-list-modal'));
                        updateBankDetailsDisplay(currentUserData.bankDetails, document.getElementById('bank-details-display-modal'));
                        document.getElementById('bank-form-modal').addEventListener('submit', verifyBankAccount);
                        break;
                    case 'account_limits':
                        const tier = currentUserData.kycVerified ? 2 : 1;
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Account Limits</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="space-y-4">
                                    <div class="p-4 rounded-lg ${tier === 1 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 1 (Default)</h4><p class="text-sm">Limit: ₦50,000 per transaction</p></div>
                                    <div class="p-4 rounded-lg ${tier === 2 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 2 (BVN Verified)</h4><p class="text-sm">Limit: ₦200,000 per transaction</p></div>
                                    <div class="p-4 rounded-lg ${tier === 3 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 3 (Address Verified)</h4><p class="text-sm">Limit: ₦1,000,000 per transaction</p></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'preferences':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Preferences</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="flex justify-between items-center"><p>Theme</p><div class="flex items-center gap-2"><i class="fas fa-sun"></i><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="theme-toggle" class="sr-only peer" ${document.body.classList.contains('light-mode') ? '' : 'checked'}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label><i class="fas fa-moon"></i></div></div>
                            </div>`;
                        showModal(modalHTML);
                        document.getElementById('theme-toggle').addEventListener('change', toggleTheme);
                        break;
                }
            }


            async function handleBankTransfer(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('transfer-bank-amount').value);
                const button = e.target.querySelector('button');
                
                if (isNaN(amount) || amount <= 0) return showModalAlert("Invalid amount.");
                if (amount > userWalletBalance) return showModalAlert("Insufficient funds.");

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                const recipientData = {
                    account_name: currentUserData.bankDetails.accountName,
                    account_number: currentUserData.bankDetails.accountNumber,
                    bank_code: currentUserData.bankDetails.bankCode
                };

                try {
                    const response = await fetch('/api/transactions/withdraw/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ amount: amount, recipient: recipientData })
                    });
                    
                    const result = await response.json();

                    if (response.ok) {
                        showModalAlert(result.message || "Withdrawal initiated successfully!", 'success');
                        e.target.reset();
                    } else {
                        showModalAlert(result.error || "Withdrawal failed.");
                    }
                } catch (error) {
                    console.error("Withdrawal Error:", error);
                    showModalAlert("Network error: " + error.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Withdraw Funds';
                }
            }

            // Function to fetch live crypto rates from CoinGecko
            async function fetchLiveCryptoRates(cryptoIds = ['bitcoin', 'ethereum', 'tether']) {
                try {
                    const ids = cryptoIds.join(',');
                    const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching crypto rates:', error);
                    return null;
                }
            }

            async function showSellCryptoModal() {
                // Initialize dbRates if not already defined
                if (typeof dbRates === 'undefined') {
                    window.dbRates = {
                        bitcoin: { name: 'Bitcoin', nairaRate: 0, icon: 'fab fa-bitcoin', iconColor: 'text-orange-400' },
                        ethereum: { name: 'Ethereum', nairaRate: 0, icon: 'fab fa-ethereum', iconColor: 'text-gray-400' },
                        tether: { name: 'Tether', nairaRate: 0, icon: 'fas fa-dollar-sign', iconColor: 'text-green-400' }
                    };
                }
                
                let options = '<option value="">Select Crypto</option>';
                for (const id in dbRates) {
                    options += `<option value="${id}">${dbRates[id].name} (${id.toUpperCase()})</option>`;
                }

                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Sell Crypto</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div id="modal-alert" class="hidden"></div>
                        <div id="sell-crypto-form">
                            <div class="mb-4">
                                <label for="crypto-select" class="block text-sm font-medium mb-1">Cryptocurrency</label>
                                <select id="crypto-select" class="form-input w-full p-3 rounded-lg">${options}</select>
                            </div>
                            <div class="mb-4">
                                <label for="crypto-amount-usd" class="block text-sm font-medium mb-1">Amount to Sell (USD)</label>
                                <input type="number" step="0.00000001" id="crypto-amount-usd" class="form-input w-full p-3 rounded-lg" placeholder="0.00">
                            </div>
                            <div class="space-y-3 mb-4">
                                <div class="p-4 bg-gray-800 rounded-lg">
                                    <p class="text-sm text-gray-400">Current Market Rate</p>
                                    <p id="live-rate-display" class="text-xl font-bold">$0.00 = ₦0.00</p>
                                    <p id="rate-source" class="text-xs text-gray-500 mt-1">Source: CoinGecko</p>
                                </div>
                                <div class="p-4 bg-gray-800 rounded-lg">
                                    <p class="text-sm text-gray-400">Our Rate</p>
                                    <p id="admin-rate-display" class="text-xl font-bold">₦0.00 / $</p>
                                </div>
                            </div>
                            <button id="sell-now-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Sell Now (via WhatsApp)</button>
                        </div>
                    </div>`;
                
                showModal(modalHTML);
                
                const cryptoSelect = document.getElementById('crypto-select');
                const liveRateDisplay = document.getElementById('live-rate-display');
                const adminRateDisplay = document.getElementById('admin-rate-display');
                const amountInput = document.getElementById('crypto-amount-usd');
                
                // Store the current rates
                let currentRates = {
                    usd: 0,
                    ngn: 0,
                    adminRate: 0
                };

                // Function to update the rate displays
                const updateRateDisplays = () => {
                    const amount = parseFloat(amountInput.value) || 0;
                    const nairaValue = (amount * currentRates.ngn).toLocaleString('en-NG', {
                        style: 'currency',
                        currency: 'NGN',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    liveRateDisplay.textContent = `$${amount.toFixed(2)} = ${nairaValue}`;
                    
                    if (currentRates.adminRate > 0) {
                        const adminNairaValue = (amount * currentRates.adminRate).toLocaleString('en-NG', {
                            style: 'currency',
                            currency: 'NGN',
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        adminRateDisplay.textContent = `₦${currentRates.adminRate.toLocaleString()}/$ (${adminNairaValue})`;
                    } else {
                        adminRateDisplay.textContent = 'N/A';
                    }
                };

                // Handle crypto selection change
                const updateRates = async () => {
                    const cryptoId = cryptoSelect.value;
                    if (!cryptoId) return;

                    try {
                        // Show loading state
                        liveRateDisplay.textContent = 'Fetching rates...';
                        adminRateDisplay.textContent = 'Loading...';

                        // Fetch live rates
                        const liveRates = await fetchLiveCryptoRates([cryptoId]);
                        
                        if (liveRates && liveRates[cryptoId]) {
                            currentRates.usd = liveRates[cryptoId].usd;
                            
                            // Get USD to NGN rate (you might want to fetch this from a currency API)
                            // For now, using a fixed rate of 1500 NGN per USD
                            const usdToNgnRate = 1500; // Replace with actual rate from your API
                            currentRates.ngn = currentRates.usd * usdToNgnRate;
                            
                            // Update admin rate if available
                            if (dbRates[cryptoId]) {
                                currentRates.adminRate = parseFloat(dbRates[cryptoId].nairaRate) || 0;
                            }
                            
                            updateRateDisplays();
                        }
                    } catch (error) {
                        console.error('Error updating rates:', error);
                        liveRateDisplay.textContent = 'Error fetching rates';
                        adminRateDisplay.textContent = 'N/A';
                    }
                };

                // Event listeners
                cryptoSelect.addEventListener('change', updateRates);
                amountInput.addEventListener('input', updateRateDisplays);
                document.getElementById('sell-now-btn').addEventListener('click', handleSellCryptoViaWhatsApp);
                
                // Initialize rates if a crypto is selected
                if (cryptoSelect.value) {
                    updateRates();
                }
            }
            
            function showTransferModal() {
                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Transfer Funds</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div class="flex border-b border-gray-700 mb-4">
                            <button id="tab-user" class="tab-btn active flex-1 py-2 font-semibold">SpaceVest User</button>
                            <button id="tab-bank" class="tab-btn flex-1 py-2 font-semibold">Bank Account</button>
                        </div>
                        <div id="modal-alert" class="hidden"></div>
                        
                        <!-- SpaceVest User Tab Content -->
                        <div id="content-user">
                            <form id="transfer-user-form">
                                <div class="mb-4"><label for="transfer-email" class="block text-sm font-medium mb-1">Recipient Email</label><input type="email" id="transfer-email" class="form-input w-full p-3 rounded-lg" required></div>
                                <div class="mb-4"><label for="transfer-user-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="transfer-user-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Send</button>
                            </form>
                        </div>

                        <!-- Bank Account Tab Content -->
                        <div id="content-bank" class="hidden">
                            ${!currentUserData.bankDetails ? `<p class="text-center text-yellow-400">Please add a bank account in your profile first.</p>` : `
                            <form id="transfer-bank-form">
                                <div class="mb-4"><label class="block text-sm font-medium mb-1">Recipient</label>
                                    <div class="p-3 bg-gray-700 rounded-lg">${currentUserData.bankDetails.accountName}<br><small>${currentUserData.bankDetails.bankName} - ${currentUserData.bankDetails.accountNumber}</small></div>
                                </div>
                                <div class="mb-4"><label for="transfer-bank-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="transfer-bank-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Withdraw Funds</button>
                            </form>`}
                        </div>
                    </div>`;
                showModal(modalHTML);
                // Tab switching logic
                const userTab = document.getElementById('tab-user'), bankTab = document.getElementById('tab-bank');
                const userContent = document.getElementById('content-user'), bankContent = document.getElementById('content-bank');
                userTab.addEventListener('click', () => {
                    userTab.classList.add('active'); bankTab.classList.remove('active');
                    userContent.classList.remove('hidden'); bankContent.classList.add('hidden');
                });
                bankTab.addEventListener('click', () => {
                    bankTab.classList.add('active'); userTab.classList.remove('active');
                    bankContent.classList.remove('hidden'); userContent.classList.add('hidden');
                });

                // Form submission logic
                document.getElementById('transfer-user-form')?.addEventListener('submit', handleUserTransfer);
                document.getElementById('transfer-bank-form')?.addEventListener('submit', handleBankTransfer);
            }

            async function addTransaction(userId, type, status, amount, description) {
                try {
                    const response = await fetch('/api/transactions/add/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({ type, status, amount, description })
                    });
                    
                    if (!response.ok) {
                        console.error('Failed to add transaction:', await response.text());
                    }
                } catch (error) {
                    console.error("Failed to add transaction:", error);
                }
            }

            // --- Transaction History Page ---
            function showHistoryPage() {
                showPage('history');
                fetchAndDisplayTransactions();
            }

            function fetchAndDisplayTransactions() {
                // Commented out Firebase call - using Django API instead
                // if (unsubscribeHistory) unsubscribeHistory(); // Unsubscribe from previous listener
                // const userId = auth.currentUser.uid;
                const historyContainer = document.getElementById('history-container');
                // const q = query(collection(db, "users", userId, "transactions"), orderBy("timestamp", "desc"));

                // unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                //     historyContainer.innerHTML = ''; // Clear previous list
                //     if (querySnapshot.empty) {
                //         historyContainer.innerHTML = `<p class="text-center text-gray-400 mt-8">No transactions yet.</p>`;
                //         return;
                //     }
                //     querySnapshot.forEach((doc) => {
                //         const tx = doc.data();
                //         const isDebit = tx.type === 'debit';
                //         const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                //         const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                //         const sign = isDebit ? '-' : '+';
                //         const date = tx.timestamp ? tx.timestamp.toDate().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'Just now';
                //
                //         const txItemHTML = `
                //             <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                //                 <div class="flex items-center gap-4">
                //                     <i class="fas ${iconClass}"></i>
                //                     <div>
                //                         <p class="font-bold">${tx.description}</p>
                //                         <p class="text-xs text-gray-400">${date}</p>
                //                     </div>
                //                 </div>
                //                 <div class="text-right">
                //                     <p class="font-semibold ${amountClass}">${sign} ₦${tx.amount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                //                 </div>
                //             </div>
                //         `;
                //         historyContainer.innerHTML += txItemHTML;
                //     });
                // }, (error) => {
                //     console.error("Error fetching transaction history:", error);
                //     historyContainer.innerHTML = `<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>`;
                // });

                // Use Django API for transaction history
                historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">Loading transactions...</p>';

                fetch('/api/transactions/history/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch transactions');
                        return response.json();
                    })
                    .then(data => {
                        if (!data.length) {
                            historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">No transactions yet.</p>';
                            return;
                        }
                        historyContainer.innerHTML = '';
                        data.forEach(tx => {
                            const isDebit = tx.type === 'debit';
                            const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                            const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                            const sign = isDebit ? '-' : '+';
                            const date = new Date(tx.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                            const txItemHTML = `
                                <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <i class="fas ${iconClass}"></i>
                                        <div>
                                            <p class="font-bold">${tx.description}</p>
                                            <p class="text-xs text-gray-400">${date}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold ${amountClass}">${sign} ₦${parseFloat(tx.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                                    </div>
                                </div>
                            `;
                            historyContainer.innerHTML += txItemHTML;
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching transaction history:', error);
                        historyContainer.innerHTML = '<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>';
                    });
            }

            // --- Event Listeners ---
            toggleBalanceEl.addEventListener('click', () => {
                balanceVisible = !balanceVisible;
                updateBalanceUI();
            });

            document.querySelectorAll('.settings-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    handleSettingsAction(action);
                });
            });

        // function fetchUserData(userId) {
        //         const userDocRef = doc(db, "users", userId);
        //         unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
        //             if (docSnap.exists()) {
        //                 currentUserData = docSnap.data();
        //                 usernameHomeEl.textContent = currentUserData.username || 'user';
        //                 usernameProfileEl.textContent = currentUserData.username || 'user';
        //                 fullnameProfileEl.textContent = currentUserData.fullname || '';
        //                 userWalletBalance = currentUserData.walletBalance || 0;
        //
        //                 if (currentUserData.preferences?.theme === 'light') { document.body.classList.add('light-mode'); }
        //                 else { document.body.classList.remove('light-mode'); }
        //
        //                 balanceVisible = currentUserData.securitySettings?.showBalance ?? false;
        //                 updateBalanceUI();
        //
        //                 bankPromptEl.classList.toggle('hidden', !!currentUserData.bankDetails);
        //
        //                 const kycDone = currentUserData.kycVerified === true;
        //                 const kycStatusEl = document.getElementById('kyc-status');
        //                 const kycSubtextEl = document.getElementById('kyc-subtext');
        //                 kycStatusEl.textContent = kycDone ? "Done" : "Not Done";
        //                 kycSubtextEl.textContent = kycDone ? "Your account is verified." : "Please add your BVN details";
        //                 kycStatusEl.classList.toggle('text-green-400', kycDone);
        //                 kycStatusEl.classList.toggle('text-red-400', !kycDone);
        //
        //                 if (currentUserData.role === 'admin') {
        //                     navLinks.admin.classList.remove('hidden');
        //                 } else {
        //                     navLinks.admin.classList.add('hidden');
        //                 }
        //                 appReady = true; // Mark app as fully ready
        //             } else {
        //                 // If user doc doesn't exist, it might be a new signup.
        //                 appReady = true;
        //             }
        //         }, (error) => {
        //             console.error("Error fetching user data:", error);
        //             showError("Could not load user data. Check console for details.");
        //         });
        //
        //         fetchRates();
        //     }
            
            async function fetchRates() {
                // Initialize global variables
                window.dbRates = window.dbRates || {};
                window.liveCryptoRates = window.liveCryptoRates || {};
                
                const ratesPageContainer = document.getElementById('rates-page-container');
                const marqueeContentEl = document.querySelector('.marquee-content');
                const ratesCardsContainer = document.getElementById('rates-container');

                try {
                    // Fetch rates from Django API
                    const response = await fetch('/api/crypto/rates/');
                    if (response.ok) {
                        const cryptoRates = await response.json();
                        
                        // Clear existing rates
                        window.dbRates = {};
                        
                        // Process database rates
                        cryptoRates.forEach(rate => {
                            const cryptoName = rate.symbol.toLowerCase();
                            const mapping = {
                                'btc': 'bitcoin',
                                'eth': 'ethereum', 
                                'usdt': 'tether'
                            };
                            const mappedName = mapping[cryptoName] || cryptoName;
                            
                            window.dbRates[mappedName] = {
                                name: rate.cryptocurrency,
                                nairaRate: parseFloat(rate.current_price_ngn),
                                icon: getIconForCrypto(rate.symbol),
                                iconColor: getIconColorForCrypto(rate.symbol)
                            };
                        });
                        
                        // If no rates in database, show message instead of defaults
                        if (Object.keys(window.dbRates).length === 0) {
                            const noRatesMsg = `<p class="text-gray-400">No rates available. Please contact admin to set rates.</p>`;
                            if (marqueeContentEl) marqueeContentEl.innerHTML = noRatesMsg;
                            if (ratesPageContainer) ratesPageContainer.innerHTML = noRatesMsg;
                            return;
                        }
                        
                        // Fetch live prices from CoinGecko
                        const rateIds = Object.keys(window.dbRates).join(',');
                        const priceResponse = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${rateIds}&vs_currencies=usd`);
                        
                        if (priceResponse.ok) {
                            const prices = await priceResponse.json();
                            window.liveCryptoRates = prices;
                            
                            let marqueeHTML = '';
                            for (const id in window.dbRates) {
                                const rateData = window.dbRates[id];
                                const livePrice = prices[id]?.usd || 0;
                                
                                // Populate marquee
                                marqueeHTML += `
                                    <div class="marquee-item text-sm">
                                        <i class="${rateData.icon} ${rateData.iconColor} mr-2"></i>
                                        <span class="font-bold text-gray-300">${rateData.name}:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$${livePrice.toLocaleString()}</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</span>
                                    </div>
                                `;
                                
                                // Populate rates page
                                const ratePageItem = `<div class="settings-item flex justify-between items-center p-4 rounded-lg"><div class="flex items-center gap-4"><i class="${rateData.icon} text-2xl ${rateData.iconColor}"></i><div><p class="font-bold">${rateData.name}</p><p class="text-xs text-gray-400">Live Price: $${livePrice.toLocaleString()}</p></div></div><div class="text-right"><p class="font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</p><p class="text-xs text-gray-400">Our Rate</p></div></div>`;
                                ratesPageContainer.innerHTML += ratePageItem;
                            }
                            
                            // Duplicate marquee content for smooth looping effect
                            if (marqueeContentEl) {
                                marqueeContentEl.innerHTML = marqueeHTML + marqueeHTML;
                            }
                        }
                    }
                } catch (error) {
                    console.error("Error fetching rates:", error);
                    const errorMsg = `<p class="text-red-400">Could not load rates.</p>`;
                    if (marqueeContentEl) marqueeContentEl.innerHTML = errorMsg;
                    if (ratesPageContainer) ratesPageContainer.innerHTML = errorMsg;
                }
            } // Close fetchRates function

            // Call fetchRates to initialize rates
            fetchRates();
            
            // Admin functionality
            if (document.getElementById('rate-form-admin')) {
                loadAdminRates();
                document.getElementById('rate-form-admin').addEventListener('submit', handleAdminRateUpdate);
            }
        }

        // Admin rate management functions
        async function loadAdminRates() {
            try {
                const response = await fetch('/api/crypto/admin/get-rates/', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const ratesListContainer = document.getElementById('rates-list-admin');
                    
                    if (data.rates && data.rates.length > 0) {
                        ratesListContainer.innerHTML = '';
                        data.rates.forEach(rate => {
                            const rateItem = document.createElement('div');
                            rateItem.className = 'flex justify-between items-center p-2 bg-gray-800 rounded-lg text-sm';
                            rateItem.innerHTML = `
                                <span class="font-medium">${rate.cryptocurrency}</span>
                                <span class="text-yellow-400">₦${parseFloat(rate.current_price_ngn).toLocaleString()}</span>
                            `;
                            ratesListContainer.appendChild(rateItem);
                        });
                        
                        // Update global rates for the sell crypto functionality
                        window.dbRates = {};
                        data.rates.forEach(rate => {
                            const cryptoName = rate.cryptocurrency.toLowerCase();
                            const mapping = {
                                'btc': 'bitcoin',
                                'eth': 'ethereum', 
                                'usdt': 'tether'
                            };
                            const mappedName = mapping[cryptoName] || cryptoName;
                            
                            window.dbRates[mappedName] = {
                                name: rate.cryptocurrency,
                                nairaRate: parseFloat(rate.current_price_ngn),
                                icon: getIconForCrypto(rate.cryptocurrency),
                                iconColor: getIconColorForCrypto(rate.cryptocurrency)
                            };
                        });
                        
                        // Update marquee with new rates
                        updateMarqueeWithRates();
                    } else {
                        ratesListContainer.innerHTML = '<p class="text-gray-400 text-sm">No rates found. Add some rates below.</p>';
                    }
                } else {
                    console.error('Failed to load admin rates');
                }
            } catch (error) {
                console.error('Error loading admin rates:', error);
            }
        }
        
        function getIconForCrypto(crypto) {
            const icons = {
                'BTC': 'fab fa-bitcoin',
                'ETH': 'fab fa-ethereum',
                'USDT': 'fas fa-dollar-sign'
            };
            return icons[crypto] || 'fas fa-coins';
        }
        
        function getIconColorForCrypto(crypto) {
            const colors = {
                'BTC': 'text-orange-400',
                'ETH': 'text-gray-400',
                'USDT': 'text-green-400'
            };
            return colors[crypto] || 'text-blue-400';
        }
        
        function updateMarqueeWithRates() {
            const marqueeContentEl = document.querySelector('.marquee-content');
            if (!marqueeContentEl || !window.dbRates) return;
            
            let marqueeHTML = '';
            for (const id in window.dbRates) {
                const rateData = window.dbRates[id];
                const livePrice = window.liveCryptoRates?.[id]?.usd || 0;
                
                marqueeHTML += `
                    <div class="marquee-item text-sm">
                        <i class="${rateData.icon} ${rateData.iconColor} mr-2"></i>
                        <span class="font-bold text-gray-300">${rateData.name}:</span>
                        <span class="text-green-400 ml-1 font-semibold">$${livePrice.toLocaleString()}</span>
                        <span class="text-gray-400 mx-2">|</span>
                        <span class="font-bold text-gray-300">Our Rate:</span>
                        <span class="text-yellow-400 ml-1 font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</span>
                    </div>
                `;
            }
            
            // Duplicate marquee content for smooth looping effect
            marqueeContentEl.innerHTML = marqueeHTML + marqueeHTML;
        }
        
        async function handleAdminRateUpdate(e) {
            e.preventDefault();
            
            const cryptocurrency = document.getElementById('rate-crypto-select-admin').value;
            const newRate = document.getElementById('rate-ngn-admin').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            if (!cryptocurrency || !newRate) {
                showError('Please select a cryptocurrency and enter a rate');
                return;
            }
            
            if (parseFloat(newRate) <= 0) {
                showError('Rate must be greater than 0');
                return;
            }
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            try {
                const response = await fetch('/api/crypto/admin/update-rate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify({
                        cryptocurrency: cryptocurrency,
                        rate_ngn: parseFloat(newRate)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess(result.message, 'success');
                    
                    // Reset form
                    document.getElementById('rate-ngn-admin').value = '';
                    
                    // Reload admin rates to show updated values
                    await loadAdminRates();
                    
                } else {
                    showError(result.error || 'Failed to update rate');
                }
            } catch (error) {
                console.error('Error updating rate:', error);
                showError('Network error: ' + error.message);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Update Rate';
            }
        }

        });

    </script>
</body>
</html>

