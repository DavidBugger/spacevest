<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceVest - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E5E7EB;
            transition: background-color 0.3s, color 0.3s;
        }
        .auth-container, .modal-content, .profile-section, .settings-list > div, .admin-section {
            background-color: #1F2937;
        }
        .form-input {
            background-color: #374151;
            border: 1px solid #4B5563;
        }
        .submit-btn, .verify-btn {
            background: linear-gradient(105deg, #FFD700, #FBBF24, #F59E0B);
            color: #1F2937;
        }
        .submit-btn:disabled, .verify-btn:disabled {
            background: #4B5563;
            color: #9CA3AF;
            cursor: not-allowed;
        }
        .wallet-card {
            background: linear-gradient(105deg, #FFD700, #FBBF24, #F59E0B);
            position: relative;
            overflow: hidden;
        }
        .wallet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 400'%3E%3Cpath fill='rgba(255, 255, 255, 0.05)' d='M 0 100 C 200 150 400 50 600 100 S 800 150 800 100 V 400 H 0 Z'/%3E%3Cpath fill='rgba(255, 255, 255, 0.08)' d='M 0 200 C 150 280 350 120 550 200 S 800 120 800 200 V 400 H 0 Z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0.5;
        }
        .action-item, .settings-item {
            background-color: #1F2937;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .action-item:hover, .settings-item:hover {
            background-color: #374151;
        }
        .bottom-nav {
            background-color: #1F2937;
            transition: background-color 0.3s;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Light Mode */
        body.light-mode { background-color: #F3F4F6; color: #1F2937; }
        .light-mode .auth-container, .light-mode .modal-content, .light-mode .profile-section, .light-mode .settings-list > div, .light-mode .action-item, .light-mode .settings-item, .light-mode .bottom-nav, .light-mode .admin-section { background-color: #FFFFFF; border: 1px solid #E5E7EB; }
        .light-mode .form-input { background-color: #F3F4F6; border-color: #D1D5DB; }
        .light-mode #username-home, .light-mode #username-profile, .light-mode h2, .light-mode h3, .light-mode h4, .light-mode .font-bold { color: #111827; }
        .light-mode .text-gray-400 { color: #6B7280; }
        .light-mode .text-gray-300 { color: #4B5563; }
        .light-mode .text-gray-500 { color: #9CA3AF; }
        .light-mode .border-gray-600 { border-color: #E5E7EB; }
        .light-mode .border-gray-700 { border-color: #D1D5DB; }
        
        /* Chat bubble styles */
        .chat-bubble { max-width: 75%; }
        .chat-bubble.sent { background-color: #FBBF24; color: #1F2937; }
        .chat-bubble.received { background-color: #374151; }
        .light-mode .chat-bubble.received { background-color: #E5E7EB; }
        
        /* Tab styles */
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom-color: #FBBF24; color: #FBBF24; }
        .light-mode .tab-btn.active { color: #F59E0B; border-bottom-color: #F59E0B; }

         /* Marquee Styles */
        .marquee-container {
            white-space: nowrap;
        }
        .marquee-content {
            animation: marquee 60s linear infinite; /* Increased duration for more content */
            display: inline-block;
        }
        .marquee-item {
            display: inline-flex;
            align-items: center;
            margin-right: 2.5rem; /* 40px */
        }
        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-50%); } /* Animate to -50% because content is duplicated */
        }
        .marquee-container:hover .marquee-content {
            animation-play-state: paused;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
            border: 1px solid #1F2937;
        }

        /* Page sections */
        .page-section {
            min-height: calc(100vh - 80px);
            padding-bottom: 80px;
        }
    </style>
</head>
<body class="max-w-md mx-auto p-4 min-h-screen" style="padding-bottom: 80px;">
    
    <div id="app-loader" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
        <i class="fas fa-spinner fa-spin text-white text-4xl"></i>
    </div>
    
    <div id="auth-error" class="fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50"></div>

    <div id="app-section">
    <header class="flex justify-between items-center py-4">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fa-solid fa-face-meh text-2xl text-gray-700"></i>
            </div>
            <div>
                <p class="text-sm text-gray-400">Welcome back,</p>
                <div class="flex items-center gap-1">
                    <h1 id="username-home" class="font-bold text-lg">{{ user.username }}</h1>
                    <i class="fas fa-check-circle text-blue-500 text-sm"></i>
                </div>
            </div>
        </div>
        <div class="relative">
            <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 text-sm rounded-full flex items-center gap-1">
                <i class="fa-solid fa-right-from-bracket"></i>Logout
            </button>
        </div>
    </header>

    <section class="wallet-card text-gray-800 rounded-2xl p-6 my-4 shadow-lg">
        <div class="relative z-10">
            <div class="flex items-center gap-2 text-sm">
                <span>Wallet Balance:</span>
                <i id="toggle-balance" class="fa-regular fa-eye-slash cursor-pointer"></i>
            </div>
            <p id="wallet-balance" class="text-4xl font-bold mt-2">₦ {{ user.wallet_balance|floatformat:2 }}</p>
        </div>
    </section>

    <section id="bank-details-prompt" class="bg-teal-500/20 text-teal-300 p-4 rounded-xl flex items-center gap-4 mb-6 {% if user.bank_details %}hidden{% endif %} cursor-pointer">
        <i class="fa-solid fa-building-columns text-2xl"></i>
        <p class="text-sm">Please add your bank details to submit transactions</p>
    </section>


            <div class="marquee-container bg-gray-800 rounded-lg p-3 overflow-hidden">
                <div class="marquee-content flex">
                                    <div class="marquee-item text-sm">
                                        <i class="fab fa-bitcoin text-orange-400 mr-2"></i>
                                        <span class="font-bold text-gray-300">Bitcoin:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$112,390</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦1,520/$</span>
                                    </div>
                                
                                    <div class="marquee-item text-sm">
                                        <i class="fab fa-ethereum text-gray-400 mr-2"></i>
                                        <span class="font-bold text-gray-300">Ethereum:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$4,505.39</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦1,520/$</span>
                                    </div>
                                
                                    <div class="marquee-item text-sm">
                                        <i class="fas fa-dollar-sign text-green-400 mr-2"></i>
                                        <span class="font-bold text-gray-300">Tether:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$1</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦1,520/$</span>
                                    </div>
                                
                                    <div class="marquee-item text-sm">
                                        <i class="fab fa-bitcoin text-orange-400 mr-2"></i>
                                        <span class="font-bold text-gray-300">Bitcoin:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$112,390</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦1,520/$</span>
                                    </div>
                                
                                    <div class="marquee-item text-sm">
                                        <i class="fab fa-ethereum text-gray-400 mr-2"></i>
                                        <span class="font-bold text-gray-300">Ethereum:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$4,505.39</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦1,520/$</span>
                                    </div>
                                
                                    <div class="marquee-item text-sm">
                                        <i class="fas fa-dollar-sign text-green-400 mr-2"></i>
                                        <span class="font-bold text-gray-300">Tether:</span>
                                        <span class="text-green-400 ml-1 font-semibold">$1</span>
                                        <span class="text-gray-400 mx-2">|</span>
                                        <span class="font-bold text-gray-300">Our Rate:</span>
                                        <span class="text-yellow-400 ml-1 font-semibold">₦1,520/$</span>
                                    </div>
                                </div>
            </div>
        

    <section>
        <h2 class="text-lg font-semibold my-6">Actions</h2>
        <div class="grid grid-cols-3 gap-4">
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="add_funds">
                <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-plus text-green-400"></i>
                </div>
                <p class="text-sm font-medium">Add Funds</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="withdraw">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-arrow-down text-yellow-400"></i>
                </div>
                <p class="text-sm font-medium">Withdraw</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="transfer">
                <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-paper-plane text-blue-400"></i>
                </div>
                <p class="text-sm font-medium">Transfer</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="sell_crypto">
                <div class="w-12 h-12 bg-orange-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-brands fa-bitcoin text-orange-400"></i>
                </div>
                <p class="text-sm font-medium">Sell Crypto</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="top_up">
                <div class="w-12 h-12 bg-sky-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-mobile-screen-button text-sky-400"></i>
                </div>
                <p class="text-sm font-medium">Top-up</p>
            </div>
            <div class="action-item rounded-xl p-4 flex flex-col items-center justify-center aspect-square" data-action="cable_tv">
                <div class="w-12 h-12 bg-indigo-500/20 rounded-full flex items-center justify-center mb-2">
                    <i class="fa-solid fa-tv text-indigo-400"></i>
                </div>
                <p class="text-sm font-medium">Cable Tv</p>
            </div>
        </div>
    </section>

    </div>


    <nav class="bottom-nav fixed bottom-0 left-0 right-0 max-w-md mx-auto grid grid-cols-5 items-center text-center py-3 border-t border-gray-700 z-40 hidden">
        <a href="#" id="nav-app" class="text-yellow-400">
            <i class="fa-solid fa-house text-xl"></i>
            <p class="text-xs font-semibold mt-1">Home</p>
        </a>
        <a href="#" id="nav-history" class="text-gray-400">
            <i class="fa-solid fa-list-ul text-xl"></i>
            <p class="text-xs font-medium mt-1">History</p>
        </a>
        <a href="#" id="nav-rates" class="text-gray-400">
            <i class="fa-solid fa-chart-line text-xl"></i>
            <p class="text-xs font-medium mt-1">Rates</p>
        </a>
        <a href="#" id="nav-profile" class="text-gray-400">
            <i class="fa-solid fa-user text-xl"></i>
            <p class="text-xs font-medium mt-1">Profile</p>
        </a>
        {% if user.role == 'admin' %}
        <a href="#" id="nav-admin" class="text-gray-400 relative">
            <i class="fa-solid fa-user-shield text-xl"></i>
            <p class="text-xs font-medium mt-1">Admin</p>
            <div id="admin-notification-badge" class="notification-badge hidden"></div>
        </a>
        {% endif %}
    </nav>

    <!-- Page Sections -->
    <div id="page-app" class="page-section">

    <div id="page-profile" class="page-section hidden">
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center gap-3">
                <button id="back-to-app" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="font-bold text-lg">Profile</h1>
            </div>
        </header>

        <div class="space-y-4">
            <div class="wallet-card text-gray-800 rounded-2xl p-6 shadow-lg">
                <div class="relative z-10">
                    <div class="flex items-center gap-2 text-sm">
                        <span>Wallet Balance:</span>
                        <i id="toggle-balance-profile" class="fa-regular fa-eye-slash cursor-pointer"></i>
                    </div>
                    <p id="wallet-balance-profile" class="text-4xl font-bold mt-2">₦ {{ user.wallet_balance|floatformat:2 }}</p>
                </div>
            </div>

            <div class="settings-list space-y-2">
                <div class="settings-item" data-action="personal_info">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-user text-gray-400"></i>
                            <div>
                                <p class="font-semibold">Personal Information</p>
                                <p class="text-sm text-gray-400">View your account details</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <div class="settings-item" data-action="kyc_verification">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-shield-alt text-gray-400"></i>
                            <div>
                                <p class="font-semibold">KYC Verification</p>
                                <p class="text-sm text-gray-400" id="kyc-subtext">Please add your BVN details</p>
                            </div>
                        </div>
                        <span id="kyc-status" class="text-red-400 font-semibold">Not Done</span>
                    </div>
                </div>

                <div class="settings-item" data-action="badge">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-medal text-yellow-400"></i>
                            <div>
                                <p class="font-semibold">Badge & Level</p>
                                <p class="text-sm text-gray-400">View your trading level</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <div class="settings-item" data-action="security">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-lock text-gray-400"></i>
                            <div>
                                <p class="font-semibold">Security</p>
                                <p class="text-sm text-gray-400">Manage your security settings</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <div class="settings-item" data-action="bank_accounts">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-building-columns text-gray-400"></i>
                            <div>
                                <p class="font-semibold">Bank Accounts</p>
                                <p class="text-sm text-gray-400">Manage your bank details</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <div class="settings-item" data-action="account_limits">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chart-bar text-gray-400"></i>
                            <div>
                                <p class="font-semibold">Account Limits</p>
                                <p class="text-sm text-gray-400">View your transaction limits</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>

                <div class="settings-item" data-action="preferences">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-palette text-gray-400"></i>
                            <div>
                                <p class="font-semibold">Preferences</p>
                                <p class="text-sm text-gray-400">Customize your experience</p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="page-history" class="page-section hidden">
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center gap-3">
                <button id="back-to-app-history" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="font-bold text-lg">Transaction History</h1>
            </div>
        </header>

        <div id="history-container" class="space-y-2">
            <!-- Transaction history will be populated here -->
        </div>
    </div>

    <div id="page-rates" class="page-section hidden">
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center gap-3">
                <button id="back-to-app-rates" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="font-bold text-lg">Exchange Rates</h1>
            </div>
        </header>

        <div id="rates-page-container" class="space-y-2">
            <!-- Rates will be populated here -->
        </div>
    </div>

    <div id="page-admin" class="page-section hidden">
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center gap-3">
                <button id="back-to-app-admin" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="font-bold text-lg">Admin Panel</h1>
            </div>
        </header>

        <div class="space-y-6">
            <div>
                <h2 class="text-lg font-semibold mb-4">User Management</h2>
                <div id="user-list-admin" class="space-y-2">
                    <!-- Users will be populated here -->
                </div>
            </div>

            <div>
                <h2 class="text-lg font-semibold mb-4">Rate Management</h2>
                <form id="rate-form-admin" class="space-y-4 mb-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Cryptocurrency</label>
                        <select id="rate-crypto-select-admin" class="form-input w-full p-3 rounded-lg" required>
                            <option value="">Select Crypto</option>
                            <option value="bitcoin">Bitcoin</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="tether">Tether</option>
                        </select>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Rate (₦/$)</label>
                        <input type="number" id="rate-ngn-admin" step="0.01" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Update Rate
                    </button>
                </form>
                <div id="rates-list-admin" class="space-y-2">
                    <!-- Current rates will be populated here -->
                </div>
            </div>

            <div>
                <h2 class="text-lg font-semibold mb-4">Support Chats</h2>
                <div id="support-chats-admin" class="space-y-2">
                    <!-- Active chats will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <button id="chat-btn" class="fixed bottom-24 right-5 bg-yellow-400 text-black w-14 h-14 rounded-full flex items-center justify-center shadow-lg z-40 hidden">
        <i class="fas fa-comment-dots text-2xl"></i>
    </button>

    <!-- Add Funds Modal -->
    <div id="add-funds-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="add-funds-form" class="space-y-4">
                {% csrf_token %}
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                    <input type="number" name="amount" required min="100" step="100"
                           class="form-input w-full p-3 rounded-lg" placeholder="Enter amount"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>

                <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                    Proceed to Payment
                </button>
            </form>
        </div>
    </div>


    

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Withdraw to Bank</h3>
                <button id="close-withdraw" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="withdraw-alert" class="hidden"></div>
            <form id="withdraw-form" class="space-y-4">
                {% csrf_token %}
                <div class="text-left">
                    <p class="text-sm text-gray-400">Withdrawal Account:</p>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <p class="font-semibold">{{ user.bank_details.account_name }}</p>
                        <small>{{ user.bank_details.bank_name }} - {{ user.bank_details.account_number }}</small>
                    </div>
                </div>
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                    <input type="number" id="withdraw-amount" required min="100" step="100"
                           class="form-input w-full p-3 rounded-lg" placeholder="Enter amount"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                    Withdraw Funds
                </button>
            </form>
        </div>
    </div>
    

    <!-- Transfer Modal -->
    <div id="transfer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Transfer Funds</h3>
                <button id="close-transfer" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex border-b border-gray-700 mb-4">
                <button id="tab-user" class="tab-btn active flex-1 py-2 font-semibold">SpaceVest User</button>
                <button id="tab-bank" class="tab-btn flex-1 py-2 font-semibold">Bank Account</button>
            </div>
            <div id="transfer-alert" class="hidden"></div>

            <!-- SpaceVest User Tab Content -->
            <div id="content-user">
                <form id="transfer-user-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Recipient Email</label>
                        <input type="email" id="transfer-email" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                        <input type="number" id="transfer-user-amount" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Send
                    </button>
                </form>
            </div>

            <!-- Bank Account Tab Content -->
            <div id="content-bank" class="hidden">
                {% if user.bank_details %}
                <form id="transfer-bank-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <p class="text-sm text-gray-400">Recipient</p>
                        <div class="p-3 bg-gray-700 rounded-lg">
                            {{ user.bank_details.account_name }}<br>
                            <small>{{ user.bank_details.bank_name }} - {{ user.bank_details.account_number }}</small>
                        </div>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Amount (₦)</label>
                        <input type="number" id="transfer-bank-amount" class="form-input w-full p-3 rounded-lg" required>
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Withdraw Funds
                    </button>
                </form>
                {% else %}
                <p class="text-center text-yellow-400">Please add a bank account in your profile first.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sell Crypto Modal -->
    <div id="sell-crypto-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Sell Crypto</h3>
                <button id="close-sell-crypto" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="sell-crypto-alert" class="hidden"></div>
            <form id="sell-crypto-form" class="space-y-4">
                {% csrf_token %}
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Cryptocurrency</label>
                    <select id="crypto-select" class="form-input w-full p-3 rounded-lg">
                        <option value="">Select Crypto</option>
                        <option value="bitcoin">Bitcoin (BTC)</option>
                        <option value="ethereum">Ethereum (ETH)</option>
                        <option value="tether">Tether (USDT)</option>
                    </select>
                </div>
                <div class="text-left">
                    <label class="block text-gray-400 text-sm mb-2">Amount to Sell (USD)</label>
                    <input type="number" step="any" id="crypto-amount-usd" class="form-input w-full p-3 rounded-lg" required>
                </div>
                <div class="p-4 bg-gray-800 rounded-lg text-left">
                    <p class="text-sm text-gray-400">Current Rate</p>
                    <p id="admin-rate-display" class="text-xl font-bold">₦0.00 / $</p>
                </div>
                <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                    Sell Now (via WhatsApp)
                </button>
            </form>
        </div>
    </div>

    <!-- Top-up Modal -->
    <div id="top-up-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="modal-content p-6 rounded-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Top-up</h3>
                <button id="close-top-up" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Step 1: Choose Service Type -->
            <div id="step-service-type">
                <div class="flex border-b border-gray-700 mb-4">
                    <button id="tab-airtime" class="tab-btn active flex-1 py-2 font-semibold">Airtime</button>
                    <button id="tab-data" class="tab-btn flex-1 py-2 font-semibold">Data</button>
                </div>
                <div id="top-up-alert" class="hidden"></div>
                <button id="proceed-service" class="submit-btn w-full p-4 rounded-lg font-bold text-lg" type="button">
                    Continue
                </button>
            </div>

            <!-- Step 2: Choose Network/Provider -->
            <div id="step-network" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-service" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Choose Network</h4>
                </div>
                <div id="network-cards" class="grid grid-cols-2 gap-3">
                    <!-- Network cards will be populated here -->
                </div>
            </div>

            <!-- Step 3: Choose Plan -->
            <div id="step-plan" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-network" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Choose Plan</h4>
                </div>
                <div id="plan-cards" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Plan cards will be populated here -->
                </div>
            </div>

            <!-- Step 4: Enter Phone Number -->
            <div id="step-phone" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-plan" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Enter Phone Number</h4>
                </div>
                <form id="phone-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Phone Number</label>
                        <input type="tel" id="phone-number" class="form-input w-full p-3 rounded-lg" required placeholder="Enter phone number">
                    </div>
                    <button type="submit" class="submit-btn w-full p-4 rounded-lg font-bold text-lg">
                        Continue
                    </button>
                </form>
            </div>

            <!-- Step 5: Summary & Confirm -->
            <div id="step-summary" class="hidden">
                <div class="flex items-center mb-4">
                    <button id="back-to-phone" class="text-gray-400 hover:text-gray-200 mr-2" type="button">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h4 class="text-lg font-semibold">Confirm Purchase</h4>
                </div>
                <div id="purchase-summary" class="bg-gray-800 p-4 rounded-lg space-y-3">
                    <!-- Summary will be populated here -->
                </div>
                <button id="confirm-purchase" class="submit-btn w-full p-4 rounded-lg font-bold text-lg mt-4" type="button">
                    Confirm & Pay
                </button>
            </div>
        </div>
    </div>

    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        // Define missing variables and functions
        const nigerianBanks = [
            { code: '044', name: 'Access Bank' },
            { code: '023', name: 'Citibank Nigeria' },
            { code: '035', name: 'Fidelity Bank' },
            { code: '057', name: 'Zenith Bank' },
            { code: '011', name: 'First Bank' },
            { code: '058', name: 'Guaranty Trust Bank' },
            { code: '030', name: 'Heritage Bank' },
            { code: '082', name: 'Keystone Bank' },
            { code: '076', name: 'Polaris Bank' },
            { code: '068', name: 'Standard Chartered Bank' },
            { code: '232', name: 'Sterling Bank' },
            { code: '032', name: 'Union Bank' },
            { code: '033', name: 'United Bank for Africa' },
            { code: '215', name: 'Unity Bank' },
            { code: '035', name: 'Wema Bank' },
        ];

        function showModal(content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = content;
            document.body.appendChild(modal);
            const closeBtn = modal.querySelector('.close-modal-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modal.remove());
            }
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function showModalAlert(message, type = 'error') {
            showAlert('modal-alert', message, type);
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }

        function handleSellCryptoViaWhatsApp() {
            const cryptoSelect = document.getElementById('crypto-select');
            const amountUSD = document.getElementById('crypto-amount-usd').value;
            if (!cryptoSelect.value) {
                showModalAlert('Please select a cryptocurrency.');
                return;
            }
            if (!amountUSD || parseFloat(amountUSD) <= 0) {
                showModalAlert('Please enter a valid amount.');
                return;
            }
            const phoneNumber = "2347066718413";
            const message = `Hello, I want to sell ${amountUSD} USD of ${cryptoSelect.options[cryptoSelect.selectedIndex].text} at your rate.`;
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        async function handleUserTransfer(e) {
            e.preventDefault();
            const recipientEmail = document.getElementById('transfer-email').value;
            const amount = parseFloat(document.getElementById('transfer-user-amount').value);
            if (recipientEmail === currentUserData.email) {
                showModalAlert('You cannot transfer to yourself.');
                return;
            }
            if (isNaN(amount) || amount <= 0) {
                showModalAlert('Invalid amount.');
                return;
            }
            if (amount > userWalletBalance) {
                showModalAlert('Insufficient funds.');
                return;
            }
            try {
                const response = await fetch('/api/transactions/transfer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({
                        recipient_email: recipientEmail,
                        amount: amount,
                        type: 'user'
                    })
                });
                if (response.ok) {
                    showModalAlert('Transfer successful!', 'success');
                    e.target.reset();
                    setTimeout(() => {
                        document.querySelector('.modal-content').parentElement.remove();
                        window.location.reload();
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showModalAlert(errorData.error || 'Transfer failed.');
                }
            } catch (error) {
                showModalAlert('Network error: ' + error.message);
            }
        }

        async function handleBankTransfer(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('transfer-bank-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showModalAlert('Invalid amount.');
                return;
            }
            if (amount > userWalletBalance) {
                showModalAlert('Insufficient funds.');
                return;
            }
            try {
                const response = await fetch('/api/transactions/transfer/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({
                        amount: amount,
                        type: 'bank'
                    })
                });
                if (response.ok) {
                    showModalAlert('Bank transfer initiated successfully!', 'success');
                    e.target.reset();
                    setTimeout(() => {
                        document.querySelector('.modal-content').parentElement.remove();
                        window.location.reload();
                    }, 2000);
                } else {
                    const errorData = await response.json();
                    showModalAlert(errorData.error || 'Transfer failed.');
                }
            } catch (error) {
                showModalAlert('Network error: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.getElementById('app-loader');
            const authErrorEl = document.getElementById('auth-error');
            const logoutBtn = document.getElementById('logout-btn');
            const navLinks = {
                app: document.getElementById('nav-app'),
                history: document.getElementById('nav-history'),
                rates: document.getElementById('nav-rates'),
                profile: document.getElementById('nav-profile'),
                admin: document.getElementById('nav-admin')
            };
            const bottomNav = document.querySelector('.bottom-nav');
            const chatBtn = document.getElementById('chat-btn');

            // Fix for toggleBalanceEl undefined error
            const toggleBalanceEl = document.getElementById('toggle-balance');
            const balanceEl = document.getElementById('wallet-balance');
            let balanceVisible = true;

            // Fix for auth undefined error - removed firebase auth usage since using Django
            const auth = null; // No firebase auth, Django handles authentication server-side
            const db = null; // No firebase db
            const functions = null; // No firebase functions

            // Set user data from Django
            let currentUserData = {
                username: '{{ user.username }}',
                email: '{{ user.email }}',
                walletBalance: {{ user.wallet_balance|default:0 }},
                bankDetails: {% if user.bank_details %}{{ user.bank_details|safe }}{% else %}null{% endif %},
                kycVerified: {{ user.kyc_verified|default:False|lower }},
                role: '{{ user.role|default:"user" }}',
                phone: '{{ user.phone|default:"" }}',
                country: '{{ user.country|default:"" }}',
                fullname: '{{ user.fullname|default:"" }}',
                points: {{ user.points|default:0 }}
            };
            let userWalletBalance = currentUserData.walletBalance;
            let appReady = true; // Mark as ready since data is from Django
            updateBalanceUI();

            const pages = {
                app: document.getElementById('page-app'),
                profile: document.getElementById('page-profile'),
                history: document.getElementById('page-history'),
                rates: document.getElementById('page-rates'),
                admin: document.getElementById('page-admin')
            };

            function showPage(pageId) {
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[pageId]) pages[pageId].classList.remove('hidden');

                Object.values(navLinks).forEach(link => {
                    if (!link) return;
                    link.classList.replace('text-yellow-400', 'text-gray-400');
                    const p = link.querySelector('p');
                    if (p) p.classList.replace('font-semibold', 'font-medium');
                });

                const activeLink = Object.values(navLinks).find(link => link && link.id === `nav-${pageId}`);
                if (activeLink) {
                    activeLink.classList.replace('text-gray-400', 'text-yellow-400');
                    const p = activeLink.querySelector('p');
                    if (p) p.classList.replace('font-medium', 'font-semibold');
                }

                if (pageId === 'app' || pageId === 'profile' || pageId === 'admin' || pageId === 'rates' || pageId === 'history') {
                    bottomNav.classList.remove('hidden');
                    chatBtn.classList.remove('hidden');
                } else {
                    bottomNav.classList.add('hidden');
                    chatBtn.classList.add('hidden');
                }

                loader.style.display = 'none';
            }

            if (navLinks.app) navLinks.app.addEventListener('click', (e) => { e.preventDefault(); showPage('app'); });
            if (navLinks.history) navLinks.history.addEventListener('click', (e) => { e.preventDefault(); showHistoryPage(); });
            if (navLinks.rates) navLinks.rates.addEventListener('click', (e) => { e.preventDefault(); showPage('rates'); });
            if (navLinks.profile) navLinks.profile.addEventListener('click', (e) => { e.preventDefault(); showPage('profile'); });
            if (navLinks.admin) navLinks.admin.addEventListener('click', (e) => { e.preventDefault(); showAdminPage(); });

            // Back button event listeners
            const backToAppBtn = document.getElementById('back-to-app');
            const backToAppHistoryBtn = document.getElementById('back-to-app-history');
            const backToAppRatesBtn = document.getElementById('back-to-app-rates');
            const backToAppAdminBtn = document.getElementById('back-to-app-admin');

            if (backToAppBtn) backToAppBtn.addEventListener('click', () => showPage('app'));
            if (backToAppHistoryBtn) backToAppHistoryBtn.addEventListener('click', () => showPage('app'));
            if (backToAppRatesBtn) backToAppRatesBtn.addEventListener('click', () => showPage('app'));
            if (backToAppAdminBtn) backToAppAdminBtn.addEventListener('click', () => showPage('app'));

            // Fix for unsubscribeHistory undefined error
            let unsubscribeHistory = null;

            function fetchAndDisplayTransactions() {
                if (unsubscribeHistory) {
                    unsubscribeHistory();
                    unsubscribeHistory = null;
                }
                // Fetch transactions using Django API endpoint
                const historyContainer = document.getElementById('history-container');
                historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">Loading transactions...</p>';

                fetch('/api/transactions/history/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch transactions');
                        return response.json();
                    })
                    .then(data => {
                        if (!data.length) {
                            historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">No transactions yet.</p>';
                            return;
                        }
                        historyContainer.innerHTML = '';
                        data.forEach(tx => {
                            const isDebit = tx.type === 'debit';
                            const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                            const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                            const sign = isDebit ? '-' : '+';
                            const date = new Date(tx.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                            const txItemHTML = `
                                <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <i class="fas ${iconClass}"></i>
                                        <div>
                                            <p class="font-bold">${tx.description}</p>
                                            <p class="text-xs text-gray-400">${date}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold ${amountClass}">${sign} ₦${parseFloat(tx.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                                    </div>
                                </div>
                            `;
                            historyContainer.innerHTML += txItemHTML;
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching transaction history:', error);
                        historyContainer.innerHTML = '<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>';
                    });
            }

            // Settings item event listeners
            document.querySelectorAll('#page-profile .settings-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    handleSettingsAction(action);
                });
            });

            if (chatBtn) chatBtn.addEventListener('click', showChatModalForUser);

            function showHistoryPage() {
                showPage('history');
                fetchAndDisplayTransactions();
            }

            function showAdminPage() {
                if (!appReady || currentUserData?.role !== 'admin') {
                    showError("You do not have permission to view this page.");
                    return showPage('app'); // Redirect non-admins
                }
                showPage('admin');
                loadUsersForAdmin();
                loadRatesForAdmin();
                loadActiveChats();
            }

            const addFundsModal = document.getElementById('add-funds-modal');
            const closeAddFundsBtn = document.getElementById('close-add-funds');
            const addFundsForm = document.getElementById('add-funds-form');
            
            // Show error function
            function showError(message) {
                authErrorEl.textContent = message;
                authErrorEl.classList.remove('hidden');
                setTimeout(() => { authErrorEl.classList.add('hidden'); }, 3000);
            }

            // Show success function
            function showSuccess(message) {
                authErrorEl.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                authErrorEl.textContent = message;
                setTimeout(() => {
                    authErrorEl.classList.add('hidden');
                    authErrorEl.className = 'fixed top-5 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50';
                }, 3000);
            }

            // Logout functionality
            logoutBtn.addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/users/logout/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        }
                    });

                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        showError('Logout failed');
                    }
                } catch (error) {
                    showError('Network error: ' + error.message);
                }
            });

            // Declare all modal variables first
            const withdrawModal = document.getElementById('withdraw-modal');
            const transferModal = document.getElementById('transfer-modal');
            const sellCryptoModal = document.getElementById('sell-crypto-modal');
            const topUpModal = document.getElementById('top-up-modal');

            // Now add the action item event listeners
            const actionItems = document.querySelectorAll('.action-item');
            actionItems.forEach(item => {
                item.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    if (action === 'add_funds') {
                        showAddFundsModal();
                    } else if (action === 'withdraw') {
                        withdrawModal.classList.remove('hidden');
                    } else if (action === 'transfer') {
                        transferModal.classList.remove('hidden');
                    } else if (action === 'sell_crypto') {
                        sellCryptoModal.classList.remove('hidden');
                    } else if (action === 'top_up') {
                        topUpModal.classList.remove('hidden');
                        resetTopUpFlow();
                    } else {
                        showError(`${action.replace('_', ' ')} feature coming soon!`);
                    }
                });
            });

            // Close add funds modal
            closeAddFundsBtn.addEventListener('click', function() {
                addFundsModal.classList.add('hidden');
            });

            // Add funds form submission
            addFundsForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const amount = formData.get('amount');
                
                if (amount < 100) {
                    showError('Minimum amount is ₦100');
                    return;
                }

                try {
                    // Get user email for Paystack
                    const userResponse = await fetch('/api/users/profile/', {
                        headers: {
                            'X-CSRFToken': getCSRFToken(),
                        }
                    });

                    if (!userResponse.ok) {
                        const errorData = await userResponse.json().catch(() => ({}));
                        throw new Error(errorData.error || `Failed to get user profile (${userResponse.status})`);
                    }

                    const userData = await userResponse.json();
                    const userEmail = userData.email;
                    
                    if (!userEmail) {
                        throw new Error('User email not found in profile');
                    }

                    // Initialize Paystack payment
                    const handler = PaystackPop.setup({
                        key: '{{ paystack_public_key }}', // Paystack public key from settings
                        email: userEmail,
                        amount: amount * 100, // Convert to kobo
                        currency: 'NGN',
                        ref: 'SPV_' + Date.now(), // Generate a unique reference
                        metadata: {
                            custom_fields: [
                                {
                                    display_name: "User ID",
                                    variable_name: "user_id",
                                    value: "{{ user.id }}"
                                }
                            ]
                        },
                        callback: function(response) {
                            // Payment successful
                            if (response.status === 'success') {
                                showSuccess('Payment successful! Adding funds to your wallet...');
                                
                                // Add funds to wallet - handle async operation properly
                                addFundsToWallet(amount, 'Wallet top-up via Paystack', response.reference)
                                    .then(success => {
                                        if (success) {
                                            showSuccess('Funds added to your wallet successfully!');
                                            addFundsModal.classList.add('hidden');
                                            
                                            // Refresh page to update wallet balance
                                            setTimeout(() => {
                                                window.location.reload();
                                            }, 2000);
                                        } else {
                                            showError('Payment successful but failed to add funds to wallet. Please contact support.');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error adding funds:', error);
                                        showError('Payment successful but error adding funds: ' + error.message);
                                    });
                            }
                        },
                        onClose: function() {
                            showError('Payment was cancelled');
                        }
                    });

                    handler.openIframe();

                } catch (error) {
                    console.error('Error:', error);
                    showError('Failed to initialize payment: ' + error.message);
                }
            });


            async function showAddFundsModal() {
                const modal = document.getElementById('add-funds-modal');
                const modalContent = modal.querySelector('.modal-content');

                // Show loading state
                modalContent.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                        <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl text-yellow-400 mb-4"></i>
                        <p class="text-gray-400">Loading...</p>
                    </div>
                `;

                modal.classList.remove('hidden');

                try {
                    // Check if user has virtual account
                    const response = await fetch('/api/users/virtual-account/', {
                        headers: {
                            'X-CSRFToken': getCSRFToken(),
                        }
                    });

                    let content;
                    if (response.ok) {
                        const data = await response.json();
                        // User has virtual account
                        content = `
                            <p class="text-sm text-center text-gray-400 mb-4">Transfer funds to your personal SpaceVest account below to top up your wallet.</p>
                            <div class="space-y-3 p-4 bg-gray-800 rounded-lg text-left">
                                <div><p class="text-xs text-gray-400">Bank Name</p><p class="font-semibold">${data.bank_name}</p></div>
                                <div><p class="text-xs text-gray-400">Account Number</p>
                                    <div class="flex justify-between items-center">
                                        <p class="font-semibold text-lg">${data.account_number}</p>
                                        <button id="copy-account-btn" class="text-yellow-400"><i class="fas fa-copy"></i></button>
                                    </div>
                                </div>
                                <div><p class="text-xs text-gray-400">Account Name</p><p class="font-semibold">${data.account_name}</p></div>
                            </div>
                            <div class="mt-4 text-center">
                                <p class="text-xs text-gray-400 mb-2">Account generated <span id="account-timer">just now</span></p>
                                <button id="confirm-payment-btn" class="submit-btn w-full p-3 rounded-lg font-bold">I have sent the money</button>
                            </div>
                        `;
                    } else {
                        // User doesn't have virtual account
                        content = `
                            <div class="text-center">
                                <p class="text-gray-400 mb-4">Generate a personal virtual account to add funds to your wallet.</p>
                                <button id="generate-va-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Generate Account</button>
                            </div>
                        `;
                    }

                    modalContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                            <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="add-funds-alert" class="hidden"></div>
                        ${content}
                    `;

                    // Add event listeners
                    setupAddFundsModalEvents();

                } catch (error) {
                    console.error('Error loading virtual account:', error);
                    modalContent.innerHTML = `
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Add Funds to Wallet</h3>
                            <button id="close-add-funds" class="text-gray-400 hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="text-center py-8">
                            <p class="text-red-400 mb-4">Failed to load account details. Please try again.</p>
                            <button id="retry-load-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Retry</button>
                        </div>
                    `;

                    document.getElementById('retry-load-btn').addEventListener('click', () => showAddFundsModal());
                    document.getElementById('close-add-funds').addEventListener('click', () => modal.classList.add('hidden'));
                }
            }

            function setupAddFundsModalEvents() {
                const modal = document.getElementById('add-funds-modal');
                const closeBtn = document.getElementById('close-add-funds');
                const generateBtn = document.getElementById('generate-va-btn');
                const copyBtn = document.getElementById('copy-account-btn');
                const confirmBtn = document.getElementById('confirm-payment-btn');

                // Close modal
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
                }

                // Generate virtual account
                if (generateBtn) {
                    generateBtn.addEventListener('click', handleGenerateVirtualAccount);
                }

                // Copy account number
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => {
                        const accountNumber = copyBtn.previousElementSibling.textContent;
                        navigator.clipboard.writeText(accountNumber).then(() => {
                            copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                            }, 2000);
                        });
                    });
                }

                // Confirm payment sent
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', handleConfirmPayment);
                }

                // Start timer if account exists
                if (confirmBtn) {
                    startAccountTimer();
                }
            }

            async function handleGenerateVirtualAccount() {
                const button = document.getElementById('generate-va-btn');
                const alertDiv = document.getElementById('add-funds-alert');

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                try {
                    const response = await fetch('/api/users/virtual-account/generate/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Refresh the modal to show the generated account
                        await showAddFundsModal();
                    } else {
                        alertDiv.textContent = data.error || 'Failed to generate virtual account';
                        alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                        alertDiv.classList.remove('hidden');
                        button.disabled = false;
                        button.innerHTML = 'Generate Account';
                    }
                } catch (error) {
                    alertDiv.textContent = 'Network error: ' + error.message;
                    alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                    alertDiv.classList.remove('hidden');
                    button.disabled = false;
                    button.innerHTML = 'Generate Account';
                }
            }

            async function handleConfirmPayment() {
                const button = document.getElementById('confirm-payment-btn');
                const alertDiv = document.getElementById('add-funds-alert');

                // Show amount input modal
                const amount = prompt('Enter the amount you sent (₦):');
                if (!amount) return;

                const amountFloat = parseFloat(amount);
                if (isNaN(amountFloat) || amountFloat <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                try {
                    const response = await fetch('/api/users/virtual-account/confirm-payment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({ amount: amountFloat })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alertDiv.textContent = data.message;
                        alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-green-500/20 text-green-300';
                        alertDiv.classList.remove('hidden');

                        // Refresh wallet balance
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        alertDiv.textContent = data.error || 'Failed to confirm payment';
                        alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                        alertDiv.classList.remove('hidden');
                        button.disabled = false;
                        button.innerHTML = 'I have sent the money';
                    }
                } catch (error) {
                    alertDiv.textContent = 'Network error: ' + error.message;
                    alertDiv.className = 'text-sm p-2 rounded-md my-2 bg-red-500/20 text-red-300';
                    alertDiv.classList.remove('hidden');
                    button.disabled = false;
                    button.innerHTML = 'I have sent the money';
                }
            }

            function startAccountTimer() {
                const timerElement = document.getElementById('account-timer');
                if (!timerElement) return;

                let seconds = 0;
                const updateTimer = () => {
                    seconds++;
                    if (seconds < 60) {
                        timerElement.textContent = `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
                    } else if (seconds < 3600) {
                        const minutes = Math.floor(seconds / 60);
                        timerElement.textContent = `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                    } else {
                        const hours = Math.floor(seconds / 3600);
                        timerElement.textContent = `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                    }
                };

                setInterval(updateTimer, 1000);
            }


            

            // Function to add funds to wallet
            async function addFundsToWallet(amount, description, reference) {
                try {
                    const response = await fetch('/api/transactions/add-funds/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({
                            amount: amount,
                            description: description,
                            reference: reference,
                            metadata: {
                                payment_gateway: 'paystack',
                                timestamp: new Date().toISOString()
                            }
                        })
                    });

                    if (response.ok) {
                        console.log('Funds added to wallet successfully');
                        return true;
                    } else {
                        let errorData = {};
                        try {
                            errorData = await response.json();
                            console.error('Failed to add funds:', errorData);
                        } catch (jsonError) {
                            console.error('Failed to parse error response:', jsonError);
                            // If we can't parse JSON, try to get text response
                            const errorText = await response.text();
                            throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 100)}`);
                        }
                        
                        // Provide more specific error messages
                        if (response.status === 400) {
                            throw new Error(errorData.error || 'Invalid request. Please try again.');
                        } else if (response.status === 401) {
                            throw new Error('Authentication failed. Please log in again.');
                        } else if (response.status === 403) {
                            throw new Error('Permission denied. Please contact support.');
                        } else {
                            throw new Error(errorData.error || 'Server error. Please try again later.');
                        }
                    }
                } catch (error) {
                    console.error('Error adding funds to wallet:', error);
                    throw error; // Re-throw to be caught by the caller
                }
            }

            // CSRF Token function
            function getCSRFToken() {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
                return cookieValue || '';
            }

            // Hide loader when page is loaded
            loader.style.display = 'none';

            // Show app page by default and ensure navigation is visible
            showPage('app');
            bottomNav.classList.remove('hidden');
            chatBtn.classList.remove('hidden');
            // fetchUserData(userId); // Commented out Firebase call

            // Modal management functions
            function showAlert(elementId, message, type = 'error') {
                const alertEl = document.getElementById(elementId);
                if (alertEl) {
                    alertEl.textContent = message;
                    alertEl.className = `text-sm p-2 rounded-md my-2 ${type === 'error' ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`;
                    alertEl.classList.remove('hidden');
                    setTimeout(() => { alertEl.classList.add('hidden'); }, 3000);
                }
            }

            // Withdraw modal
            const closeWithdrawBtn = document.getElementById('close-withdraw');
            const withdrawForm = document.getElementById('withdraw-form');

            closeWithdrawBtn.addEventListener('click', () => withdrawModal.classList.add('hidden'));

            withdrawForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('withdraw-amount').value);

                if (isNaN(amount) || amount <= 0) {
                    showAlert('withdraw-alert', 'Invalid amount.');
                    return;
                }

                if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                    showAlert('withdraw-alert', 'Insufficient funds.');
                    return;
                }

                try {
                    const response = await fetch('/api/transactions/withdraw/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({ amount: amount })
                    });

                    if (response.ok) {
                        showAlert('withdraw-alert', 'Withdrawal initiated successfully!', 'success');
                        withdrawForm.reset();
                        setTimeout(() => {
                            withdrawModal.classList.add('hidden');
                            window.location.reload();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        showAlert('withdraw-alert', errorData.error || 'Withdrawal failed.');
                    }
                } catch (error) {
                    showAlert('withdraw-alert', 'Network error: ' + error.message);
                }
            });

            // Transfer modal
            const closeTransferBtn = document.getElementById('close-transfer');
            const transferUserForm = document.getElementById('transfer-user-form');
            const transferBankForm = document.getElementById('transfer-bank-form');
            const tabUser = document.getElementById('tab-user');
            const tabBank = document.getElementById('tab-bank');
            const contentUser = document.getElementById('content-user');
            const contentBank = document.getElementById('content-bank');

            closeTransferBtn.addEventListener('click', () => transferModal.classList.add('hidden'));

            tabUser.addEventListener('click', () => {
                tabUser.classList.add('active');
                tabBank.classList.remove('active');
                contentUser.classList.remove('hidden');
                contentBank.classList.add('hidden');
            });

            tabBank.addEventListener('click', () => {
                tabBank.classList.add('active');
                tabUser.classList.remove('active');
                contentBank.classList.remove('hidden');
                contentUser.classList.add('hidden');
            });

            transferUserForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const recipientEmail = document.getElementById('transfer-email').value;
                const amount = parseFloat(document.getElementById('transfer-user-amount').value);

                if (recipientEmail === '{{ user.email }}') {
                    showAlert('transfer-alert', 'You cannot transfer to yourself.');
                    return;
                }

                if (isNaN(amount) || amount <= 0) {
                    showAlert('transfer-alert', 'Invalid amount.');
                    return;
                }

                if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                    showAlert('transfer-alert', 'Insufficient funds.');
                    return;
                }

                try {
                    const response = await fetch('/api/transactions/transfer/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify({
                            recipient_email: recipientEmail,
                            amount: amount,
                            type: 'user'
                        })
                    });

                    if (response.ok) {
                        showAlert('transfer-alert', 'Transfer successful!', 'success');
                        transferUserForm.reset();
                        setTimeout(() => {
                            transferModal.classList.add('hidden');
                            window.location.reload();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        showAlert('transfer-alert', errorData.error || 'Transfer failed.');
                    }
                } catch (error) {
                    showAlert('transfer-alert', 'Network error: ' + error.message);
                }
            });

            // Only add event listener if the form exists
            if (transferBankForm) {
                transferBankForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const amount = parseFloat(document.getElementById('transfer-bank-amount').value);

                    if (isNaN(amount) || amount <= 0) {
                        showAlert('transfer-alert', 'Invalid amount.');
                        return;
                    }

                    if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                        showAlert('transfer-alert', 'Insufficient funds.');
                        return;
                    }

                    try {
                        const response = await fetch('/api/transactions/transfer/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken(),
                            },
                            body: JSON.stringify({
                                amount: amount,
                                type: 'bank'
                            })
                        });

                        if (response.ok) {
                            showAlert('transfer-alert', 'Bank transfer initiated successfully!', 'success');
                            transferBankForm.reset();
                            setTimeout(() => {
                                transferModal.classList.add('hidden');
                                window.location.reload();
                            }, 2000);
                        } else {
                            const errorData = await response.json();
                            showAlert('transfer-alert', errorData.error || 'Transfer failed.');
                        }
                    } catch (error) {
                        showAlert('transfer-alert', 'Network error: ' + error.message);
                    }
                });
            }

            // Sell crypto modal
            const closeSellCryptoBtn = document.getElementById('close-sell-crypto');
            const sellCryptoForm = document.getElementById('sell-crypto-form');
            const cryptoSelect = document.getElementById('crypto-select');

            // Close sell crypto modal
            closeSellCryptoBtn.addEventListener('click', function() {
                sellCryptoModal.classList.add('hidden');
            });

            // Close top-up modal (handled in the new card-based flow section below)

           
            // closeSellCryptoBtn.addEventListener('click', () => sellCryptoModal.classList.add('hidden'));

            cryptoSelect.addEventListener('change', function() {
                const cryptoId = this.value;
                const rateDisplay = document.getElementById('admin-rate-display');
                // For now, use a default rate. In production, fetch from backend
                const rates = {
                    'bitcoin': 1520,
                    'ethereum': 1520,
                    'tether': 1520
                };
                rateDisplay.textContent = cryptoId ? `₦${rates[cryptoId] || 0}/$` : '₦0.00/$';
            });

            sellCryptoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const cryptoId = cryptoSelect.value;
                const amountUSD = document.getElementById('crypto-amount-usd').value;

                if (!cryptoId) {
                    showAlert('sell-crypto-alert', 'Please select a cryptocurrency.');
                    return;
                }

                if (!amountUSD || parseFloat(amountUSD) <= 0) {
                    showAlert('sell-crypto-alert', 'Please enter a valid amount.');
                    return;
                }

                const phoneNumber = "2347066718413"; // Replace with actual support number
                const message = `Hello, I want to sell ${amountUSD} USD of ${cryptoSelect.options[cryptoSelect.selectedIndex].text} at your rate.`;
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

                window.open(whatsappUrl, '_blank');
                sellCryptoModal.classList.add('hidden');
            });

            // Top-up modal - Card-based flow variables
            const tabAirtime = document.getElementById('tab-airtime');
            const tabData = document.getElementById('tab-data');

            // Removed old airtimeForm and dataForm event listeners as they are not used in the new card-based flow



            // Top-up modal - New card-based flow
            console.log('Initializing top-up modal elements...');
            const proceedServiceBtn = document.getElementById('proceed-service');
            const phoneForm = document.getElementById('phone-form');
            const confirmPurchaseBtn = document.getElementById('confirm-purchase');
            const closeTopUpBtn = document.getElementById('close-top-up');

            console.log('Top-up modal elements found:');
            console.log('- proceedServiceBtn:', !!proceedServiceBtn);
            console.log('- phoneForm:', !!phoneForm);
            console.log('- confirmPurchaseBtn:', !!confirmPurchaseBtn);
            console.log('- closeTopUpBtn:', !!closeTopUpBtn);

            // Step elements
            const stepServiceType = document.getElementById('step-service-type');
            const stepNetwork = document.getElementById('step-network');
            const stepPlan = document.getElementById('step-plan');
            const stepPhone = document.getElementById('step-phone');
            const stepSummary = document.getElementById('step-summary');

            console.log('Step elements found:');
            console.log('- stepServiceType:', !!stepServiceType);
            console.log('- stepNetwork:', !!stepNetwork);
            console.log('- stepPlan:', !!stepPlan);
            console.log('- stepPhone:', !!stepPhone);
            console.log('- stepSummary:', !!stepSummary);

            // Navigation buttons
            const backToServiceBtn = document.getElementById('back-to-service');
            const backToNetworkBtn = document.getElementById('back-to-network');
            const backToPlanBtn = document.getElementById('back-to-plan');
            const backToPhoneBtn = document.getElementById('back-to-phone');

            console.log('Navigation buttons found:');
            console.log('- backToServiceBtn:', !!backToServiceBtn);
            console.log('- backToNetworkBtn:', !!backToNetworkBtn);
            console.log('- backToPlanBtn:', !!backToPlanBtn);
            console.log('- backToPhoneBtn:', !!backToPhoneBtn);

            // Global variables for selected items
            let selectedServiceType = 'airtime';
            let selectedNetwork = null;
            let selectedPlan = null;
            let selectedPhone = null;

            // Helper functions (defined before use)
            function showStep(step) {
                // Hide all steps
                stepServiceType.classList.add('hidden');
                stepNetwork.classList.add('hidden');
                stepPlan.classList.add('hidden');
                stepPhone.classList.add('hidden');
                stepSummary.classList.add('hidden');

                // Show selected step
                switch(step) {
                    case 'service-type':
                        stepServiceType.classList.remove('hidden');
                        break;
                    case 'network':
                        stepNetwork.classList.remove('hidden');
                        break;
                    case 'plan':
                        stepPlan.classList.remove('hidden');
                        break;
                    case 'phone':
                        stepPhone.classList.remove('hidden');
                        break;
                    case 'summary':
                        stepSummary.classList.remove('hidden');
                        break;
                }
            }

            // Loading state management
            function showLoading(message = 'Loading...') {
                console.log('showLoading called with message:', message);
                const alertEl = document.getElementById('top-up-alert');
                console.log('Alert element found:', !!alertEl);
                if (alertEl) {
                    alertEl.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${message}`;
                    alertEl.className = 'text-sm p-2 rounded-md my-2 bg-blue-500/20 text-blue-300';
                    alertEl.classList.remove('hidden');
                    console.log('Loading state shown successfully');
                } else {
                    console.error('Alert element not found!');
                }
            }

            function hideLoading() {
                console.log('hideLoading called');
                const alertEl = document.getElementById('top-up-alert');
                if (alertEl) {
                    alertEl.classList.add('hidden');
                    alertEl.innerHTML = '';
                    console.log('Loading state hidden successfully');
                } else {
                    console.error('Alert element not found for hiding!');
                }
            }

            function disableButtons(...buttonIds) {
                console.log('disableButtons called with IDs:', buttonIds);
                buttonIds.forEach(id => {
                    const btn = document.getElementById(id);
                    console.log(`Button ${id} found:`, !!btn);
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                        console.log(`Button ${id} disabled successfully`);
                    } else {
                        console.error(`Button ${id} not found!`);
                    }
                });
            }

            function enableButtons(...buttonIds) {
                console.log('enableButtons called with IDs:', buttonIds);
                buttonIds.forEach(id => {
                    const btn = document.getElementById(id);
                    console.log(`Button ${id} found for enabling:`, !!btn);
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        console.log(`Button ${id} enabled successfully`);
                    } else {
                        console.error(`Button ${id} not found for enabling!`);
                    }
                });
            }

            function resetTopUpFlow() {
                selectedServiceType = 'airtime';
                selectedNetwork = null;
                selectedPlan = null;
                selectedPhone = null;
                showStep('service-type');
                tabAirtime.classList.add('active');
                tabData.classList.remove('active');
                document.getElementById('phone-form').reset();
            }

            closeTopUpBtn.addEventListener('click', () => {
                topUpModal.classList.add('hidden');
                resetTopUpFlow();
            });

            // Service type selection
            tabAirtime.addEventListener('click', () => {
                tabAirtime.classList.add('active');
                tabData.classList.remove('active');
                selectedServiceType = 'airtime';
                console.log('Selected service type: airtime');
            });

            tabData.addEventListener('click', () => {
                tabData.classList.add('active');
                tabAirtime.classList.remove('active');
                selectedServiceType = 'data_bundle';
                console.log('Selected service type: data_bundle');
            });

            // Proceed to network selection
            proceedServiceBtn.addEventListener('click', () => {
                console.log('Continue button clicked, selectedServiceType:', selectedServiceType);
                if (!selectedServiceType) {
                    showAlert('top-up-alert', 'Please select airtime or data first.');
                    return;
                }
                showStep('network');
                loadNetworks();
                disableButtons('proceed-service');
            });

            // Navigation
            backToServiceBtn.addEventListener('click', () => showStep('service-type'));
            backToNetworkBtn.addEventListener('click', () => showStep('network'));
            backToPlanBtn.addEventListener('click', () => showStep('plan'));
            backToPhoneBtn.addEventListener('click', () => showStep('phone'));

            // Load networks
            async function loadNetworks() {
                console.log('Loading networks for service type:', selectedServiceType);
                showLoading('Loading networks...');
                disableButtons('proceed-service', 'back-to-service');

                try {
                    const url = `/api/transactions/billers/${selectedServiceType}/`;
                    console.log('Fetching from URL:', url);

                    const response = await fetch(url, {
                        headers: { 'X-CSRFToken': getCSRFToken() }
                    });

                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('Received data:', data);

                        if (data.billers && data.billers.length > 0) {
                            displayNetworkCards(data.billers);
                            hideLoading();
                        } else {
                            console.log('No billers found in response');
                            hideLoading();
                            showAlert('top-up-alert', 'No networks found for selected service.');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.log('Error response:', errorData);
                        hideLoading();
                        showAlert('top-up-alert', errorData.error || 'Failed to load networks. Please try again later.');
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    hideLoading();
                    showAlert('top-up-alert', 'Network error: ' + error.message);
                } finally {
                    enableButtons('proceed-service', 'back-to-service');
                }
            }

            // Display network cards
            function displayNetworkCards(billers) {
                const networkCards = document.getElementById('network-cards');
                networkCards.innerHTML = '';

                billers.forEach(biller => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-center';
                    card.innerHTML = `
                        <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fas fa-mobile-alt text-blue-400"></i>
                        </div>
                        <p class="font-semibold text-sm">${biller.name}</p>
                    `;
                    card.addEventListener('click', () => {
                        selectedNetwork = biller;
                        showStep('plan');
                        loadPlans(biller.code);
                    });
                    networkCards.appendChild(card);
                });
            }

            // Load plans for selected network
            async function loadPlans(billerCode) {
                showLoading('Loading plans...');
                disableButtons('back-to-network');

                try {
                    const response = await fetch(`/api/transactions/products/${billerCode}/`, {
                        headers: { 'X-CSRFToken': getCSRFToken() }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.products && data.products.length > 0) {
                            displayPlanCards(data.products);
                            hideLoading();
                        } else {
                            // No predefined products - show amount input for airtime
                            displayAmountInput();
                            hideLoading();
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        hideLoading();
                        showAlert('top-up-alert', errorData.error || 'Failed to load plans. Please try again later.');
                    }
                } catch (error) {
                    hideLoading();
                    showAlert('top-up-alert', 'Network error: ' + error.message);
                } finally {
                    enableButtons('back-to-network');
                }
            }

            // Display plan cards
            function displayPlanCards(products) {
                const planCards = document.getElementById('plan-cards');
                planCards.innerHTML = '';

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-semibold text-sm">${product.name}</h5>
                                <p class="text-gray-400 text-xs mt-1">₦${product.amount.toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-green-400 text-xs"></i>
                                </div>
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        selectedPlan = product;
                        showStep('phone');
                    });
                    planCards.appendChild(card);
                });
            }

            // Display amount input for airtime (when no predefined products)
            function displayAmountInput() {
                const planCards = document.getElementById('plan-cards');
                planCards.innerHTML = '';

                const amountInputDiv = document.createElement('div');
                amountInputDiv.className = 'bg-gray-800 p-4 rounded-lg';
                amountInputDiv.innerHTML = `
                    <div class="text-left">
                        <label class="block text-gray-400 text-sm mb-2">Enter Amount (₦)</label>
                        <input type="number" id="custom-amount" class="form-input w-full p-3 rounded-lg" placeholder="Enter amount" min="50" max="100000" required>
                        <p class="text-xs text-gray-500 mt-2">Minimum: ₦50, Maximum: ₦100,000</p>
                    </div>
                    <button id="proceed-with-amount" class="submit-btn w-full p-4 rounded-lg font-bold text-lg mt-4" type="button">
                        Continue
                    </button>
                `;
                planCards.appendChild(amountInputDiv);

                // Add event listener for the proceed button
                document.getElementById('proceed-with-amount').addEventListener('click', () => {
                    const amount = parseFloat(document.getElementById('custom-amount').value);
                    if (isNaN(amount) || amount < 50 || amount > 100000) {
                        showAlert('top-up-alert', 'Please enter a valid amount between ₦50 and ₦100,000.');
                        return;
                    }
                    selectedPlan = {
                        code: null, // No product code for custom airtime
                        name: `₦${amount.toLocaleString()} Airtime`,
                        amount: amount,
                        isCustom: true // Flag to indicate custom amount
                    };
                    showStep('phone');
                });
            }

            // Phone form submission
            phoneForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const phone = document.getElementById('phone-number').value;

                if (!/^\d{11}$/.test(phone)) {
                    showAlert('top-up-alert', 'Invalid phone number (must be 11 digits).');
                    return;
                }

                selectedPhone = phone;
                showStep('summary');
                displaySummary();
            });

            // Display purchase summary
            function displaySummary() {
                const summaryDiv = document.getElementById('purchase-summary');
                summaryDiv.innerHTML = `
                    <div class="flex justify-between">
                        <span class="text-gray-400">Service:</span>
                        <span class="font-semibold">${selectedServiceType === 'airtime' ? 'Airtime' : 'Data'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Network:</span>
                        <span class="font-semibold">${selectedNetwork.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Plan:</span>
                        <span class="font-semibold">${selectedPlan.name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Phone:</span>
                        <span class="font-semibold">${selectedPhone}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-yellow-400 border-t border-gray-600 pt-2 mt-2">
                        <span>Total:</span>
                        <span>₦${selectedPlan.amount.toLocaleString()}</span>
                    </div>
                `;
            }

            // Confirm purchase
            console.log('Setting up confirm purchase button event listener');
            confirmPurchaseBtn.addEventListener('click', async () => {
                console.log('Confirm purchase button clicked!');
                console.log('selectedServiceType:', selectedServiceType);
                console.log('selectedNetwork:', selectedNetwork);
                console.log('selectedPlan:', selectedPlan);
                console.log('selectedPhone:', selectedPhone);

                const amount = selectedPlan.amount;
                console.log('Amount:', amount);
                console.log('Wallet balance:', '{{ user.wallet_balance|default:0 }}');

                if (amount > parseFloat('{{ user.wallet_balance|default:0 }}')) {
                    console.log('Insufficient funds detected');
                    showError('Insufficient funds.');
                    return;
                }

                // Prepare payload according to serializers in backend
                const payload = {
                    type: selectedServiceType === 'airtime' ? 'airtime' : 'data',
                    phone_number: selectedPhone,
                    network: selectedNetwork.code,
                    amount: amount
                };

                // Only add product_code if it's not null (for predefined plans)
                if (selectedPlan.code && !selectedPlan.isCustom) {
                    payload.product_code = selectedPlan.code;
                }

                // Add service-specific fields
                if (selectedServiceType === 'airtime') {
                    payload.plan_name = selectedPlan.name;
                } else {
                    payload.data_plan = selectedPlan.name;
                }

                console.log('Final payload:', payload);
                console.log('Calling showLoading function...');
                showLoading('Processing purchase...');
                console.log('Calling disableButtons function...');
                disableButtons('confirm-purchase', 'back-to-phone');

                try {
                    console.log('Making API call to /api/transactions/top-up/');
                    const response = await fetch('/api/transactions/top-up/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken(),
                        },
                        body: JSON.stringify(payload)
                    });

                    console.log('API response received:', response.status, response.ok);

                    if (response.ok) {
                        console.log('Purchase successful');
                        hideLoading();
                        showAlert('top-up-alert', `Successfully purchased ${selectedPlan.name}!`, 'success');
                        setTimeout(() => {
                            topUpModal.classList.add('hidden');
                            resetTopUpFlow();
                            window.location.reload();
                        }, 2000);
                    } else {
                        const errorData = await response.json();
                        console.log('Purchase failed with error:', errorData);
                        hideLoading();
                        showAlert('top-up-alert', errorData.error || 'Purchase failed.');
                    }
                } catch (error) {
                    console.log('Network error occurred:', error);
                    hideLoading();
                    showAlert('top-up-alert', 'Network error: ' + error.message);
                } finally {
                    console.log('Re-enabling buttons');
                    enableButtons('confirm-purchase', 'back-to-phone');
                }
            });

            // Helper functions are now defined earlier in the code


            // --- Admin & Chat Logic ---
            function showAdminPage() {
                if (!appReady || currentUserData?.role !== 'admin') {
                    showError("You do not have permission to view this page.");
                    return showPage('app'); // Redirect non-admins
                }
                showPage('admin');
                loadUsersForAdmin();
                loadRatesForAdmin();
                loadActiveChats();
            }

            function loadUsersForAdmin() {
                const userListEl = document.getElementById('user-list-admin');
                // Commented out Firebase call - using Django instead
                // onSnapshot(collection(db, "users"), (snapshot) => {
                //     userListEl.innerHTML = '';
                //     snapshot.forEach(doc => {
                //         const user = doc.data();
                //         const userEl = document.createElement('div');
                //         userEl.className = 'p-2 bg-gray-700 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600';
                //         userEl.innerHTML = `<span>${user.email}</span> <span class="text-xs">${user.role || 'user'}</span>`;
                //         userEl.onclick = () => showUserDetailsModal(user);
                //         userListEl.appendChild(userEl);
                //     });
                // });
                userListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Admin user list not available.</p>';
            }

            function showUserDetailsModal(userData) {
                const bankDetailsHTML = userData.bankDetails ? `
                    <div class="mt-4 pt-3 border-t border-gray-600">
                        <p class="text-sm text-gray-400">Bank Details</p>
                        <p>${userData.bankDetails.accountName}</p>
                        <p>${userData.bankDetails.bankName} - ${userData.bankDetails.accountNumber}</p>
                    </div>
                ` : `<p class="mt-4 pt-3 border-t border-gray-600 text-sm text-gray-400">No bank account added.</p>`;

                const modalHTML = `
                <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">User Details</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                    <div class="space-y-3 text-left">
                        <div><p class="text-sm text-gray-400">Full Name</p><p>${userData.fullname || 'N/A'}</p></div>
                        <div><p class="text-sm text-gray-400">Username</p><p>${userData.username}</p></div>
                        <div><p class="text-sm text-gray-400">Email</p><p>${userData.email}</p></div>
                        <div><p class="text-sm text-gray-400">Phone</p><p>${userData.phone}</p></div>
                        <div><p class="text-sm text-gray-400">KYC Verified</p><p>${userData.kycVerified ? 'Yes' : 'No'}</p></div>
                        ${bankDetailsHTML}
                    </div>
                </div>`;
                showModal(modalHTML);
            }

            function loadRatesForAdmin() {
                const ratesListEl = document.getElementById('rates-list-admin');
                const cryptoSelect = document.getElementById('rate-crypto-select-admin');
                const rateInput = document.getElementById('rate-ngn-admin');

                // Commented out Firebase call - using Django instead
                // onSnapshot(collection(db, "rates"), (snapshot) => {
                //     ratesListEl.innerHTML = '';
                //     snapshot.forEach(doc => {
                //         const rate = doc.data();
                //         const rateEl = document.createElement('div');
                //         rateEl.className = 'p-2 bg-gray-700 rounded-lg text-sm flex justify-between items-center cursor-pointer hover:bg-gray-600';
                //         rateEl.innerHTML = `<span>${rate.name}</span> <span>₦${rate.nairaRate}/$</span>`;
                //         rateEl.onclick = () => {
                //             cryptoSelect.value = doc.id;
                //             rateInput.value = rate.nairaRate;
                //         };
                //         ratesListEl.appendChild(rateEl);
                //     });
                // });
                ratesListEl.innerHTML = '<p class="text-gray-400 text-sm text-center">Admin rates list not available.</p>';
            }

            document.getElementById('rate-form-admin').addEventListener('submit', async (e) => {
                e.preventDefault();
                const cryptoId = document.getElementById('rate-crypto-select-admin').value;
                const nairaRate = document.getElementById('rate-ngn-admin').value;

                if (!cryptoId || !nairaRate) {
                    return showError("Please select a crypto and enter a rate.");
                }

                // Commented out Firebase call - using Django instead
                // try {
                //     const updateRateFunction = httpsCallable(functions, 'updateRate');
                //     const result = await updateRateFunction({ cryptoId, nairaRate });
                //     showError(result.data.message); // Using showError for success message as well
                //     e.target.reset();
                // } catch(error) {
                //     showError(error.message);
                // }
                showError("Rate update not available.");
            });


            function loadActiveChats() {
                // Commented out Firebase call - using Django instead
                // if (unsubscribeChats) unsubscribeChats();
                // const chatsRef = collection(db, "active_chats");
                // const q = query(chatsRef, orderBy("timestamp", "desc"));
                const container = document.getElementById('support-chats-admin');
                const adminBadge = document.getElementById('admin-notification-badge');

                // unsubscribeChats = onSnapshot(q, (snapshot) => {
                //     container.innerHTML = '';
                //     let hasUnread = false;
                //     if (snapshot.empty) {
                //         container.innerHTML = '<p class="text-gray-400 text-sm text-center">No active chats.</p>';
                //         return;
                //     }
                //     snapshot.forEach(doc => {
                //         const chat = doc.data();
                //         if(chat.unreadByAdmin) hasUnread = true;
                //         const chatEl = document.createElement('div');
                //         chatEl.className = 'p-3 bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-600 flex justify-between items-center';
                //         chatEl.innerHTML = `
                //             <div>
                //                 <p class="font-bold text-sm">${chat.userEmail}</p>
                //                 <p class="text-xs text-gray-400 truncate">${chat.lastMessage}</p>
                //             </div>
                //             ${chat.unreadByAdmin ? '<div class="w-3 h-3 bg-red-500 rounded-full"></div>' : ''}
                //         `;
                //         chatEl.onclick = () => showChatModalForUser(doc.id, chat.userEmail);
                //         container.appendChild(chatEl);
                //     });
                //     adminBadge.classList.toggle('hidden', !hasUnread);
                // });
                container.innerHTML = '<p class="text-gray-400 text-sm text-center">Active chats not available.</p>';
                adminBadge.classList.add('hidden');
            }

            function listenForChatNotifications(userId) {
                // Commented out Firebase call - using Django instead
                // const chatRef = doc(db, "active_chats", userId);
                // onSnapshot(chatRef, (doc) => {
                //     const chatNotificationBadge = document.getElementById('chat-notification-badge');
                //     if (doc.exists() && doc.data().unreadByUser) {
                //         chatNotificationBadge.classList.remove('hidden');
                //     } else {
                //         chatNotificationBadge.classList.add('hidden');
                //     }
                // });
                // For now, hide the badge
                const chatNotificationBadge = document.getElementById('chat-notification-badge');
                if (chatNotificationBadge) chatNotificationBadge.classList.add('hidden');
            }

            function showChatModalForUser(userId, userEmail) {
                // Commented out Firebase chat functionality - using Django instead
                // If called from user side, userId is an event object.
                // const isUser = typeof userId === 'object';
                // const currentUserId = isUser ? auth.currentUser.uid : userId;
                // const chatPartnerName = isUser ? "Support" : userEmail;
                // const senderId = isUser ? currentUserId : 'admin';

                const modalHTML = `
                    <div class="modal-content w-full h-full max-w-sm flex flex-col">
                        <div class="flex justify-between items-center p-4 border-b border-gray-600">
                            <h3 class="text-xl font-bold">Chat Support</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col">
            chatBtn.addEventListener('click', showChatModalForUser);

             async function changeUserPassword(e) {
                e.preventDefault();
                const newPassword = document.getElementById('change-password-input').value;
                if (newPassword.length < 6) {
                    return showModalAlert("Password must be at least 6 characters.");
                }
                try {
                    await updatePassword(auth.currentUser, newPassword);
                    showModalAlert("Password updated successfully!", "success");
                    document.getElementById('change-password-form').reset();
                } catch (error) {
                    console.error("Password change error:", error);
                    showModalAlert("Error updating password. You may need to sign in again.");
                }
            }

            async function updateSecuritySettings(settings) {
                const userDocRef = doc(db, "users", auth.currentUser.uid);
                await updateDoc(userDocRef, {
                    securitySettings: { ...currentUserData.securitySettings, ...settings }
                });
            }
            
            async function saveBankAccount() {
                if (!verifiedBankData) return;
                const button = document.getElementById('save-bank-btn-modal');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const userDocRef = doc(db, "users", auth.currentUser.uid);
                    await updateDoc(userDocRef, { bankDetails: verifiedBankData });
                    showModalAlert("Bank account saved successfully!", "success");
                    setTimeout(() => modalContainer.classList.add('hidden'), 2000);
                } catch (error) {
                    console.error("Error saving bank data:", error);
                    showModalAlert("Could not save bank details. Please try again.");
                    button.disabled = false;
                    button.innerHTML = 'Save Bank';
                }
            }


        async function verifyBankAccount(e) {
                e.preventDefault();
                const accountNumber = document.getElementById('account-number-modal').value;
                const bankCode = document.getElementById('bank-list-modal').value;
                const button = document.getElementById('verify-account-btn-modal');

                if (!accountNumber || !bankCode) {
                    return showModalAlert("Please select a bank and enter an account number.");
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

                try {
                    const resolveAccountFunction = httpsCallable(functions, 'resolveAccountNumber');
                    const result = await resolveAccountFunction({ accountNumber, bankCode });

                    if (result.data.status) {
                        verifiedBankData = {
                            accountName: result.data.data.account_name,
                            accountNumber: result.data.data.account_number,
                            bankCode: bankCode,
                            bankName: nigerianBanks.find(b => b.code === bankCode).name
                        };
                        document.getElementById('account-name-modal').textContent = verifiedBankData.accountName;
                        document.getElementById('verification-result-modal').classList.remove('hidden');
                        document.getElementById('save-bank-btn-modal').addEventListener('click', saveBankAccount);
                    } else {
                        showModalAlert(result.data.message || "Could not verify account details.");
                    }
                } catch (error) {
                    console.error("Bank Verification Error:", error);
                    showModalAlert(error.message || "An error occurred. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Verify Account';
                }
            }

             async function verifyBvn(e) {
                e.preventDefault();
                const bvn = document.getElementById('bvn-input').value;
                const button = document.getElementById('verify-bvn-btn');
                
                if (!/^\d{11}$/.test(bvn)) {
                    return showModalAlert("Please enter a valid 11-digit BVN.");
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

                try {
                    const verifyBvnFunction = httpsCallable(functions, 'verifyBvn');
                    const result = await verifyBvnFunction({ bvn: bvn });

                    if (result.data.status) {
                        verifiedBvnData = result.data.data; // The actual data is in result.data.data
                        document.getElementById('kyc-form').classList.add('hidden');
                        const detailsEl = document.getElementById('bvn-details-display');
                        detailsEl.innerHTML = `
                            <p><strong>First Name:</strong> ${verifiedBvnData.first_name}</p>
                            <p><strong>Last Name:</strong> ${verifiedBvnData.last_name}</p>
                            <p><strong>Date of Birth:</strong> ${verifiedBvnData.dob}</p>
                        `;
                        document.getElementById('kyc-verification-result').classList.remove('hidden');
                        document.getElementById('save-kyc-btn').addEventListener('click', saveKycData);
                    } else {
                        showModalAlert(result.data.message || "BVN could not be verified.");
                    }
                } catch (error) {
                    console.error("BVN Verification Error:", error);
                    showModalAlert(error.message || "An error occurred. Please try again.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Verify BVN';
                }
            }

            async function saveKycData() {
                if (!verifiedBvnData) return;
                const button = document.getElementById('save-kyc-btn');
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                try {
                    const userDocRef = doc(db, "users", auth.currentUser.uid);
                    await updateDoc(userDocRef, {
                        kycVerified: true,
                        kycDetails: verifiedBvnData
                    });
                    showModalAlert("KYC details saved successfully!", "success");
                    setTimeout(() => modalContainer.classList.add('hidden'), 2000);
                } catch (error) {
                    console.error("Error saving KYC data:", error);
                    showModalAlert("Could not save KYC data. Please try again.");
                    button.disabled = false;
                    button.innerHTML = 'Confirm & Save KYC';
                }
            }

            function populateBankList(selectElement) {
                selectElement.innerHTML = '<option value="">Select a bank</option>' + nigerianBanks.map(bank => `<option value="${bank.code}">${bank.name}</option>`).join('');
            }

            function updateBankDetailsDisplay(details, element) {
                if (details) {
                    element.innerHTML = `<div class="p-3 bg-gray-700 rounded-lg"><p class="font-bold">${details.accountName}</p><p class="text-sm">${details.bankName} - ${details.accountNumber}</p></div>`;
                } else {
                    element.innerHTML = `<p class="text-sm text-center text-gray-400">No bank account added.</p>`;
                }
            }

            // settings logic 
            function handleSettingsAction(action) {
                if (!appReady) {
                    showError("Data not loaded yet. Please wait a moment.");
                    return;
                }
                let modalHTML = '';
                switch(action) {
                    case 'personal_info':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Personal Information</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="space-y-3 text-left">
                                    <div><p class="text-sm text-gray-400">Username</p><p>${currentUserData.username}</p></div>
                                    <div><p class="text-sm text-gray-400">Email</p><p>${currentUserData.email}</p></div>
                                    <div><p class="text-sm text-gray-400">Phone</p><p>${currentUserData.phone}</p></div>
                                    <div><p class="text-sm text-gray-400">Country</p><p>${currentUserData.country}</p></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'kyc_verification':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">KYC Verification</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                ${currentUserData.kycVerified ? `<div class="text-center text-green-400"><i class="fas fa-check-circle text-4xl mb-2"></i><p>Your account is verified.</p><div class="text-left text-sm mt-4 p-3 bg-gray-800 rounded-lg space-y-1"><p><strong>Name:</strong> ${currentUserData.kycDetails.first_name} ${currentUserData.kycDetails.last_name}</p><p><strong>DOB:</strong> ${currentUserData.kycDetails.dob}</p></div></div>` : `
                                <form id="kyc-form">
                                    <div class="mb-4"><label for="bvn-input" class="block text-sm font-medium text-gray-300 mb-1">Bank Verification Number (BVN)</label><input type="number" id="bvn-input" class="form-input w-full p-3 rounded-lg" required></div>
                                    <button type="submit" id="verify-bvn-btn" class="verify-btn w-full p-3 rounded-lg font-bold">Verify BVN</button>
                                </form>
                                <div id="kyc-verification-result" class="mt-4 text-left hidden">
                                    <p class="text-green-400 font-semibold mb-2">BVN Details Found:</p><div id="bvn-details-display" class="text-sm space-y-1 p-3 bg-gray-800 rounded-lg"></div>
                                    <button id="save-kyc-btn" class="submit-btn w-full p-3 mt-4 rounded-lg font-bold">Confirm & Save KYC</button>
                                </div>`}
                            </div>`;
                        showModal(modalHTML);
                        if (!currentUserData.kycVerified) {
                            document.getElementById('kyc-form').addEventListener('submit', verifyBvn);
                        }
                        break;
                    case 'badge':
                        const points = currentUserData.points || 0;
                        const level = Math.floor(points / 100);
                        const levelName = ["Rookie", "Trader", "Pro", "Veteran", "Legend"][level] || "Legend";
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl text-center">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Badge & Level</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <i class="fas fa-medal text-6xl text-yellow-400 mb-2"></i>
                                <h4 class="text-2xl font-bold">${levelName}</h4>
                                <p class="text-gray-400">Points: ${points}</p>
                                <p class="text-xs text-gray-500 mt-4">Earn 20 points for every crypto trade to level up!</p>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'security':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Security</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                <div class="space-y-4">
                                    <form id="change-password-form" class="space-y-2"><label for="change-password-input" class="block text-sm font-medium text-gray-300">New Password</label><input type="password" id="change-password-input" class="form-input w-full p-3 rounded-lg" required><button type="submit" class="verify-btn w-full p-2 mt-1 rounded-lg font-bold text-sm">Change Password</button></form>
                                    <div class="flex justify-between items-center"><p>Login with Face/Fingerprint</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="face-id-toggle" class="sr-only peer" ${currentUserData.securitySettings?.biometricsEnabled ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                    <div class="flex justify-between items-center"><p>Show Balance on Home</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="show-balance-toggle" class="sr-only peer" ${currentUserData.securitySettings?.showBalance ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                    <div class="flex justify-between items-center"><p>2FA Authentication</p><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="2fa-toggle" class="sr-only peer" ${currentUserData.securitySettings?.twoFactorEnabled ? 'checked' : ''}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        document.getElementById('change-password-form').addEventListener('submit', changeUserPassword);
                        document.getElementById('show-balance-toggle').addEventListener('change', (e) => updateSecuritySettings({ showBalance: e.target.checked }));
                        document.getElementById('face-id-toggle').addEventListener('change', (e) => updateSecuritySettings({ biometricsEnabled: e.target.checked }));
                        document.getElementById('2fa-toggle').addEventListener('change', (e) => updateSecuritySettings({ twoFactorEnabled: e.target.checked }));
                        break;
                    case 'bank_accounts':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Bank Accounts</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div id="modal-alert" class="hidden"></div>
                                <div id="bank-details-display-modal" class="mb-4"></div>
                                <h4 class="text-lg font-semibold mb-2 border-t border-gray-600 pt-4">${currentUserData.bankDetails ? 'Update' : 'Add New'} Bank</h4>
                                <form id="bank-form-modal">
                                    <div class="mb-4"><label for="bank-list-modal" class="block text-sm font-medium text-gray-300 mb-1">Bank Name</label><select id="bank-list-modal" class="form-input w-full p-3 rounded-lg"></select></div>
                                    <div class="mb-4"><label for="account-number-modal" class="block text-sm font-medium text-gray-300 mb-1">Account Number</label><input type="number" id="account-number-modal" class="form-input w-full p-3 rounded-lg" required></div>
                                    <button type="submit" id="verify-account-btn-modal" class="verify-btn w-full p-3 rounded-lg font-bold">Verify Account</button>
                                </form>
                                <div id="verification-result-modal" class="mt-4 text-center hidden">
                                    <p id="account-name-modal" class="font-semibold text-lg text-green-400"></p>
                                    <button id="save-bank-btn-modal" class="submit-btn w-full p-3 mt-2 rounded-lg font-bold">Save Bank</button>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        populateBankList(document.getElementById('bank-list-modal'));
                        updateBankDetailsDisplay(currentUserData.bankDetails, document.getElementById('bank-details-display-modal'));
                        document.getElementById('bank-form-modal').addEventListener('submit', verifyBankAccount);
                        break;
                    case 'account_limits':
                        const tier = currentUserData.kycVerified ? 2 : 1;
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Account Limits</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="space-y-4">
                                    <div class="p-4 rounded-lg ${tier === 1 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 1 (Default)</h4><p class="text-sm">Limit: ₦50,000 per transaction</p></div>
                                    <div class="p-4 rounded-lg ${tier === 2 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 2 (BVN Verified)</h4><p class="text-sm">Limit: ₦200,000 per transaction</p></div>
                                    <div class="p-4 rounded-lg ${tier === 3 ? 'border-2 border-yellow-400' : 'opacity-50'}"><h4 class="font-bold">Tier 3 (Address Verified)</h4><p class="text-sm">Limit: ₦1,000,000 per transaction</p></div>
                                </div>
                            </div>`;
                        showModal(modalHTML);
                        break;
                    case 'preferences':
                        modalHTML = `
                            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                                <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Preferences</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                                <div class="flex justify-between items-center"><p>Theme</p><div class="flex items-center gap-2"><i class="fas fa-sun"></i><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="theme-toggle" class="sr-only peer" ${document.body.classList.contains('light-mode') ? '' : 'checked'}><div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label><i class="fas fa-moon"></i></div></div>
                            </div>`;
                        showModal(modalHTML);
                        document.getElementById('theme-toggle').addEventListener('change', toggleTheme);
                        break;
                }
            }


             async function handleBankTransfer(e) {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('transfer-bank-amount').value);
                const button = e.target.querySelector('button');
                
                if (isNaN(amount) || amount <= 0) return showModalAlert("Invalid amount.");
                if (amount > userWalletBalance) return showModalAlert("Insufficient funds.");

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                
                const recipientData = {
                    account_name: currentUserData.bankDetails.accountName,
                    account_number: currentUserData.bankDetails.accountNumber,
                    bank_code: currentUserData.bankDetails.bankCode
                };

                try {
                    const initiateWithdrawalFunction = httpsCallable(functions, 'initiateWithdrawal');
                    const result = await initiateWithdrawalFunction({ amount: amount, recipient: recipientData });

                    if (result.data.status === "success") {
                        showModalAlert(result.data.message, 'success');
                        e.target.reset();
                    } else {
                        showModalAlert(result.data.message || "Withdrawal failed.");
                    }
                } catch (error) {
                    console.error("Withdrawal Error:", error);
                    showModalAlert(error.message || "An error occurred during withdrawal.");
                } finally {
                    button.disabled = false;
                    button.innerHTML = 'Withdraw Funds';
                }
            }

            function showSellCryptoModal() {
                let options = '<option value="">Select Crypto</option>';
                for (const id in dbRates) {
                    options += `<option value="${id}">${dbRates[id].name}</option>`;
                }

                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Sell Crypto</h3><button class="close-modal-btn text-2xl">&times;</button></div>
                        <div id="modal-alert" class="hidden"></div>
                        <div id="sell-crypto-form">
                            <div class="mb-4">
                                <label for="crypto-select" class="block text-sm font-medium mb-1">Cryptocurrency</label>
                                <select id="crypto-select" class="form-input w-full p-3 rounded-lg">${options}</select>
                            </div>
                            <div class="mb-4">
                                <label for="crypto-amount-usd" class="block text-sm font-medium mb-1">Amount to Sell (USD)</label>
                                <input type="number" step="any" id="crypto-amount-usd" class="form-input w-full p-3 rounded-lg" required>
                            </div>
                            <div class="p-4 bg-gray-800 rounded-lg mb-4 text-left">
                                <p class="text-sm text-gray-400">Current Rate (Admin Set)</p>
                                <p id="admin-rate-display" class="text-xl font-bold">₦0.00 / $</p>
                            </div>
                            <button id="sell-now-btn" class="submit-btn w-full p-3 rounded-lg font-bold">Sell Now (via WhatsApp)</button>
                        </div>
                    </div>`;
                showModal(modalHTML);
                
                const cryptoSelect = document.getElementById('crypto-select');
                
                const updateAdminRate = () => {
                    const cryptoId = cryptoSelect.value;
                    const rateDisplay = document.getElementById('admin-rate-display');
                    if (cryptoId && dbRates[cryptoId]) {
                        rateDisplay.textContent = `₦${parseFloat(dbRates[cryptoId].nairaRate).toLocaleString()}/$`;
                    } else {
                        rateDisplay.textContent = 'N/A';
                    }
                };
                
                cryptoSelect.addEventListener('change', updateAdminRate);
                document.getElementById('sell-now-btn').addEventListener('click', handleSellCryptoViaWhatsApp);
                updateAdminRate(); // Initial call
            }
            
            function showTransferModal() {
                const modalHTML = `
                    <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Transfer Funds</h3>
                            <button class="close-modal-btn text-2xl">&times;</button>
                        </div>
                        <div class="flex border-b border-gray-700 mb-4">
                            <button id="tab-user" class="tab-btn active flex-1 py-2 font-semibold">SpaceVest User</button>
                            <button id="tab-bank" class="tab-btn flex-1 py-2 font-semibold">Bank Account</button>
                        </div>
                        <div id="modal-alert" class="hidden"></div>
                        
                        <!-- SpaceVest User Tab Content -->
                        <div id="content-user">
                            <form id="transfer-user-form">
                                <div class="mb-4"><label for="transfer-email" class="block text-sm font-medium mb-1">Recipient Email</label><input type="email" id="transfer-email" class="form-input w-full p-3 rounded-lg" required></div>
                                <div class="mb-4"><label for="transfer-user-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="transfer-user-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Send</button>
                            </form>
                        </div>

                        <!-- Bank Account Tab Content -->
                        <div id="content-bank" class="hidden">
                            ${!currentUserData.bankDetails ? `<p class="text-center text-yellow-400">Please add a bank account in your profile first.</p>` : `
                            <form id="transfer-bank-form">
                                <div class="mb-4"><label class="block text-sm font-medium mb-1">Recipient</label>
                                    <div class="p-3 bg-gray-700 rounded-lg">${currentUserData.bankDetails.accountName}<br><small>${currentUserData.bankDetails.bankName} - ${currentUserData.bankDetails.accountNumber}</small></div>
                                </div>
                                <div class="mb-4"><label for="transfer-bank-amount" class="block text-sm font-medium mb-1">Amount (₦)</label><input type="number" id="transfer-bank-amount" class="form-input w-full p-3 rounded-lg" required></div>
                                <button type="submit" class="submit-btn w-full p-3 rounded-lg font-bold">Withdraw Funds</button>
                            </form>`}
                        </div>
                    </div>`;
                showModal(modalHTML);
                // Tab switching logic
                const userTab = document.getElementById('tab-user'), bankTab = document.getElementById('tab-bank');
                const userContent = document.getElementById('content-user'), bankContent = document.getElementById('content-bank');
                userTab.addEventListener('click', () => {
                    userTab.classList.add('active'); bankTab.classList.remove('active');
                    userContent.classList.remove('hidden'); bankContent.classList.add('hidden');
                });
                bankTab.addEventListener('click', () => {
                    bankTab.classList.add('active'); userTab.classList.remove('active');
                    bankContent.classList.remove('hidden'); userContent.classList.add('hidden');
                });

                // Form submission logic
                document.getElementById('transfer-user-form')?.addEventListener('submit', handleUserTransfer);
                document.getElementById('transfer-bank-form')?.addEventListener('submit', handleBankTransfer);
            }

            async function addTransaction(userId, type, status, amount, description) {
                try {
                    const txRef = collection(db, "users", userId, "transactions");
                    await addDoc(txRef, { type, status, amount, description, timestamp: serverTimestamp() });
                } catch (error) {
                    console.error("Failed to add transaction:", error);
                }
            }

            // --- Transaction History Page ---
            function showHistoryPage() {
                showPage('history');
                fetchAndDisplayTransactions();
            }

            function fetchAndDisplayTransactions() {
                // Commented out Firebase call - using Django API instead
                // if (unsubscribeHistory) unsubscribeHistory(); // Unsubscribe from previous listener
                // const userId = auth.currentUser.uid;
                const historyContainer = document.getElementById('history-container');
                // const q = query(collection(db, "users", userId, "transactions"), orderBy("timestamp", "desc"));

                // unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                //     historyContainer.innerHTML = ''; // Clear previous list
                //     if (querySnapshot.empty) {
                //         historyContainer.innerHTML = `<p class="text-center text-gray-400 mt-8">No transactions yet.</p>`;
                //         return;
                //     }
                //     querySnapshot.forEach((doc) => {
                //         const tx = doc.data();
                //         const isDebit = tx.type === 'debit';
                //         const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                //         const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                //         const sign = isDebit ? '-' : '+';
                //         const date = tx.timestamp ? tx.timestamp.toDate().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'Just now';
                //
                //         const txItemHTML = `
                //             <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                //                 <div class="flex items-center gap-4">
                //                     <i class="fas ${iconClass}"></i>
                //                     <div>
                //                         <p class="font-bold">${tx.description}</p>
                //                         <p class="text-xs text-gray-400">${date}</p>
                //                     </div>
                //                 </div>
                //                 <div class="text-right">
                //                     <p class="font-semibold ${amountClass}">${sign} ₦${tx.amount.toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                //                 </div>
                //             </div>
                //         `;
                //         historyContainer.innerHTML += txItemHTML;
                //     });
                // }, (error) => {
                //     console.error("Error fetching transaction history:", error);
                //     historyContainer.innerHTML = `<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>`;
                // });

                // Use Django API for transaction history
                historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">Loading transactions...</p>';

                fetch('/api/transactions/history/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch transactions');
                        return response.json();
                    })
                    .then(data => {
                        if (!data.length) {
                            historyContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">No transactions yet.</p>';
                            return;
                        }
                        historyContainer.innerHTML = '';
                        data.forEach(tx => {
                            const isDebit = tx.type === 'debit';
                            const iconClass = isDebit ? 'fa-arrow-up-right text-red-400' : 'fa-arrow-down-left text-green-400';
                            const amountClass = isDebit ? 'text-red-400' : 'text-green-400';
                            const sign = isDebit ? '-' : '+';
                            const date = new Date(tx.timestamp).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

                            const txItemHTML = `
                                <div class="settings-item flex justify-between items-center p-4 rounded-lg">
                                    <div class="flex items-center gap-4">
                                        <i class="fas ${iconClass}"></i>
                                        <div>
                                            <p class="font-bold">${tx.description}</p>
                                            <p class="text-xs text-gray-400">${date}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold ${amountClass}">${sign} ₦${parseFloat(tx.amount).toLocaleString('en-NG', { minimumFractionDigits: 2 })}</p>
                                    </div>
                                </div>
                            `;
                            historyContainer.innerHTML += txItemHTML;
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching transaction history:', error);
                        historyContainer.innerHTML = '<p class="text-center text-red-400 mt-8">Could not load transaction history.</p>';
                    });
            }

            // --- Event Listeners ---
            toggleBalanceEl.addEventListener('click', () => {
                balanceVisible = !balanceVisible;
                updateBalanceUI();
            });

            document.querySelectorAll('.settings-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    handleSettingsAction(action);
                });
            });
            


            function updateBalanceUI() {
                if (balanceVisible) {
                    balanceEl.textContent = `₦${Number(userWalletBalance).toLocaleString('en-NG', { minimumFractionDigits: 2 })}`;
                    toggleBalanceEl.className = 'fa-regular fa-eye cursor-pointer';
                } else {
                    balanceEl.textContent = '₦ ******';
                    toggleBalanceEl.className = 'fa-regular fa-eye-slash cursor-pointer';
                }
            }
        });


        // function fetchUserData(userId) {
        //         const userDocRef = doc(db, "users", userId);
        //         unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
        //             if (docSnap.exists()) {
        //                 currentUserData = docSnap.data();
        //                 usernameHomeEl.textContent = currentUserData.username || 'user';
        //                 usernameProfileEl.textContent = currentUserData.username || 'user';
        //                 fullnameProfileEl.textContent = currentUserData.fullname || '';
        //                 userWalletBalance = currentUserData.walletBalance || 0;
        //
        //                 if (currentUserData.preferences?.theme === 'light') { document.body.classList.add('light-mode'); }
        //                 else { document.body.classList.remove('light-mode'); }
        //
        //                 balanceVisible = currentUserData.securitySettings?.showBalance ?? false;
        //                 updateBalanceUI();
        //
        //                 bankPromptEl.classList.toggle('hidden', !!currentUserData.bankDetails);
        //
        //                 const kycDone = currentUserData.kycVerified === true;
        //                 const kycStatusEl = document.getElementById('kyc-status');
        //                 const kycSubtextEl = document.getElementById('kyc-subtext');
        //                 kycStatusEl.textContent = kycDone ? "Done" : "Not Done";
        //                 kycSubtextEl.textContent = kycDone ? "Your account is verified." : "Please add your BVN details";
        //                 kycStatusEl.classList.toggle('text-green-400', kycDone);
        //                 kycStatusEl.classList.toggle('text-red-400', !kycDone);
        //
        //                 if (currentUserData.role === 'admin') {
        //                     navLinks.admin.classList.remove('hidden');
        //                 } else {
        //                     navLinks.admin.classList.add('hidden');
        //                 }
        //                 appReady = true; // Mark app as fully ready
        //             } else {
        //                 // If user doc doesn't exist, it might be a new signup.
        //                 appReady = true;
        //             }
        //         }, (error) => {
        //             console.error("Error fetching user data:", error);
        //             showError("Could not load user data. Check console for details.");
        //         });
        //
        //         fetchRates();
        //     }
            
            function fetchRates() {
                // Commented out Firebase call - using Django instead
                // const ratesColRef = collection(db, "rates");
                const ratesPageContainer = document.getElementById('rates-page-container');
                const marqueeContentEl = document.querySelector('.marquee-content');
                const ratesCardsContainer = document.getElementById('rates-container');

                // unsubscribeRates = onSnapshot(ratesColRef, (snapshot) => {
                //     if (marqueeContentEl) marqueeContentEl.innerHTML = '';
                //     ratesPageContainer.innerHTML = '';
                //     if (ratesCardsContainer) ratesCardsContainer.innerHTML = '';
                //     dbRates = {};
                //
                //     if(snapshot.empty) {
                //         const msg = `<p class="text-gray-400">Rates are not available.</p>`;
                //         ratesPageContainer.innerHTML = msg;
                //         if (ratesCardsContainer) ratesCardsContainer.innerHTML = msg;
                //         if (marqueeContentEl) marqueeContentEl.innerHTML = msg;
                //         return;
                //     }
                //     snapshot.docs.forEach(doc => dbRates[doc.id] = doc.data());
                //     const rateIds = snapshot.docs.map(doc => doc.id).join(',');
                //     if (!rateIds) return; // Prevent empty API call
                //
                //     fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${rateIds}&vs_currencies=usd`)
                //         .then(res => res.json())
                //         .then(prices => {
                //             liveCryptoRates = prices;
                //             let marqueeHTML = '';
                //             snapshot.forEach(doc => {
                //                 const rateData = doc.data();
                //                 const livePrice = prices[doc.id]?.usd || 0;
                //                 // Populate marquee
                //                 marqueeHTML += `
                //                     <div class="marquee-item text-sm">
                //                         <i class="${rateData.icon} ${rateData.iconColor} mr-2"></i>
                //                         <span class="font-bold text-gray-300">${rateData.name}:</span>
                //                         <span class="text-green-400 ml-1 font-semibold">$${livePrice.toLocaleString()}</span>
                //                         <span class="text-gray-400 mx-2">|</span>
                //                         <span class="font-bold text-gray-300">Our Rate:</span>
                //                         <span class="text-yellow-400 ml-1 font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</span>
                //                     </div>
                //                 `;
                //                 // Populate rates page
                //                 const ratePageItem = `<div class="settings-item flex justify-between items-center p-4 rounded-lg"><div class="flex items-center gap-4"><i class="${rateData.icon} text-2xl ${rateData.iconColor}"></i><div><p class="font-bold">${rateData.name}</p><p class="text-xs text-gray-400">Live Price: $${livePrice.toLocaleString()}</p></div></div><div class="text-right"><p class="font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</p><p class="text-xs text-gray-400">Our Rate</p></div></div>`;
                //                 ratesPageContainer.innerHTML += ratePageItem;
                //             });
                //             // Duplicate marquee content for smooth looping effect
                //             if (marqueeContentEl) {
                //                 marqueeContentEl.innerHTML = marqueeHTML + marqueeHTML;
                //             }
                //         }).catch(err => {
                //             console.error("CoinGecko API error:", err)
                //             const errorMsg = `<p class="text-red-400">Could not load live rates.</p>`;
                //             if (marqueeContentEl) marqueeContentEl.innerHTML = errorMsg;
                //         });
                // }, (error) => {
                //     console.error("Error fetching rates from Firestore:", error);
                //     const errorMsg = `<p class="text-red-400">Error loading rates.</p>`;
                //     ratesPageContainer.innerHTML = errorMsg;
                //     if (marqueeContentEl) marqueeContentEl.innerHTML = errorMsg;
                // });

                // Use default rates for now
                dbRates = {
                    bitcoin: { name: 'Bitcoin', nairaRate: 1520, icon: 'fab fa-bitcoin', iconColor: 'text-orange-400' },
                    ethereum: { name: 'Ethereum', nairaRate: 1520, icon: 'fab fa-ethereum', iconColor: 'text-gray-400' },
                    tether: { name: 'Tether', nairaRate: 1520, icon: 'fas fa-dollar-sign', iconColor: 'text-green-400' }
                };
                const rateIds = 'bitcoin,ethereum,tether';
                fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${rateIds}&vs_currencies=usd`)
                    .then(res => res.json())
                    .then(prices => {
                        liveCryptoRates = prices;
                        let marqueeHTML = '';
                        for (const id in dbRates) {
                            const rateData = dbRates[id];
                            const livePrice = prices[id]?.usd || 0;
                            // Populate marquee
                            marqueeHTML += `
                                <div class="marquee-item text-sm">
                                    <i class="${rateData.icon} ${rateData.iconColor} mr-2"></i>
                                    <span class="font-bold text-gray-300">${rateData.name}:</span>
                                    <span class="text-green-400 ml-1 font-semibold">$${livePrice.toLocaleString()}</span>
                                    <span class="text-gray-400 mx-2">|</span>
                                    <span class="font-bold text-gray-300">Our Rate:</span>
                                    <span class="text-yellow-400 ml-1 font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</span>
                                </div>
                            `;
                            // Populate rates page
                            const ratePageItem = `<div class="settings-item flex justify-between items-center p-4 rounded-lg"><div class="flex items-center gap-4"><i class="${rateData.icon} text-2xl ${rateData.iconColor}"></i><div><p class="font-bold">${rateData.name}</p><p class="text-xs text-gray-400">Live Price: $${livePrice.toLocaleString()}</p></div></div><div class="text-right"><p class="font-semibold">₦${parseFloat(rateData.nairaRate).toLocaleString()}/$</p><p class="text-xs text-gray-400">Our Rate</p></div></div>`;
                            ratesPageContainer.innerHTML += ratePageItem;
                        }
                        // Duplicate marquee content for smooth looping effect
                        if (marqueeContentEl) {
                            marqueeContentEl.innerHTML = marqueeHTML + marqueeHTML;
                        }
                    }).catch(err => {
                        console.error("CoinGecko API error:", err)
                        const errorMsg = `<p class="text-red-400">Could not load live rates.</p>`;
                        if (marqueeContentEl) marqueeContentEl.innerHTML = errorMsg;
                    });
            }








    </script>
</body>
</html>

